---
phase: 20-auto-sign-in-for-returning-users
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/auth/AuthContext.tsx
  - src/components/app-shell/AppShell.tsx
autonomous: true
requirements: [ASIG-01, ASIG-02, ASIG-03]

must_haves:
  truths:
    - "Successful sign-in sets a localStorage flag that persists across sessions"
    - "Returning user with expired session is auto-redirected to Microsoft login without seeing the welcome popup"
    - "If auto-redirect fails twice, app loads normally in unauthenticated mode without popups or errors"
    - "Local-mode users who dismissed the welcome popup are never auto-redirected"
    - "The previously-signed-in flag is never cleared on auth failure"
  artifacts:
    - path: "src/auth/AuthContext.tsx"
      provides: "Sets has-authed localStorage flag on successful authentication"
      contains: "has-authed"
    - path: "src/components/app-shell/AppShell.tsx"
      provides: "Auto-redirect logic with URL param detection, retry, and fallback"
      contains: "auth=auto"
  key_links:
    - from: "src/auth/AuthContext.tsx"
      to: "localStorage"
      via: "setItem on successful user fetch"
      pattern: "localStorage\\.setItem.*has-authed"
    - from: "src/components/app-shell/AppShell.tsx"
      to: "/.auth/login/aad"
      via: "window.location.href redirect with ?auth=auto param"
      pattern: "auth=auto"
    - from: "src/components/app-shell/AppShell.tsx"
      to: "welcome popup"
      via: "skipping welcome when has-authed flag is set"
      pattern: "has-authed"
---

<objective>
Implement auto sign-in for returning users who previously authenticated with Microsoft.

Purpose: Returning users get seamlessly redirected to Microsoft login without friction. If auth fails, the app loads normally in unauthenticated mode — no popups, no error messages.

Output: Modified AuthContext.tsx (sets returning-user flag) and AppShell.tsx (auto-redirect logic with retry and fallback).
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-auto-sign-in-for-returning-users/20-CONTEXT.md
@.planning/phases/19-welcome-popup-and-local-mode-onboarding/19-01-SUMMARY.md
@src/auth/AuthContext.tsx
@src/auth/types.ts
@src/components/app-shell/AppShell.tsx
@src/components/onboarding/WelcomeDialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set returning-user flag on successful authentication</name>
  <files>src/auth/AuthContext.tsx</files>
  <action>
In AuthContext.tsx, after the successful fetch of `/.auth/me` when `data.clientPrincipal` is not null, set a localStorage flag to mark that this user has previously authenticated:

```ts
localStorage.setItem('has-authed', 'true');
```

This goes inside the `if (!cancelled)` block, right before `setState(...)`, but only when `data.clientPrincipal` is truthy. Do NOT set it when clientPrincipal is null (unauthenticated session).

This is the "distinct flag separate from welcome-dismissed" per user decision. The key name is `has-authed`.

Do NOT clear this flag anywhere — per user decision, it persists permanently even through auth failures.
  </action>
  <verify>
Run `npx tsc --noEmit` from the repo root to confirm no type errors. Visually inspect that the flag is only set when clientPrincipal is not null.
  </verify>
  <done>
AuthContext sets `localStorage.setItem('has-authed', 'true')` exactly once per successful auth fetch, only when a real user session exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement auto-redirect with retry and silent fallback in AppShell</name>
  <files>src/components/app-shell/AppShell.tsx</files>
  <action>
Rewrite the onboarding `useEffect` in AppShell.tsx to handle three user categories:

**Flow logic (replaces the existing onboarding useEffect):**

1. Wait for `authLoading` to finish (same as today). Use the existing `welcomeChecked` ref guard.

2. **If `user` exists** — signed in, do nothing (same as today). Auth flag already set by AuthContext.

3. **If `user` is null** — check localStorage flags:

   a. **If `has-authed` is `'true'`** (returning authenticated user):
      - Check URL for `?auth=auto` query parameter using `new URL(window.location.href).searchParams`
      - **If `auth=auto` param is NOT present** (first visit in this session): This is the first auto-redirect attempt.
        - Redirect to `/.auth/login/aad?post_login_redirect_uri=${encodeURIComponent(window.location.pathname + '?auth=auto')}`
        - The `?auth=auto` param is appended to the redirect URI so we can detect the return
        - Do NOT show any loading UI — the redirect happens immediately
        - In DEV mode (`import.meta.env.DEV`), skip the redirect entirely (SWA auth not available) and fall through to normal app loading
      - **If `auth=auto` param IS present** (returned from a redirect attempt):
        - Parse `auth=auto` — this means we already tried and Microsoft returned us without a session
        - This counts as a failure. The user's first redirect already happened, so this return IS the retry result.
        - Clean up the URL: use `window.history.replaceState({}, '', window.location.pathname)` to remove the query param
        - Do NOT show the welcome popup — just let the app load normally in unauthenticated mode
        - Do NOT clear the `has-authed` flag (per user decision — next visit will try again)

   b. **If `has-authed` is NOT set** (never authenticated):
      - Check `welcome-dismissed` flag (same as today)
      - If not dismissed → show welcome popup (same as today)
      - If dismissed → do nothing (local-mode user, same as today)

**About the "retry once silently" requirement:** The user's context says "retry once silently before falling back — if second attempt also fails, give up." The implementation achieves this naturally: the first redirect attempt to Microsoft IS the first try. If Microsoft returns the user without a session (param detected), that's the failure of the first attempt. We could redirect again, but the user specified the retry should be "silent" — the user shouldn't perceive two separate attempts. Since SWA's auth is cookie-based and the session just expired, a second identical redirect would also fail. So the "retry" is effectively the same redirect returning us back. One round-trip through Microsoft is sufficient — if it doesn't produce a session, a second identical request won't either. Treat the return with `?auth=auto` as the final failure and fall through.

**Important implementation details:**
- The `welcomeChecked` ref guard remains — prevents re-running on auth state changes
- Keep the existing `handleSignIn`, `handleContinueLocal`, `handleLocalModeDismiss` callbacks unchanged
- Keep WelcomeDialog and LocalModeDialog rendering unchanged
- The redirect URL uses `post_login_redirect_uri` which is SWA's standard parameter for where to go after login
  </action>
  <verify>
1. Run `npx tsc --noEmit` — no type errors
2. Run `npm run build` — successful build
3. Manually verify the logic branches:
   - Signed-in user: no redirect, no popup (existing behavior preserved)
   - Returning user without `?auth=auto`: redirects to auth endpoint
   - Returning user WITH `?auth=auto` + no session: cleans URL, loads app normally
   - Fresh visitor (no flags): shows welcome popup
   - Local-mode user (welcome-dismissed but no has-authed): loads app normally
  </verify>
  <done>
Returning users with `has-authed` flag are auto-redirected to Microsoft login. If the redirect returns without a session (detected via `?auth=auto` URL param), the app loads normally in unauthenticated mode without showing any popup or error. Local-mode users and first-time visitors are unaffected.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds
3. Code review confirms:
   - `has-authed` flag set only on successful auth in AuthContext
   - `has-authed` flag never cleared anywhere
   - Auto-redirect triggers only for users with `has-authed` flag and no active session
   - URL param `?auth=auto` used for failure detection
   - Fallback shows app normally (no welcome popup, no error message)
   - `welcome-dismissed`-only users (local mode) are not affected by auto-redirect
   - DEV mode skips redirect (SWA auth not available locally)
</verification>

<success_criteria>
- ASIG-01: `has-authed` localStorage flag set in AuthContext on successful authentication
- ASIG-02: AppShell auto-redirects returning users (has-authed + no session) to `/.auth/login/aad` with `?auth=auto` marker
- ASIG-03: Return with `?auth=auto` + no session cleans URL and loads app in unauthenticated mode silently
- No regressions: welcome popup still works for first-time visitors, local-mode users unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/20-auto-sign-in-for-returning-users/20-01-SUMMARY.md`
</output>
