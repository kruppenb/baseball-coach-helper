---
phase: 19-welcome-popup-and-local-mode-onboarding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/onboarding/WelcomeDialog.tsx
  - src/components/onboarding/WelcomeDialog.module.css
  - src/components/onboarding/LocalModeDialog.tsx
  - src/components/onboarding/LocalModeDialog.module.css
  - src/components/app-shell/AppShell.tsx
autonomous: true
requirements:
  - ONBD-01
  - ONBD-02
  - ONBD-03
  - ONBD-04

must_haves:
  truths:
    - "First-time visitor sees a welcome popup with Sign in with Microsoft and Continue without signing in options"
    - "Choosing Continue without signing in shows a one-time explanation that data stays on this device and CSV import/export is in Settings"
    - "The local-mode explanation mentions the existing header link for signing in later"
    - "Returning to the app after dismissing the welcome popup does not show it again"
  artifacts:
    - path: "src/components/onboarding/WelcomeDialog.tsx"
      provides: "Welcome popup dialog with two choices"
      contains: "Sign in with Microsoft"
    - path: "src/components/onboarding/WelcomeDialog.module.css"
      provides: "Welcome dialog styling"
    - path: "src/components/onboarding/LocalModeDialog.tsx"
      provides: "Local-mode explanation dialog"
      contains: "CSV"
    - path: "src/components/onboarding/LocalModeDialog.module.css"
      provides: "Local-mode dialog styling"
    - path: "src/components/app-shell/AppShell.tsx"
      provides: "Onboarding integration"
      contains: "welcome-dismissed"
  key_links:
    - from: "src/components/app-shell/AppShell.tsx"
      to: "src/components/onboarding/WelcomeDialog.tsx"
      via: "state-controlled rendering based on localStorage flag"
      pattern: "welcome-dismissed"
    - from: "src/components/onboarding/WelcomeDialog.tsx"
      to: "/.auth/login/aad"
      via: "anchor tag href for sign-in"
      pattern: "auth/login/aad"
    - from: "src/components/app-shell/AppShell.tsx"
      to: "src/components/onboarding/LocalModeDialog.tsx"
      via: "state transition after Continue without signing in"
      pattern: "LocalModeDialog"
---

<objective>
Create the welcome popup and local-mode onboarding flow for first-time visitors.

Purpose: First-time visitors currently land on the app with no guidance about authentication options or data persistence. This plan adds a welcome dialog offering sign-in or local mode, followed by a one-time local-mode explanation for users who choose to continue without signing in.

Output: WelcomeDialog and LocalModeDialog components integrated into AppShell, controlled by a `welcome-dismissed` localStorage flag.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key existing patterns to follow:
- Dialog pattern: native HTML `<dialog>` with `showModal()` — see `src/components/game-day/NewGameDialog.tsx` and its CSS module
- Auth context: `src/auth/useAuth.ts` provides `{ user, isLoading }` — welcome popup should wait for auth loading to complete
- localStorage flag pattern: `localStorage.getItem('migration-complete')` in sync-engine.ts — same approach for `welcome-dismissed`
- CSS design tokens: all visual values via CSS custom properties from tokens.css
- Component structure: `feature/ComponentName.tsx` + `ComponentName.module.css` pairs
- Auth sign-in URL: `/.auth/login/aad` (existing in AppHeader.tsx)
- AppShell is the orchestration point for all dialogs (NewGameDialog, GameLabelDialog)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WelcomeDialog and LocalModeDialog components</name>
  <files>
    src/components/onboarding/WelcomeDialog.tsx
    src/components/onboarding/WelcomeDialog.module.css
    src/components/onboarding/LocalModeDialog.tsx
    src/components/onboarding/LocalModeDialog.module.css
  </files>
  <action>
Create two dialog components in a new `src/components/onboarding/` directory, following the native `<dialog>` + `showModal()` pattern established by NewGameDialog.

**WelcomeDialog.tsx:**
- Props: `{ open: boolean; onSignIn: () => void; onContinueLocal: () => void }`
- Uses native `<dialog>` element with `ref` + `useEffect` to call `showModal()`/`close()` based on `open` prop
- Renders a welcoming title (e.g., "Welcome to Lineup Builder") and brief subtitle (e.g., "Manage your team's batting order and field positions")
- Two action buttons:
  - Primary: "Sign in with Microsoft" — calls `onSignIn`
  - Secondary: "Continue without signing in" — calls `onContinueLocal`
- Prevent Escape from dismissing (same `cancel` event preventDefault pattern as NewGameDialog) — user must make an explicit choice
- Do NOT render when `open` is false (return null)

**WelcomeDialog.module.css:**
- Follow NewGameDialog.module.css styling conventions (border-radius, shadow, padding, backdrop)
- Center the dialog content. Buttons should stack vertically (not side-by-side) for clarity on this important choice
- Primary button uses `--color-primary` background with white text (same as `.saveBtn` pattern)
- Secondary button uses transparent background with `--color-text-muted` color and `--color-border` border (same as `.dontSaveBtn` pattern)
- Max-width: 380px for a focused dialog feel. Use `width: calc(100% - 2 * var(--space-lg))` for mobile safety
- Hide in print via `@media print { display: none }`

**LocalModeDialog.tsx:**
- Props: `{ open: boolean; onDismiss: () => void }`
- Uses native `<dialog>` element with `ref` + `useEffect` to call `showModal()`/`close()`
- Title: "Local Mode"
- Body text (use `<p>` tags) explaining:
  1. "Your data stays on this browser and device only."
  2. "You can import and export your roster as CSV in Settings."
  3. "To sign in later, use the Sign in with Microsoft link in the header."
- IMPORTANT for ONBD-04: The third point must explicitly reference the header link
- Single button: "Got it" — calls `onDismiss`
- Escape key calls `onDismiss` (this dialog is informational, not a critical choice)
- Do NOT render when `open` is false

**LocalModeDialog.module.css:**
- Same dialog styling base as WelcomeDialog (border-radius, shadow, padding, backdrop)
- Body text uses `--color-text-muted` for description paragraphs
- "Got it" button uses primary styling (--color-primary background, white text)
- Max-width: 380px, same mobile safety pattern
- Hide in print
  </action>
  <verify>
    Confirm files exist:
    - `ls src/components/onboarding/WelcomeDialog.tsx src/components/onboarding/WelcomeDialog.module.css src/components/onboarding/LocalModeDialog.tsx src/components/onboarding/LocalModeDialog.module.css`

    Confirm key content:
    - WelcomeDialog.tsx contains "Sign in with Microsoft" and "Continue without signing in"
    - LocalModeDialog.tsx contains "CSV" and "Settings" and "header"
    - Both use `<dialog>` element with `showModal()`

    Type-check passes: `npx tsc --noEmit` (from repo root)
  </verify>
  <done>
    WelcomeDialog renders a welcome popup with sign-in and continue-local buttons. LocalModeDialog renders an informational explanation about local mode that mentions CSV in Settings and the header sign-in link. Both follow established dialog patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate onboarding flow into AppShell</name>
  <files>
    src/components/app-shell/AppShell.tsx
  </files>
  <action>
Wire the WelcomeDialog and LocalModeDialog into AppShell with localStorage-based first-visit detection.

**State management in AppShell:**
- Add two boolean state variables: `showWelcome` and `showLocalMode`, both initially `false`
- Add a `useEffect` (runs once on mount, after auth loading completes) that checks:
  1. If `isLoading` is still true, do nothing (wait for auth check)
  2. If `user` is not null (already signed in), do nothing (signed-in users skip onboarding)
  3. If `localStorage.getItem('welcome-dismissed')` is `'true'`, do nothing (returning visitor)
  4. Otherwise, set `showWelcome` to `true`
- Import `useAuth` from `../../auth/useAuth` (it is already indirectly available but AppShell doesn't currently import it — add the import)

**Event handlers:**
- `handleSignIn`: Navigate to `/.auth/login/aad` via `window.location.href = '/.auth/login/aad'` (same URL as AppHeader). This avoids showing the local mode dialog and sends the user straight to Microsoft login. Set `localStorage.setItem('welcome-dismissed', 'true')` before navigating so the popup won't show if auth fails and redirects back.
- `handleContinueLocal`: Set `showWelcome` to `false`, set `showLocalMode` to `true`
- `handleLocalModeDismiss`: Set `showLocalMode` to `false`, set `localStorage.setItem('welcome-dismissed', 'true')` (ONBD-03: won't show again)

**Render integration:**
- Import WelcomeDialog and LocalModeDialog
- Add both dialogs at the bottom of the JSX return (alongside existing NewGameDialog, GameLabelDialog, Toast):
  ```
  <WelcomeDialog open={showWelcome} onSignIn={handleSignIn} onContinueLocal={handleContinueLocal} />
  <LocalModeDialog open={showLocalMode} onDismiss={handleLocalModeDismiss} />
  ```

**Important details:**
- The `useEffect` dependency array should include `isLoading` and `user` so it re-evaluates when auth finishes loading
- Only open the welcome dialog when `isLoading` becomes `false` AND `user` is `null` AND no `welcome-dismissed` flag exists
- Use a ref or state guard to ensure the effect only triggers the welcome dialog once (not on every re-render when isLoading/user change from other causes)
  </action>
  <verify>
    Type-check: `npx tsc --noEmit` (from repo root)

    Build succeeds: `npm run build`

    Manual test flow (dev server):
    1. Clear localStorage (`localStorage.removeItem('welcome-dismissed')`)
    2. Refresh the page — welcome dialog should appear
    3. Click "Continue without signing in" — local mode dialog should appear
    4. Click "Got it" — dialog closes, app is usable
    5. Refresh the page — no dialog appears (localStorage flag set)
    6. Verify `localStorage.getItem('welcome-dismissed')` returns `'true'`
  </verify>
  <done>
    First-time unauthenticated visitors see the welcome popup. Choosing "Continue without signing in" shows the local-mode explanation. After dismissal, the popup never appears again on subsequent visits. Signed-in users skip the popup entirely.
  </done>
</task>

</tasks>

<verification>
1. Type-check passes: `npx tsc --noEmit`
2. Build succeeds: `npm run build`
3. First visit (no localStorage flag, not signed in): Welcome popup appears with both options
4. "Continue without signing in" flow: Local mode explanation shows, mentions CSV/Settings and header sign-in link
5. After dismissal: `welcome-dismissed` flag is set in localStorage
6. Return visit: No popup shown
7. Signed-in user: No popup shown (auth context detects existing session)
</verification>

<success_criteria>
- ONBD-01: Welcome popup with "Sign in with Microsoft" and "Continue without signing in" options appears on first visit
- ONBD-02: Local-mode explanation dialog appears after choosing "Continue without signing in", mentions device-only data and CSV import/export in Settings
- ONBD-03: Popup does not reappear on subsequent visits (localStorage flag)
- ONBD-04: Local-mode explanation explicitly mentions the header sign-in link
- No regressions: existing app functionality unchanged, build passes, type-check passes
</success_criteria>

<output>
After completion, create `.planning/phases/19-welcome-popup-and-local-mode-onboarding/19-01-SUMMARY.md`
</output>
