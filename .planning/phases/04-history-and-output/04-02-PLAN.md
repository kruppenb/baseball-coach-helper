---
phase: 04-history-and-output
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/logic/csv.ts
  - src/logic/csv.test.ts
  - src/components/roster/RosterPage.tsx
  - src/components/roster/RosterPage.module.css
  - src/hooks/useRoster.ts
autonomous: true

must_haves:
  truths:
    - "User can export the current roster to a CSV file download"
    - "User can import a CSV file to add new players to the roster (merge, not replace)"
    - "CSV import skips duplicate names already on the roster"
    - "User sees feedback about how many players were added and skipped"
  artifacts:
    - path: "src/logic/csv.ts"
      provides: "parseRosterCsv and exportRosterCsv pure functions"
      exports: ["parseRosterCsv", "exportRosterCsv", "downloadCsv"]
    - path: "src/logic/csv.test.ts"
      provides: "Tests for CSV parsing and export"
      min_lines: 20
    - path: "src/components/roster/RosterPage.tsx"
      provides: "Import and export buttons on roster page"
      contains: "import"
    - path: "src/hooks/useRoster.ts"
      provides: "importPlayers method for bulk add"
      exports: ["useRoster"]
  key_links:
    - from: "src/components/roster/RosterPage.tsx"
      to: "src/logic/csv.ts"
      via: "import for CSV operations"
      pattern: "import.*from.*csv"
    - from: "src/components/roster/RosterPage.tsx"
      to: "src/hooks/useRoster.ts"
      via: "importPlayers from useRoster hook"
      pattern: "importPlayers"
---

<objective>
Add CSV import/export for the roster with simple pure logic functions and UI buttons.

Purpose: Coaches can share rosters between devices or pre-populate from a spreadsheet. This completes ROST-03 (import) and ROST-04 (export).
Output: CSV parsing/export logic with tests, import/export buttons on RosterPage, importPlayers method on useRoster.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-history-and-output/04-RESEARCH.md

@src/types/index.ts
@src/hooks/useRoster.ts
@src/components/roster/RosterPage.tsx
@src/components/roster/RosterPage.module.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: CSV pure logic functions with tests</name>
  <files>src/logic/csv.ts, src/logic/csv.test.ts</files>
  <action>
    Create src/logic/csv.ts with three exports:

    1. `exportRosterCsv(players: Player[]): string` - Returns CSV string with "name" header row, one player name per line. Escape fields containing commas, quotes, or newlines using CSV quoting rules (wrap in double-quotes, double any internal quotes).

    2. `parseRosterCsv(csvText: string): string[]` - Returns array of player name strings. Split by newlines (\r?\n), trim each line, skip empty lines. If the first non-empty line is "name" or "player" (case-insensitive), skip it as a header. Return remaining non-empty trimmed lines.

    3. `downloadCsv(content: string, filename: string): void` - Create a Blob with text/csv MIME type, create an object URL, create a temporary anchor element, set href and download attributes, click it, then revoke the URL. Append anchor to document.body before clicking and remove after (for Firefox compatibility).

    Create src/logic/csv.test.ts with tests:
    - exportRosterCsv with 3 players produces correct CSV with header
    - exportRosterCsv with empty roster produces just "name" header
    - exportRosterCsv escapes names containing commas
    - parseRosterCsv parses simple one-name-per-line CSV
    - parseRosterCsv skips "name" header row (case-insensitive)
    - parseRosterCsv skips "player" header row
    - parseRosterCsv handles \r\n line endings
    - parseRosterCsv skips empty lines
    - parseRosterCsv returns empty array for empty string
  </action>
  <verify>`npx vitest run src/logic/csv.test.ts` passes all tests</verify>
  <done>exportRosterCsv produces valid CSV, parseRosterCsv correctly extracts names from CSV text, all edge cases covered by tests</done>
</task>

<task type="auto">
  <name>Task 2: Import/export UI on RosterPage with useRoster.importPlayers</name>
  <files>src/hooks/useRoster.ts, src/components/roster/RosterPage.tsx, src/components/roster/RosterPage.module.css</files>
  <action>
    1. Add `importPlayers` method to useRoster hook:
       - Signature: `importPlayers(names: string[]): { added: number; skipped: number }`
       - For each name: auto-capitalize, check for duplicates against existing players (case-insensitive). If not duplicate, create new Player with crypto.randomUUID(), isPresent: true. Batch all new players into a single setPlayers call (append to existing array).
       - Return counts of added and skipped names.

    2. Update RosterPage.tsx:
       - Import `exportRosterCsv`, `downloadCsv`, `parseRosterCsv` from `../../logic/csv`.
       - Add `importPlayers` to the destructured return from useRoster.
       - Add an import/export button group below the PlayerInput and above the PlayerList:
         - "Export CSV" button: onClick calls `downloadCsv(exportRosterCsv(players), 'roster.csv')`.
         - "Import CSV" button: renders a hidden `<input type="file" accept=".csv,.txt" />`. The button's onClick triggers the hidden input's click. On file input change, read the file with FileReader (Promise-wrapped), parse with parseRosterCsv, call importPlayers, show result as a status message (e.g., "Added 3 players, skipped 2 duplicates") using local state.
       - Add a `[importStatus, setImportStatus]` state for showing import feedback. Clear it after 5 seconds with setTimeout. Display below the import/export buttons.

    3. Style the import/export buttons in RosterPage.module.css:
       - `.csvActions` container: display flex, gap var(--space-sm), margin-bottom var(--space-md).
       - `.csvButton` style: similar to existing buttons but secondary style (border instead of filled background), padding using existing token values.
       - `.importStatus` message: color var(--color-success) for positive results, font-size var(--text-sm).
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors
    - `npx vitest run` all tests pass
    - Dev server: Export button downloads a .csv file with roster names
    - Dev server: Import a CSV file with new names adds them to roster
  </verify>
  <done>Export CSV button downloads roster as CSV file. Import CSV button opens file picker, reads CSV, adds new players (skips duplicates), shows feedback message with added/skipped counts.</done>
</task>

</tasks>

<verification>
- `npx vitest run` passes all tests including csv.test.ts
- `npx tsc --noEmit` passes
- Export button on Roster tab downloads a valid CSV file
- Import of that CSV file on a fresh roster adds all players
- Import of that CSV file on existing roster shows all skipped (duplicates)
</verification>

<success_criteria>
- CSV export produces a downloadable file with "name" header and one player per row
- CSV import parses the file, adds new players via merge (not replace), skips duplicates
- User sees "Added X, skipped Y" feedback after import
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/04-history-and-output/04-02-SUMMARY.md`
</output>
