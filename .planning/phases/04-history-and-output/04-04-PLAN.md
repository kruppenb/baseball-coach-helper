---
phase: 04-history-and-output
plan: 04
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/hooks/useGameHistory.ts
  - src/components/lineup/LineupPage.tsx
  - src/components/lineup/LineupPage.module.css
  - src/components/batting-order/BattingOrderSection.tsx
  - src/components/history/HistoryPage.tsx
  - src/components/history/HistoryPage.module.css
  - src/components/app-shell/AppShell.tsx
autonomous: true

must_haves:
  truths:
    - "Coach can finalize a game with a single button that saves lineup + batting order to history"
    - "Finalize Game button is only enabled when both a lineup is selected AND a batting order exists"
    - "After finalizing, the game appears in a History tab showing per-player summary"
    - "History tab is now enabled and navigable in the tab bar"
    - "Finalizing also confirms the batting order (replaces separate confirm button)"
  artifacts:
    - path: "src/hooks/useGameHistory.ts"
      provides: "useGameHistory hook for reading/writing game history"
      exports: ["useGameHistory"]
    - path: "src/components/history/HistoryPage.tsx"
      provides: "History tab page listing past games with per-player data"
      min_lines: 30
    - path: "src/components/app-shell/AppShell.tsx"
      provides: "History tab enabled and rendering HistoryPage"
      contains: "HistoryPage"
  key_links:
    - from: "src/hooks/useGameHistory.ts"
      to: "src/logic/game-history.ts"
      via: "imports createGameHistoryEntry"
      pattern: "import.*createGameHistoryEntry.*from.*game-history"
    - from: "src/hooks/useGameHistory.ts"
      to: "src/hooks/useLocalStorage.ts"
      via: "persists history to localStorage"
      pattern: "useLocalStorage.*gameHistory"
    - from: "src/components/lineup/LineupPage.tsx"
      to: "src/hooks/useGameHistory.ts"
      via: "calls finalizeGame on button click"
      pattern: "finalizeGame"
    - from: "src/components/app-shell/AppShell.tsx"
      to: "src/components/history/HistoryPage.tsx"
      via: "renders HistoryPage for history tab"
      pattern: "HistoryPage"
---

<objective>
Create the "Finalize Game" flow that saves complete game data to localStorage history, and build the History tab to view past games.

Purpose: This is the core game-day workflow completion. The coach generates a lineup, generates a batting order, and finalizes the game -- saving everything to history for future reference and cross-game fairness. The unified "Finalize Game" replaces the separate batting order confirm to prevent desync. This completes HIST-01, HIST-02, HIST-03, HIST-04.
Output: useGameHistory hook, Finalize Game button on LineupPage, HistoryPage component, enabled History tab.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-history-and-output/04-RESEARCH.md
@.planning/phases/04-history-and-output/04-01-SUMMARY.md

@src/types/index.ts
@src/hooks/useLocalStorage.ts
@src/hooks/useBattingOrder.ts
@src/components/lineup/LineupPage.tsx
@src/components/batting-order/BattingOrderSection.tsx
@src/components/app-shell/AppShell.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: useGameHistory hook and Finalize Game flow on LineupPage</name>
  <files>src/hooks/useGameHistory.ts, src/components/lineup/LineupPage.tsx, src/components/lineup/LineupPage.module.css, src/components/batting-order/BattingOrderSection.tsx</files>
  <action>
    Create src/hooks/useGameHistory.ts:
    - Uses useLocalStorage for 'gameHistory' key with GameHistoryEntry[] default [].
    - Imports createGameHistoryEntry from '../logic/game-history'.
    - Exposes:
      - `history`: GameHistoryEntry[] (the stored history)
      - `finalizeGame(lineup, battingOrder, innings, players)`: calls createGameHistoryEntry to create the entry, appends to history via setHistory(prev => [...prev, entry]). Returns the created entry.
    - No dependency on useRoster or useLineup (receives data as arguments to keep it simple and avoid circular deps).

    Update LineupPage.tsx:
    - Import useGameHistory.
    - Import useBattingOrder (if not already imported -- currently BattingOrderSection uses it internally).
    - Get `{ finalizeGame }` from useGameHistory().
    - Get `{ currentOrder: battingOrder, isConfirmed: battingIsConfirmed, confirm: confirmBatting }` from useBattingOrder().
    - Add a "Finalize Game" button in a new section div, placed AFTER the BattingOrderSection and BEFORE the DugoutCard (if Plan 03 is already done; if not, place at the end of the lineup content).
    - The Finalize Game button:
      - Disabled when: no selectedLineup OR no battingOrder (currentOrder is null) OR game already finalized for this session.
      - On click: call confirmBatting() first (to save batting history per existing pattern), then call finalizeGame(selectedLineup, battingOrder, innings, players). Set a local `isFinalized` state to true. Show a success message "Game finalized and saved to history!"
      - Style: prominent button, green/success color, full width within its section.
    - Add `[isFinalized, setIsFinalized]` local state, reset to false when selectedLineup changes (via useEffect on selectedLineupIndex or selectedLineup reference).

    Update BattingOrderSection.tsx:
    - Remove the standalone "Confirm Order" button. The confirm action is now handled by the unified "Finalize Game" button in LineupPage.
    - Keep Generate and Clear buttons as-is.
    - Remove the "Batting order confirmed for this game" message (finalization message will be at the LineupPage level instead).
    - Keep isConfirmed accessible from useBattingOrder for read-only display if needed, but do not render a confirm button.

    Add styles to LineupPage.module.css:
    - `.finalizeButton`: background-color var(--color-success), color white, font-size var(--text-lg), padding var(--space-sm) var(--space-md), border none, border-radius var(--radius), cursor pointer, width 100%.
    - `.finalizeButton:disabled`: opacity 0.5, cursor not-allowed.
    - `.finalizedMessage`: color var(--color-success), text-align center, margin-top var(--space-sm).
  </action>
  <verify>
    - `npx tsc --noEmit` compiles
    - `npx vitest run` passes (no regressions)
    - Dev server: "Confirm Order" button no longer appears in BattingOrderSection
    - Dev server: "Finalize Game" button appears after BattingOrderSection, disabled until both lineup and batting order exist
    - Dev server: Clicking "Finalize Game" saves to localStorage (check Application > Local Storage > gameHistory)
  </verify>
  <done>Finalize Game button saves complete game data (lineup + batting order + player summaries) to localStorage history. Batting order confirm is now part of the unified finalize flow.</done>
</task>

<task type="auto">
  <name>Task 2: History tab page and AppShell integration</name>
  <files>src/components/history/HistoryPage.tsx, src/components/history/HistoryPage.module.css, src/components/app-shell/AppShell.tsx</files>
  <action>
    Create src/components/history/HistoryPage.tsx:
    - Import useGameHistory hook to read history.
    - Display a list of past games in reverse chronological order (most recent first).
    - Each game entry shows:
      - Game date formatted with toLocaleDateString()
      - Number of innings
      - Number of players
      - Expandable details (use HTML `<details>/<summary>` per established pattern from PositionBlocks):
        - Per-player summary table showing: Player Name, Batting Position (#), Fielding Positions (comma-separated), Bench Innings count.
        - Sort players by batting position (ascending).
    - Empty state: "No games recorded yet. Finalize a game on the Lineup tab to see it here."
    - Page title: "Game History" as h2.

    Create src/components/history/HistoryPage.module.css:
    - `.page`: padding using existing token values, matching other page components.
    - `.title`: matching existing page title styles (h2).
    - `.gameList`: display flex, flex-direction column, gap var(--space-md).
    - `.gameCard`: border 1px solid var(--color-border), border-radius var(--radius), padding var(--space-md).
    - `.gameHeader`: font-weight bold, margin-bottom var(--space-xs). Show date and innings count.
    - `.playerTable`: width 100%, border-collapse collapse, font-size var(--text-sm).
    - `.playerTable th, .playerTable td`: padding var(--space-xs), border-bottom 1px solid var(--color-border), text-align left.
    - `.emptyState`: text-align center, color var(--color-text-secondary), padding var(--space-xl).

    Update AppShell.tsx:
    - Import HistoryPage from '../history/HistoryPage'.
    - Change the history tab from `disabled: true` to always enabled (remove `disabled: true`).
    - Add the history tab panel rendering:
      ```
      {activeTab === 'history' && (
        <div role="tabpanel" id="panel-history" aria-labelledby="tab-history">
          <HistoryPage />
        </div>
      )}
      ```
  </action>
  <verify>
    - `npx tsc --noEmit` compiles
    - `npx vitest run` passes
    - Dev server: History tab is now enabled and clickable
    - Dev server: History tab shows "No games recorded yet" empty state initially
    - Dev server: After finalizing a game on Lineup tab, switching to History tab shows the game entry
    - Dev server: Expanding a game entry shows per-player batting position, fielding positions, and bench innings
  </verify>
  <done>History tab is enabled in AppShell, HistoryPage displays past games with per-player summaries in expandable details, empty state shown when no history exists.</done>
</task>

</tasks>

<verification>
- Finalize Game button disabled until both lineup selected AND batting order generated
- Clicking Finalize Game saves to localStorage gameHistory key
- History tab enabled and shows past games in reverse chronological order
- Each game expandable to show per-player batting position, fielding positions, bench count
- Batting order confirm button removed from BattingOrderSection (unified into Finalize)
- `npx vitest run` and `npx tsc --noEmit` pass
</verification>

<success_criteria>
- Complete game-day workflow: generate lineup -> generate batting order -> finalize game
- Game data persists in localStorage and survives page refresh
- History tab shows all past games with per-player detail
- No separate batting order confirm needed (unified into Finalize Game)
</success_criteria>

<output>
After completion, create `.planning/phases/04-history-and-output/04-04-SUMMARY.md`
</output>
