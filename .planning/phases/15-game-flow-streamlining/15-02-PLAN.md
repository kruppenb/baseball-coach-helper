---
phase: 15-game-flow-streamlining
plan: 02
type: execute
wave: 2
depends_on: [15-01]
files_modified:
  - src/components/app-shell/AppHeader.tsx
  - src/components/app-shell/AppHeader.module.css
  - src/components/game-day/NewGameDialog.tsx
  - src/components/game-day/NewGameDialog.module.css
  - src/components/game-day/GameLabelDialog.tsx
  - src/components/game-day/GameLabelDialog.module.css
  - src/components/game-day/Toast.tsx
  - src/components/game-day/Toast.module.css
  - src/components/game-day/GameDayDesktop.tsx
  - src/components/game-day/GameDayDesktop.module.css
  - src/components/game-day/GameDayStepper.tsx
  - src/components/game-day/GameDayStepper.module.css
  - src/components/game-day/steps/PrintStep.tsx
  - src/components/game-day/steps/PrintStep.module.css
  - src/components/app-shell/AppShell.tsx
autonomous: false
requirements: [GFLW-01, GFLW-02, GFLW-03]

must_haves:
  truths:
    - "Coach can tap New Game in the header from any screen and sees a confirmation dialog"
    - "New Game confirmation dialog offers Don't Save, Save & New, and Cancel — Save & New is disabled when no generated lineup exists"
    - "After confirming New Game, attendance resets to all-present, P/C clears, lineup clears, batting order clears"
    - "Tapping Print shows a game label input pre-filled with today's date, then opens browser print dialog"
    - "Printing auto-saves the game to history with a toast confirmation"
    - "Re-printing the same game updates the existing history entry instead of creating a duplicate"
  artifacts:
    - path: "src/components/game-day/NewGameDialog.tsx"
      provides: "New Game confirmation dialog with 3 options"
      min_lines: 40
    - path: "src/components/game-day/GameLabelDialog.tsx"
      provides: "Game label input before print"
      min_lines: 30
    - path: "src/components/game-day/Toast.tsx"
      provides: "Toast notification component"
      min_lines: 20
    - path: "src/components/app-shell/AppHeader.tsx"
      provides: "New Game button in header"
      contains: "New Game"
  key_links:
    - from: "src/components/app-shell/AppHeader.tsx"
      to: "src/components/game-day/NewGameDialog.tsx"
      via: "New Game button opens dialog"
      pattern: "NewGameDialog"
    - from: "src/components/game-day/GameDayDesktop.tsx"
      to: "src/hooks/useGameHistory.ts"
      via: "saveGame call on print"
      pattern: "saveGame"
    - from: "src/components/game-day/GameDayDesktop.tsx"
      to: "src/components/game-day/GameLabelDialog.tsx"
      via: "Print button opens label dialog"
      pattern: "GameLabelDialog"
---

<objective>
Build the UI for New Game action, print-as-save flow, and toast notifications across both desktop and mobile layouts.

Purpose: Completes the game flow streamlining by giving coaches a single "New Game" action in the header, a print-as-save experience with optional game label, and toast confirmation — no Finalize step anywhere.
Output: NewGameDialog, GameLabelDialog, Toast components; updated AppHeader with New Game button; updated GameDayDesktop and GameDayStepper/PrintStep with print-as-save.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-game-flow-streamlining/15-CONTEXT.md
@.planning/phases/15-game-flow-streamlining/15-01-SUMMARY.md
@src/components/app-shell/AppHeader.tsx
@src/components/app-shell/AppShell.tsx
@src/components/game-day/GameDayDesktop.tsx
@src/components/game-day/GameDayStepper.tsx
@src/components/game-day/steps/PrintStep.tsx
@src/hooks/useGameHistory.ts
@src/hooks/useLineup.ts
@src/hooks/useBattingOrder.ts
@src/hooks/useRoster.ts
@src/hooks/useStepperState.ts
@src/sync/ConflictDialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build New Game dialog and wire it to header; build print-as-save flow with game label and toast</name>
  <files>
    src/components/game-day/NewGameDialog.tsx
    src/components/game-day/NewGameDialog.module.css
    src/components/game-day/GameLabelDialog.tsx
    src/components/game-day/GameLabelDialog.module.css
    src/components/game-day/Toast.tsx
    src/components/game-day/Toast.module.css
    src/components/app-shell/AppHeader.tsx
    src/components/app-shell/AppHeader.module.css
    src/components/app-shell/AppShell.tsx
    src/components/game-day/GameDayDesktop.tsx
    src/components/game-day/GameDayDesktop.module.css
    src/components/game-day/GameDayStepper.tsx
    src/components/game-day/GameDayStepper.module.css
    src/components/game-day/steps/PrintStep.tsx
    src/components/game-day/steps/PrintStep.module.css
  </files>
  <action>
**NewGameDialog.tsx + .module.css (NEW):**
- Use native HTML `<dialog>` element (established pattern from ConflictDialog).
- Props: `open: boolean`, `hasLineup: boolean` (controls whether Save & New is enabled), `onDontSave: () => void`, `onSaveAndNew: () => void`, `onCancel: () => void`.
- Renders a dialog with title "Start New Game?", brief description "Current game data will be cleared."
- Three buttons:
  - "Don't Save" (secondary style, always enabled) — calls onDontSave
  - "Save & New" (primary style, disabled when !hasLineup) — calls onSaveAndNew. When disabled, show a small helper text "Generate a lineup first to save".
  - "Cancel" (text/link style) — calls onCancel
- Use `useRef` + `useEffect` to call `dialogRef.current.showModal()` when open=true, `close()` when false.
- Style: centered modal with backdrop, consistent with app's design tokens (card shadows, border-radius). Buttons in a row at the bottom.

**GameLabelDialog.tsx + .module.css (NEW):**
- Use native HTML `<dialog>` element.
- Props: `open: boolean`, `onConfirm: (label: string) => void`, `onCancel: () => void`.
- Renders a small dialog with title "Save & Print", an input field pre-filled with today's date in user-friendly format (e.g., "Feb 16 Game"), and two buttons: "Print" (primary) and "Cancel".
- On confirm, calls `onConfirm` with the input value, then the caller opens `window.print()`.
- Auto-focus the input field on open. Select all text so the coach can easily type over it.
- Style: compact dialog, input takes full width, buttons at bottom.

**Toast.tsx + .module.css (NEW):**
- Simple toast notification component.
- Props: `message: string`, `visible: boolean`, `onDone: () => void`.
- Renders a fixed-position element at the bottom of the screen (above the tab bar, z-index higher than tab bar).
- Animates in from bottom (CSS transition: transform + opacity).
- Auto-dismisses after 3 seconds via setTimeout, calls onDone.
- Style: dark background, white text, rounded corners, centered horizontally, ~60px from bottom.

**AppHeader.tsx + .module.css:**
- Add a "New Game" button to the header, positioned in the auth section area (left of sync/user info).
- The button is always visible per context decision. Style it as a compact outlined button that fits the header's visual language.
- The button needs to trigger a callback. Since AppHeader doesn't own game state, lift the callback up:
  - Add `onNewGame?: () => void` prop to AppHeader.
  - In AppShell.tsx, pass the callback that opens the NewGameDialog.

**AppShell.tsx:**
- Import NewGameDialog, GameLabelDialog, Toast.
- Add state: `showNewGameDialog: boolean`, `showGameLabelDialog: boolean`, `toastMessage: string`, `showToast: boolean`.
- Lift the necessary hooks here to orchestrate: useGameHistory (for saveGame, resetCurrentGame), useLineup (for resetState, selectedLineup exists check), useBattingOrder (for clear), useRoster (for resetAttendance), useStepperState (for resetStepper).
- **IMPORTANT:** These hooks are already called deeper in the component tree (GameDayDesktop, GameDayStepper, etc.). Since they use useCloudStorage which reads from the same localStorage keys, the data will stay in sync — calling setState in the parent will update localStorage, and the child's next render will read the updated value. No context provider needed; the hooks are stateless readers/writers of shared localStorage keys.
- Wire New Game flow:
  - AppHeader's onNewGame opens the dialog.
  - "Don't Save" → call resetAttendance + resetState (lineup) + clear (batting) + resetStepper + resetCurrentGame, close dialog.
  - "Save & New" → call saveGame with current lineup/batting order/players data, THEN do the same reset. Close dialog.
  - "Cancel" → close dialog.
- Wire print-as-save flow (pass callbacks down to GameDayDesktop and GameDayStepper):
  - When Print is tapped in GameDayDesktop or PrintStep, call a `handlePrintRequest` that opens GameLabelDialog.
  - On GameLabelDialog confirm: call saveGame with the label, then call `window.print()`, then show toast "Game saved to history".
  - After print dialog closes (use `window.onafterprint` or just show toast after `window.print()` returns), set toast visible.
- Pass `onPrintRequest` callback to GameDayDesktop (via prop or by moving print logic up).

**GameDayDesktop.tsx + .module.css:**
- Replace the direct `window.print()` call in handlePrint with a call to the `onPrintRequest` prop.
- Add prop: `onPrintRequest: () => void`.
- Remove the local `handlePrint` callback. The Print button now calls `onPrintRequest`.

**GameDayStepper.tsx + .module.css:**
- The mobile flow's print step needs the same print-as-save treatment.
- Add prop: `onPrintRequest: () => void` and pass it down to PrintStep.
- PrintStep currently just renders DugoutCard. Update it to include a "Print Dugout Card" button that calls `onPrintRequest` instead of the old flow.

**PrintStep.tsx + .module.css:**
- Accept `onPrint: () => void` prop.
- Add a "Print Dugout Card" button that calls `onPrint`.
- Remove the finalize-dependent logic if any remains. The step should show the DugoutCard preview and a print button.
- NOTE: PrintStep currently renders DugoutCard from the last history entry. After Plan 01's changes, the flow is: Generate lineup -> Review -> Print. The print step should render from the current lineup (from useLineup + useLineupEditor), NOT from history (which only gets populated on save). Update to render from current game state:
  - Use useLineup().selectedLineup and useBattingOrder().currentOrder for the DugoutCard.
  - If no lineup exists, show a message.

**Stale invalidation (per context decision):**
- In GameDayDesktop, if the coach modifies attendance or P/C after printing (after saveGame was called), the lineup becomes stale. The staleWarning mechanism already exists. When stale, the Print button should be disabled (lineup invalidated, must re-generate).
- This is already partially handled: staleWarning state exists. Extend canPrint to also check `!staleWarning` — if inputs changed after last generation, the lineup is stale and printing should be blocked until regeneration.
  </action>
  <verify>
Run `cd C:/repos/baseball-coach-helper && npx tsc --noEmit` to confirm no type errors.
Run `cd C:/repos/baseball-coach-helper && npx vitest run` to confirm all tests pass.
  </verify>
  <done>
- New Game button visible in header, opens confirmation dialog with 3 options.
- Save & New disabled when no lineup exists.
- Don't Save and Save & New both reset all game state (attendance to all-present, P/C cleared, lineup cleared, batting order cleared).
- Print button opens game label dialog, saves to history, opens print dialog, shows toast.
- Re-printing updates existing history entry (no duplicates).
- Stale lineup disables print until regeneration.
- All tests pass, no type errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify game flow streamlining end-to-end</name>
  <files>n/a</files>
  <action>
Human verification checkpoint. What was built: New Game action in header, print-as-save with game label and toast, no Finalize button.

How to verify:
1. Open the app at http://localhost:5180
2. **New Game (empty state):** Tap "New Game" in header. Confirm dialog appears. "Save & New" should be disabled/grayed. Tap "Cancel" — nothing changes. Tap "New Game" again, then "Don't Save" — should stay on empty state (no crash).
3. **Generate a lineup:** Mark 2 players absent. Select a pitcher and catcher. Generate a lineup.
4. **New Game with Save:** Tap "New Game". "Save & New" should now be enabled. Tap "Save & New" — game saved to history, all inputs reset (attendance all-present, P/C cleared, lineup gone, batting order gone).
5. **Print-as-save:** Generate a new lineup. Tap "Print Dugout Card". Game label dialog appears with today's date pre-filled. Modify the label to "vs Tigers". Tap "Print". Browser print dialog opens. Close print dialog. Toast shows "Game saved to history".
6. **Duplicate prevention:** Tap Print again without changing anything. Print dialog opens. Close it. History should still have just ONE entry for this game (not two).
7. **Re-print after changes:** Mark a player absent. Stale warning appears. Print button should be disabled. Regenerate lineup. Print button re-enabled. Print again — the history entry should be UPDATED (check history count stays the same, but the entry reflects the new lineup).
8. **No Finalize:** Navigate through the mobile stepper flow (resize browser narrow). Confirm there is no "Finalize Game" button in the Review step.
9. **Desktop layout:** Resize browser wide (>900px). Confirm New Game button is in header, Print button works with game label dialog and toast.
  </action>
  <verify>User confirms all 9 verification steps pass.</verify>
  <done>Type "approved" or describe issues.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx vitest run` — all existing tests pass
3. New Game button visible in AppHeader on both mobile and desktop
4. New Game dialog has 3 options, Save & New disabled without lineup
5. Print opens game label dialog, saves to history, shows toast
6. Duplicate detection works — same game printed twice = one history entry
7. No "Finalize" text anywhere in the app
8. Stale lineup disables print until regeneration
</verification>

<success_criteria>
- New Game accessible from header, works on both desktop and mobile
- Confirmation dialog with Don't Save / Save & New / Cancel
- Print-as-save with game label input and toast confirmation
- Duplicate detection: one history entry per game session
- Re-print after changes updates existing entry
- No Finalize button or step in the flow
- All tests pass, no type errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-game-flow-streamlining/15-02-SUMMARY.md`
</output>
