---
phase: 15-game-flow-streamlining
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/index.ts
  - src/logic/game-history.ts
  - src/hooks/useGameHistory.ts
  - src/hooks/useLineup.ts
  - src/hooks/useBattingOrder.ts
  - src/components/game-day/steps/ReviewStep.tsx
  - src/components/game-day/steps/ReviewStep.module.css
autonomous: true
requirements: [GFLW-02, GFLW-03, GFLW-04]

must_haves:
  truths:
    - "GameHistoryEntry supports an optional gameLabel field"
    - "saveGame function creates or updates a game history entry with duplicate detection"
    - "resetGame function clears attendance, P/C, lineup, batting order, and stepper state in one call"
    - "There is no Finalize Game button anywhere in the ReviewStep"
  artifacts:
    - path: "src/types/index.ts"
      provides: "GameHistoryEntry with gameLabel field"
      contains: "gameLabel"
    - path: "src/hooks/useGameHistory.ts"
      provides: "saveGame and resetGame orchestration"
      exports: ["useGameHistory"]
    - path: "src/logic/game-history.ts"
      provides: "createGameHistoryEntry with label and P/C metadata"
      exports: ["createGameHistoryEntry"]
  key_links:
    - from: "src/hooks/useGameHistory.ts"
      to: "src/logic/game-history.ts"
      via: "createGameHistoryEntry call"
      pattern: "createGameHistoryEntry"
---

<objective>
Add data layer support for game flow streamlining: save-with-label, duplicate detection, coordinated reset, and remove the Finalize step.

Purpose: Provides the hooks and logic that Plan 02's UI components will consume for New Game, print-as-save, and the elimination of the Finalize button.
Output: Updated types, game-history logic, useGameHistory hook with saveGame/duplicate detection, useLineup with resetState, and ReviewStep without Finalize.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-game-flow-streamlining/15-CONTEXT.md
@src/types/index.ts
@src/logic/game-history.ts
@src/hooks/useGameHistory.ts
@src/hooks/useLineup.ts
@src/hooks/useBattingOrder.ts
@src/hooks/useRoster.ts
@src/hooks/useStepperState.ts
@src/components/game-day/steps/ReviewStep.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update types and game-history logic for label and P/C metadata</name>
  <files>
    src/types/index.ts
    src/logic/game-history.ts
  </files>
  <action>
**src/types/index.ts:**
- Add optional `gameLabel?: string` field to `GameHistoryEntry` interface
- Add optional `pitcherAssignments?: Record<number, string>` field to `GameHistoryEntry` (for saved P/C metadata per context decision)
- Add optional `catcherAssignments?: Record<number, string>` field to `GameHistoryEntry`
- Add optional `playerCount?: number` field to `GameHistoryEntry`

**src/logic/game-history.ts:**
- Update `createGameHistoryEntry` signature to accept an optional `options` parameter: `{ gameLabel?: string; pitcherAssignments?: Record<number, string>; catcherAssignments?: Record<number, string> }`
- Inside the function, include `gameLabel`, `pitcherAssignments`, `catcherAssignments`, and computed `playerCount` (count of present players) in the returned entry
- Keep backward compatibility: existing callers without options still work
  </action>
  <verify>Run `cd C:/repos/baseball-coach-helper && npx tsc --noEmit` to confirm no type errors.</verify>
  <done>GameHistoryEntry has gameLabel, pitcherAssignments, catcherAssignments, and playerCount fields. createGameHistoryEntry accepts optional label and P/C assignments.</done>
</task>

<task type="auto">
  <name>Task 2: Add saveGame with dupe detection, resetGame orchestration, and remove Finalize</name>
  <files>
    src/hooks/useGameHistory.ts
    src/hooks/useLineup.ts
    src/hooks/useBattingOrder.ts
    src/components/game-day/steps/ReviewStep.tsx
    src/components/game-day/steps/ReviewStep.module.css
  </files>
  <action>
**src/hooks/useGameHistory.ts:**
- Add a `currentGameId` ref (useRef<string | null>(null)) to track the active game session for duplicate detection. This ref gets set when a game is saved and cleared on reset.
- Add `saveGame` function that:
  1. Accepts `(lineup, battingOrder, innings, players, options: { gameLabel?, pitcherAssignments?, catcherAssignments? })`
  2. If `currentGameId.current` is set, find the existing entry with that id and **update** it (overwrite in the history array). This handles the "re-print after changes" case per context decision: "Re-printing after changes overwrites the existing history entry for this game."
  3. If `currentGameId.current` is null, create a new entry via `createGameHistoryEntry` with options, set `currentGameId.current = entry.id`, and append to history.
  4. Returns the saved entry.
- Add `resetCurrentGame` function that sets `currentGameId.current = null` (called when starting a new game).
- Keep `finalizeGame` for backward compatibility but it should internally call `saveGame` (or just keep both — the old `finalizeGame` is called from ReviewStep which we're modifying anyway).

**src/hooks/useLineup.ts:**
- Add a `resetState` function that resets lineupState to `defaultState` (clears pitcher/catcher assignments, generated lineups, selected index). This calls `setState(defaultState)`.
- Export `resetState` from the hook return.

**src/hooks/useBattingOrder.ts:**
- The `clear` function already exists and resets to `defaultState`. No changes needed, just confirm it's exported (it is).

**src/components/game-day/steps/ReviewStep.tsx:**
- Remove the `handleFinalize` function entirely.
- Remove the `isFinalized` state variable.
- Remove the "Finalize Game" button JSX and the "Game Finalized" message.
- Remove the `disabled={!isFinalized}` constraint on the Next button. The Next button should be enabled whenever a batting order exists (`disabled={!editor.battingOrder}`).
- Keep all other ReviewStep functionality (lineup display, regenerate, DnD, batting order, previous batting order comparison).

**src/components/game-day/steps/ReviewStep.module.css:**
- Remove `.finalizeButton` and `.finalizedMessage` CSS classes if they exist.
  </action>
  <verify>
Run `cd C:/repos/baseball-coach-helper && npx tsc --noEmit` to confirm no type errors.
Run `cd C:/repos/baseball-coach-helper && npx vitest run` to confirm all tests pass.
Visually confirm ReviewStep.tsx has no "Finalize" text by grepping: `grep -i finalize src/components/game-day/steps/ReviewStep.tsx` should return nothing.
  </verify>
  <done>
- useGameHistory exports saveGame (with dupe detection via currentGameId ref) and resetCurrentGame.
- useLineup exports resetState.
- ReviewStep has no Finalize button — Next is enabled when batting order exists.
- All existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx vitest run` — all existing tests pass
3. `grep -ri "finalize" src/components/game-day/steps/ReviewStep.tsx` returns no matches
4. GameHistoryEntry type includes gameLabel, pitcherAssignments, catcherAssignments, playerCount
5. useGameHistory returns saveGame and resetCurrentGame functions
6. useLineup returns resetState function
</verification>

<success_criteria>
- GameHistoryEntry extended with gameLabel and P/C metadata fields
- saveGame creates new entries or updates existing ones (duplicate detection via currentGameId ref)
- resetState on useLineup clears all lineup state to defaults
- ReviewStep has zero references to "finalize" — Next button enabled when batting order exists
- All tests pass, no type errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-game-flow-streamlining/15-01-SUMMARY.md`
</output>
