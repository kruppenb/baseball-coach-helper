---
phase: 10-app-restructuring-and-game-day-flow
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/logic/game-history.ts
  - src/components/game-day/GameDayStepper.tsx
  - src/components/game-day/GameDayStepper.module.css
  - src/components/game-day/StepperHeader.tsx
  - src/components/game-day/StepperHeader.module.css
  - src/components/game-day/steps/AttendanceStep.tsx
  - src/components/game-day/steps/AttendanceStep.module.css
  - src/components/game-day/steps/PCAssignmentStep.tsx
  - src/components/game-day/steps/PCAssignmentStep.module.css
  - src/components/app-shell/AppShell.tsx
autonomous: true

must_haves:
  truths:
    - "Game Day tab shows a stepper with step indicators showing progress"
    - "Attendance step displays all players with toggle to mark present/absent"
    - "Absent players are visually greyed out"
    - "P/C Assignment step shows two dropdowns (Pitcher, Catcher) populated only with present players"
    - "P/C Assignment step shows last 2 games pitcher and catcher history in a separate column"
    - "Pitcher who pitched last 2 consecutive games shows a warning icon"
    - "Pitcher assignment required to advance; Catcher optional"
    - "Coach must complete Attendance before P/C Assignment on first pass"
    - "Stale warning shown when going back to change attendance after generating"
  artifacts:
    - path: "src/logic/game-history.ts"
      provides: "computeRecentPCHistory function"
      contains: "computeRecentPCHistory"
    - path: "src/components/game-day/GameDayStepper.tsx"
      provides: "Stepper container component"
      exports: ["GameDayStepper"]
    - path: "src/components/game-day/StepperHeader.tsx"
      provides: "Step progress indicator"
      exports: ["StepperHeader"]
    - path: "src/components/game-day/steps/AttendanceStep.tsx"
      provides: "Attendance marking step"
      exports: ["AttendanceStep"]
    - path: "src/components/game-day/steps/PCAssignmentStep.tsx"
      provides: "Pitcher/Catcher assignment step"
      exports: ["PCAssignmentStep"]
  key_links:
    - from: "src/components/game-day/GameDayStepper.tsx"
      to: "src/hooks/useStepperState.ts"
      via: "hook consumption"
      pattern: "useStepperState"
    - from: "src/components/game-day/steps/PCAssignmentStep.tsx"
      to: "src/logic/game-history.ts"
      via: "computeRecentPCHistory call"
      pattern: "computeRecentPCHistory"
    - from: "src/components/app-shell/AppShell.tsx"
      to: "src/components/game-day/GameDayStepper.tsx"
      via: "conditional render on game-day tab"
      pattern: "GameDayStepper"
---

<objective>
Build the Game Day stepper container with step indicators, the Attendance step, and the P/C Assignment step with pitcher/catcher history from the last 2 games.

Purpose: The coach lands on Game Day and progresses through Attendance (marking who's here) then P/C Assignment (picking pitcher and catcher with history context). This covers FLOW-01, FLOW-02, FLOW-03, FLOW-04.
Output: Functional first two steps of the stepper, wired into the app shell.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-app-restructuring-and-game-day-flow/10-CONTEXT.md
@.planning/phases/10-app-restructuring-and-game-day-flow/10-RESEARCH.md
@.planning/phases/10-app-restructuring-and-game-day-flow/10-01-SUMMARY.md
@src/hooks/useStepperState.ts
@src/types/index.ts
@src/hooks/useRoster.ts
@src/hooks/useLineup.ts
@src/hooks/useGameHistory.ts
@src/logic/game-history.ts
@src/components/game-setup/AttendanceList.tsx
@src/components/game-setup/PlayerAttendance.tsx
@src/components/lineup/PreAssignments.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GameDayStepper container, StepperHeader, and AttendanceStep</name>
  <files>
    src/components/game-day/GameDayStepper.tsx
    src/components/game-day/GameDayStepper.module.css
    src/components/game-day/StepperHeader.tsx
    src/components/game-day/StepperHeader.module.css
    src/components/game-day/steps/AttendanceStep.tsx
    src/components/game-day/steps/AttendanceStep.module.css
    src/components/app-shell/AppShell.tsx
  </files>
  <action>
**1. Create `src/components/game-day/StepperHeader.tsx`:**

A horizontal progress bar showing all 5 steps. Each step displays:
- Step number (1-5)
- Short label: "Attendance", "P/C", "Generate", "Review", "Print"
- Visual states: completed (checkmark icon or filled circle), current (highlighted/bold), upcoming (dimmed), accessible (clickable if canNavigate is true)

Props:
```typescript
interface StepperHeaderProps {
  currentStep: StepId;
  completedSteps: Set<StepId>;
  canNavigate: (step: StepId) => boolean;
  onStepClick: (step: StepId) => void;
}
```

Use a horizontal flex row. Each step is a button (for accessibility). Clicking calls onStepClick. Disabled if !canNavigate(step). Steps connected by a line/bar between them. Keep it compact -- this is used on a phone on the field.

Step labels (short for mobile): "Attend", "P/C", "Generate", "Review", "Print"

**2. Create `src/components/game-day/StepperHeader.module.css`:**

Horizontal stepper bar:
- `.header` — flex row, justify-content: space-between, padding, gap
- `.step` — flex column, align-items center, cursor pointer, min tap size
- `.step.active` — color: var(--color-primary), font-weight: 700
- `.step.completed` — color: var(--color-success)
- `.step.disabled` — opacity: 0.4, cursor: not-allowed
- `.stepNumber` — width: 28px, height: 28px, border-radius: 50%, border, display flex, align-items center, justify-content center, font-size small
- `.stepNumber.active` — background: var(--color-primary), color: white, border-color: var(--color-primary)
- `.stepNumber.completed` — background: var(--color-success), color: white, border-color: var(--color-success)
- `.stepLabel` — font-size: var(--font-size-sm), margin-top: 2px
- `.connector` — flex: 1, height: 2px, background: var(--color-border), align-self: center (between step circles)

**3. Create `src/components/game-day/steps/AttendanceStep.tsx`:**

Reuses the existing `AttendanceList` and `PlayerAttendance` components. Wraps them with step-specific UI:

```tsx
import { useRoster } from '../../../hooks/useRoster';
import { AttendanceList } from '../../game-setup/AttendanceList';
```

Props:
```typescript
interface AttendanceStepProps {
  onComplete: () => void;  // Called when coach advances
}
```

Renders:
- A heading: "Mark Attendance"
- A brief instruction: "Tap players to mark them present or absent"
- The existing `<AttendanceList>` component with players and onToggle from `useRoster()`
- A "Next" button at the bottom. The button is enabled when at least 9 players are present (same minimum as lineup generation). Show present count: "X of Y present". If < 9, show message: "Need at least 9 present players to continue."
- Clicking "Next" calls `onComplete()`

Absent players are already styled with greyed-out treatment via existing PlayerAttendance component (.absent class with opacity 0.45 and strikethrough) -- no changes needed there.

**4. Create `src/components/game-day/GameDayStepper.tsx`:**

The main container for the stepper flow:

```tsx
import { useStepperState } from '../../hooks/useStepperState';
import { StepperHeader } from './StepperHeader';
import { AttendanceStep } from './steps/AttendanceStep';
```

Uses `useStepperState()` hook. Renders:
- `<StepperHeader>` at top
- A stale warning banner if `staleWarning` is true: "Attendance changed after lineup was generated. Consider regenerating." with a dismiss button (calls clearStaleWarning)
- Conditional step rendering based on `currentStep`:
  - `'attendance'` -> `<AttendanceStep onComplete={() => completeStep('attendance')} />`
  - `'pc-assignment'` -> placeholder `<div>P/C Assignment (Task 2)</div>`
  - `'generate'` -> placeholder
  - `'review'` -> placeholder
  - `'print'` -> placeholder

The stale warning logic: when `goToStep` is called to go backward to 'attendance' and the 'generate' step is already completed, set staleWarning to true. This is handled inside the useStepperState hook.

**5. Update `src/components/app-shell/AppShell.tsx`:**

Replace the Game Day placeholder from Plan 01 with `<GameDayStepper />`:
```tsx
import { GameDayStepper } from '../game-day/GameDayStepper';
```

In the conditional render:
```tsx
{activeTab === 'game-day' && (
  <div role="tabpanel" id="panel-game-day" aria-labelledby="tab-game-day">
    <GameDayStepper />
  </div>
)}
```
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Open app:
1. Game Day tab shows stepper header with 5 steps
2. Attendance step renders with player list
3. Can toggle players present/absent
4. "Next" button enabled when >= 9 present
5. Clicking "Next" advances to P/C Assignment step (placeholder for now)
6. Step indicators update correctly (step 1 shows completed, step 2 active)
  </verify>
  <done>GameDayStepper container renders in Game Day tab with StepperHeader and functional AttendanceStep. Stepper navigation works for first two steps. Step indicators show correct states.</done>
</task>

<task type="auto">
  <name>Task 2: Add computeRecentPCHistory utility and build PCAssignmentStep with history column</name>
  <files>
    src/logic/game-history.ts
    src/components/game-day/steps/PCAssignmentStep.tsx
    src/components/game-day/steps/PCAssignmentStep.module.css
    src/components/game-day/GameDayStepper.tsx
  </files>
  <action>
**1. Add `computeRecentPCHistory` to `src/logic/game-history.ts`:**

Add a new exported function (do NOT modify existing functions):

```typescript
export interface RecentPCRecord {
  pitchedGames: number;      // How many of last 2 games player pitched
  caughtGames: number;       // How many of last 2 games player caught
  pitchedLast2Consecutive: boolean;  // True if pitched in both of the last 2 games
}

export function computeRecentPCHistory(
  history: GameHistoryEntry[],
  presentPlayerIds: string[],
): Record<string, RecentPCRecord> {
```

Logic:
- Take the last 2 games from history: `history.slice(-2)`
- For each game, determine who pitched and who caught by examining `game.lineup`:
  - For each inning in the game's lineup, check `lineup[inning]['P']` for pitcher and `lineup[inning]['C']` for catcher
  - A player "pitched that game" if they were assigned P in ANY inning
  - A player "caught that game" if they were assigned C in ANY inning
- For each present player, compute:
  - `pitchedGames`: count of last-2 games where they pitched
  - `caughtGames`: count of last-2 games where they caught
  - `pitchedLast2Consecutive`: true if pitchedGames === 2 AND there are at least 2 games in history
- Return a Record keyed by playerId

**2. Create `src/components/game-day/steps/PCAssignmentStep.tsx`:**

Per CONTEXT locked decisions:
- Two dropdowns at the TOP: one for Pitcher, one for Catcher
- Populated with present players only
- Absent players excluded from dropdowns
- Pitcher is REQUIRED to advance; Catcher is OPTIONAL
- Below the dropdowns: a player list showing P/C history in a separate column

The P/C assignment here is a SIMPLIFIED version of PreAssignments -- instead of per-inning dropdowns, it's a SINGLE pitcher dropdown and SINGLE catcher dropdown. The selected pitcher/catcher is applied to ALL innings. This aligns with CONTEXT: "two dropdowns at the top of the step: one for Pitcher, one for Catcher."

Props:
```typescript
interface PCAssignmentStepProps {
  onComplete: () => void;
}
```

Implementation:
- Use `useLineup()` for setPitcher, setCatcher, presentPlayers, innings
- Use `useGameHistory()` for history
- Call `computeRecentPCHistory(history, presentPlayers.map(p => p.id))` to get history data
- Local state for `selectedPitcher` and `selectedCatcher` (string, initially '')
- When pitcher/catcher is selected, apply to ALL innings:
  ```typescript
  const handlePitcherSelect = (playerId: string) => {
    setSelectedPitcher(playerId);
    for (let i = 1; i <= innings; i++) {
      setPitcher(i, playerId);
    }
  };
  ```
  Same pattern for catcher.

Render:
- Heading: "Pitcher & Catcher"
- Two `<select>` dropdowns side by side:
  - Pitcher: `<option value="">Select Pitcher</option>` + present players
  - Catcher: `<option value="">Select Catcher (optional)</option>` + present players (exclude selected pitcher from catcher options)
- Below dropdowns: Player list table with columns:
  - Name | P (last 2) | C (last 2) | Status
  - "P (last 2)" column: shows "1" or "2" or "-" (number of games pitched in last 2)
  - "C (last 2)" column: shows "1" or "2" or "-"
  - Each row for a present player
  - Absent players shown at bottom, greyed out (opacity 0.45), with "(absent)" text
  - If a player has `pitchedLast2Consecutive === true`, show a warning: "Pitched last 2 games" with a warning icon/color next to their name. This is INFORMATIONAL -- coach can still select them.
- "Next" button: enabled only when pitcher is selected (selectedPitcher !== ''). Catcher is optional.
- Clicking "Next" calls `onComplete()`

**3. Update `src/components/game-day/GameDayStepper.tsx`:**

Replace the P/C placeholder with the actual component:
```tsx
import { PCAssignmentStep } from './steps/PCAssignmentStep';
```

In the step rendering:
```tsx
{currentStep === 'pc-assignment' && (
  <PCAssignmentStep onComplete={() => completeStep('pc-assignment')} />
)}
```

**4. Create `src/components/game-day/steps/PCAssignmentStep.module.css`:**

- `.dropdowns` — display: flex, gap, margin-bottom
- `.dropdownGroup` — flex: 1, display: flex, flex-direction: column, gap: var(--space-xs)
- `.dropdownLabel` — font-weight: 600, font-size: var(--font-size-base)
- `.playerSelect` — min-height: var(--min-tap-size), font-size: var(--font-size-base), padding, border, border-radius
- `.historyTable` — width: 100%, border-collapse: collapse, margin-top: var(--space-lg)
- `.historyTable th` — text-align: left, padding, border-bottom, font-size: var(--font-size-sm), color: var(--color-text-muted)
- `.historyTable td` — padding: var(--space-sm), border-bottom: 1px solid var(--color-border)
- `.absentRow` — opacity: 0.45, text-decoration: line-through (per existing absent player pattern)
- `.warning` — color: var(--color-warning, #d97706), font-size: var(--font-size-sm)
- `.warningIcon` — margin-right: var(--space-xs) (use text "!" or similar -- no emoji)
- `.nextButton` — similar to existing generateButton style: min-height: var(--min-tap-size), background: var(--color-primary), color: white, border: none, border-radius, font-size, cursor pointer, width: 100%
- `.nextButton:disabled` — opacity: 0.5, cursor: not-allowed
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Open app:
1. Complete Attendance step (mark >= 9 present), advance to P/C Assignment
2. Two dropdowns shown: Pitcher and Catcher
3. Only present players appear in dropdowns
4. History column shows P/C data from last 2 games (or dashes if no history)
5. Selecting a pitcher from dropdown enables "Next" button
6. Absent players shown greyed out at bottom of player list
7. If a player pitched last 2 consecutive games, warning text is shown
  </verify>
  <done>PCAssignmentStep renders with pitcher/catcher dropdowns populated by present players, history column showing last-2-game P/C data, consecutive-pitch warning, and absent players greyed out. computeRecentPCHistory utility tested via UI.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Game Day tab shows stepper header with 5 labeled steps
3. Attendance step: can mark attendance, "Next" requires >= 9 present
4. P/C Assignment step: pitcher dropdown required, catcher optional, history column present
5. Absent players greyed out in P/C step and excluded from dropdowns
6. Step navigation: can go back to attendance, forward requires completion
7. Stale warning logic works (go back after generating shows warning)
</verification>

<success_criteria>
- GameDayStepper is the Game Day tab content
- 5-step stepper header shows progress visually
- Attendance step functional with present/absent toggles and minimum player validation
- P/C Assignment step shows history from last 2 games and enforces pitcher selection
- Absent players excluded from P/C dropdowns and visually greyed out
- Linear navigation enforced on first pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-app-restructuring-and-game-day-flow/10-02-SUMMARY.md`
</output>
