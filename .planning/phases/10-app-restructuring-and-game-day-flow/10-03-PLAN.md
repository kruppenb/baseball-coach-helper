---
phase: 10-app-restructuring-and-game-day-flow
plan: 03
type: execute
wave: 3
depends_on: ["10-02"]
files_modified:
  - src/components/game-day/steps/GenerateStep.tsx
  - src/components/game-day/steps/GenerateStep.module.css
  - src/components/game-day/steps/ReviewStep.tsx
  - src/components/game-day/steps/ReviewStep.module.css
  - src/components/game-day/steps/PrintStep.tsx
  - src/components/game-day/steps/PrintStep.module.css
  - src/components/game-day/GameDayStepper.tsx
autonomous: true

must_haves:
  truths:
    - "Generate step has a Generate button that produces lineup options"
    - "Review step shows selected lineup grid, fairness summary, validation panel, batting order, and finalize button"
    - "Previous game batting order shown alongside current auto-generated order for fairness comparison (FLOW-05)"
    - "Print step shows DugoutCard with Print button"
    - "Finalize Game saves lineup and batting order to history"
    - "Full stepper flow works end-to-end: Attendance through Print"
    - "After completing all steps once, coach can jump to any step freely"
  artifacts:
    - path: "src/components/game-day/steps/GenerateStep.tsx"
      provides: "Lineup generation step"
      exports: ["GenerateStep"]
    - path: "src/components/game-day/steps/ReviewStep.tsx"
      provides: "Lineup review, batting order, and finalize step"
      exports: ["ReviewStep"]
    - path: "src/components/game-day/steps/PrintStep.tsx"
      provides: "Print dugout card step"
      exports: ["PrintStep"]
  key_links:
    - from: "src/components/game-day/steps/GenerateStep.tsx"
      to: "src/hooks/useLineup.ts"
      via: "generate() call"
      pattern: "useLineup.*generate"
    - from: "src/components/game-day/steps/ReviewStep.tsx"
      to: "src/hooks/useBattingOrder.ts"
      via: "batting order generation and display"
      pattern: "useBattingOrder"
    - from: "src/components/game-day/steps/ReviewStep.tsx"
      to: "src/hooks/useGameHistory.ts"
      via: "previous batting order and finalize"
      pattern: "useGameHistory"
    - from: "src/components/game-day/steps/PrintStep.tsx"
      to: "src/components/lineup/DugoutCard.tsx"
      via: "DugoutCard rendering"
      pattern: "DugoutCard"
---

<objective>
Build the remaining 3 stepper steps (Generate, Review, Print) and wire the complete end-to-end stepper flow, including the previous batting order comparison.

Purpose: Completes the game-day stepper so the coach can go from marking attendance through printing a dugout card in a guided flow. This covers FLOW-02 completion, FLOW-05, and all finalize functionality.
Output: Complete 5-step stepper flow, fully functional end-to-end.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-app-restructuring-and-game-day-flow/10-CONTEXT.md
@.planning/phases/10-app-restructuring-and-game-day-flow/10-RESEARCH.md
@.planning/phases/10-app-restructuring-and-game-day-flow/10-01-SUMMARY.md
@.planning/phases/10-app-restructuring-and-game-day-flow/10-02-SUMMARY.md
@src/hooks/useLineup.ts
@src/hooks/useBattingOrder.ts
@src/hooks/useGameHistory.ts
@src/hooks/useRoster.ts
@src/components/lineup/LineupPage.tsx
@src/components/lineup/LineupGrid.tsx
@src/components/lineup/LineupOptions.tsx
@src/components/lineup/FairnessSummary.tsx
@src/components/lineup/ValidationPanel.tsx
@src/components/lineup/DugoutCard.tsx
@src/components/batting-order/BattingOrderSection.tsx
@src/components/batting-order/BattingOrderList.tsx
@src/components/game-day/GameDayStepper.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build GenerateStep and ReviewStep with batting order comparison</name>
  <files>
    src/components/game-day/steps/GenerateStep.tsx
    src/components/game-day/steps/GenerateStep.module.css
    src/components/game-day/steps/ReviewStep.tsx
    src/components/game-day/steps/ReviewStep.module.css
  </files>
  <action>
**1. Create `src/components/game-day/steps/GenerateStep.tsx`:**

Extracted from the "Setup" details section of LineupPage. This step lets the coach generate lineups.

Props:
```typescript
interface GenerateStepProps {
  onComplete: () => void;
}
```

Implementation:
- Use `useLineup()` for: generatedLineups, generate, clearLineups, presentPlayers
- Local state for `statusMessage` (string)
- Render:
  - Heading: "Generate Lineup"
  - Brief instruction: "Generate lineup options for today's game"
  - "Generate Lineups" button (or "Regenerate" if lineups exist)
  - "Clear" button if lineups exist
  - Status message showing result count or error
  - If lineups generated successfully, show count: "Generated X options!"
  - "Next" button: enabled only when `generatedLineups.length > 0`
  - Clicking "Next" calls `onComplete()`

Do NOT include PreAssignments or LineupOptions here -- P/C was handled in the previous step, and lineup selection happens in Review.

**2. Create `src/components/game-day/steps/GenerateStep.module.css`:**

- `.step` — padding: var(--space-md)
- `.generateButton` — min-height: var(--min-tap-size), background: var(--color-primary), color: white, border: none, border-radius: var(--radius-md), font-size: var(--font-size-lg), cursor: pointer, width: 100%, margin-bottom: var(--space-md)
- `.clearButton` — secondary style (outlined border, no fill)
- `.buttonRow` — display: flex, gap: var(--space-md), margin-bottom: var(--space-md)
- `.statusMessage` — color: var(--color-success), margin-bottom: var(--space-md)
- `.nextButton` — same style as in PCAssignmentStep (primary, full-width, disabled state)

**3. Create `src/components/game-day/steps/ReviewStep.tsx`:**

This is the "Review" step that encompasses: lineup selection, lineup grid, fairness summary, validation, batting order, and finalize. Per CONTEXT RESEARCH: "The Review step encompasses Edit Lineup + Batting Order + Finalize."

Props:
```typescript
interface ReviewStepProps {
  onComplete: () => void;
}
```

Implementation:
- Use `useLineup()` for: generatedLineups, selectedLineupIndex, selectedLineup, validationErrors, innings, selectLineup
- Use `useRoster()` for: players
- Use `useBattingOrder()` for: currentOrder, presentPlayers as battingPresentPlayers, generate as generateBattingOrder, clear as clearBattingOrder
- Use `useGameHistory()` for: history, finalizeGame
- Import and reuse existing components: LineupOptions, LineupGrid, FairnessSummary, ValidationPanel, BattingOrderList
- Import the `computeFairnessSummary` function -- extract it from LineupPage into a shared location OR inline it here (same logic). Best approach: copy the function into this file since it's a pure helper that was already module-level in LineupPage.
- Local state: `isFinalized` (boolean, false)

Render (top to bottom):
- Heading: "Review Lineup"

- **Lineup Options section:**
  - `<LineupOptions>` to select from generated lineups

- **Lineup Grid section** (when a lineup is selected):
  - `<LineupGrid>` showing positions x innings
  - `<FairnessSummary>` with computed summary
  - `<ValidationPanel>` showing any errors

- **Batting Order section:**
  - Sub-heading: "Batting Order"
  - "Generate Batting Order" / "Regenerate" button
  - "Clear" button if order exists
  - If `currentOrder` exists, render `<BattingOrderList>` showing the current auto-generated order

- **Previous Batting Order comparison (FLOW-05):**
  - If `history.length > 0`, show a side-by-side or stacked comparison:
    - "Previous Game" column/section: shows `history[history.length - 1].battingOrder` mapped to player names
    - "Current Game" column/section: shows `currentOrder` mapped to player names
  - Label: "Last game's batting order for reference"
  - If no history, skip this section

  Implementation of the comparison:
  ```tsx
  const previousBattingOrder = history.length > 0
    ? history[history.length - 1].battingOrder
    : null;
  ```
  Render as two side-by-side ordered lists if screen width allows, or stacked on narrow screens. Use a simple flex layout with two columns. Each column shows an `<ol>` with player names.

- **Finalize section:**
  - "Finalize Game" button (disabled if no currentOrder or already finalized)
  - Clicking calls `confirmBatting()` then `finalizeGame(selectedLineup, currentOrder, innings, players)`, sets `isFinalized = true`
  - If finalized: show "Game finalized and saved to history!" message and enable "Next"

- "Next" button: enabled only when `isFinalized`
- Clicking "Next" calls `onComplete()`

Reset `isFinalized` when `selectedLineupIndex` changes (via useEffect).

**4. Create `src/components/game-day/steps/ReviewStep.module.css`:**

- `.step` — padding: var(--space-md)
- `.section` — margin-bottom: var(--space-xl), border-top: 1px solid var(--color-border), padding-top: var(--space-md)
- `.sectionTitle` — font-size: var(--font-size-lg), font-weight: 600, margin-bottom: var(--space-md)
- `.comparison` — display: flex, gap: var(--space-lg), margin-bottom: var(--space-lg)
- `.comparisonColumn` — flex: 1
- `.comparisonTitle` — font-size: var(--font-size-sm), font-weight: 600, color: var(--color-text-muted), margin-bottom: var(--space-sm)
- `.comparisonList` — list-style-type: decimal, padding-left: var(--space-lg), font-size: var(--font-size-base)
- `.finalizeButton` — similar to generateButton but with a distinct style (e.g., var(--color-success) background)
- `.finalizedMessage` — color: var(--color-success)
- `.nextButton` — primary full-width button
- `.actions` — display: flex, gap: var(--space-md), margin-bottom: var(--space-md)
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Test full flow through Generate and Review:
1. Generate step: clicking "Generate Lineups" produces options, "Next" enabled
2. Review step: lineup options shown, can select, grid displays
3. Batting order can be generated
4. Previous batting order comparison visible (if history exists)
5. Finalize Game button works and enables "Next"
  </verify>
  <done>GenerateStep produces lineups. ReviewStep shows lineup grid, fairness summary, batting order with previous-game comparison, and finalize flow. Steps advance correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Build PrintStep and wire complete stepper flow</name>
  <files>
    src/components/game-day/steps/PrintStep.tsx
    src/components/game-day/steps/PrintStep.module.css
    src/components/game-day/GameDayStepper.tsx
  </files>
  <action>
**1. Create `src/components/game-day/steps/PrintStep.tsx`:**

The final step -- displays the DugoutCard for printing.

Props:
```typescript
interface PrintStepProps {}  // No onComplete needed -- terminal step
```

Implementation:
- Use `useLineup()` for: selectedLineup, innings
- Use `useRoster()` for: players
- Use `useBattingOrder()` for: currentOrder
- Reuse `<DugoutCard>` component as-is -- it already has the `data-dugout-card` attribute and print button

Render:
- Heading: "Print Dugout Card"
- Brief instruction: "Print or screenshot the dugout card below"
- `<DugoutCard lineup={selectedLineup} innings={innings} players={players} battingOrder={currentOrder} />`
- The DugoutCard already includes its own "Print Dugout Card" button

IMPORTANT: Preserve the `data-dugout-card` attribute on DugoutCard -- existing print CSS relies on it.

**2. Create `src/components/game-day/steps/PrintStep.module.css`:**

Minimal styling:
- `.step` — padding: var(--space-md)
- `.heading` — margin-bottom: var(--space-md)
- `.instruction` — color: var(--color-text-muted), margin-bottom: var(--space-lg), font-size: var(--font-size-base)

**3. Update `src/components/game-day/GameDayStepper.tsx`:**

Wire all 5 steps into the stepper:

```tsx
import { AttendanceStep } from './steps/AttendanceStep';
import { PCAssignmentStep } from './steps/PCAssignmentStep';
import { GenerateStep } from './steps/GenerateStep';
import { ReviewStep } from './steps/ReviewStep';
import { PrintStep } from './steps/PrintStep';
```

Complete the conditional rendering for all 5 steps:

```tsx
{currentStep === 'attendance' && (
  <AttendanceStep onComplete={() => completeStep('attendance')} />
)}
{currentStep === 'pc-assignment' && (
  <PCAssignmentStep onComplete={() => completeStep('pc-assignment')} />
)}
{currentStep === 'generate' && (
  <GenerateStep onComplete={() => completeStep('generate')} />
)}
{currentStep === 'review' && (
  <ReviewStep onComplete={() => completeStep('review')} />
)}
{currentStep === 'print' && (
  <PrintStep />
)}
```

Also add a "Back" button to each step (except Attendance which is step 1):
- The GameDayStepper itself should render a "Back" button above the step content when `currentStep` is not the first step
- Clicking "Back" calls `goToStep(previousStep)` where previousStep is the step before the current one in the ordered array
- This triggers the stale warning logic in useStepperState when going back past 'generate'

Add the back button rendering in GameDayStepper:
```tsx
const STEP_ORDER: StepId[] = ['attendance', 'pc-assignment', 'generate', 'review', 'print'];
const currentIndex = STEP_ORDER.indexOf(currentStep);

{currentIndex > 0 && (
  <button
    type="button"
    className={styles.backButton}
    onClick={() => goToStep(STEP_ORDER[currentIndex - 1])}
  >
    Back
  </button>
)}
```

Add to GameDayStepper.module.css:
- `.backButton` — background: none, border: none, color: var(--color-primary), cursor: pointer, font-size: var(--font-size-base), padding: var(--space-sm), margin-bottom: var(--space-sm)
- `.staleWarning` — background: #fef3c7, border: 1px solid #f59e0b, border-radius: var(--radius-md), padding: var(--space-md), margin-bottom: var(--space-md), display: flex, justify-content: space-between, align-items: center
- `.staleWarningText` — font-size: var(--font-size-base), color: #92400e
- `.dismissButton` — background: none, border: none, cursor: pointer, color: #92400e, font-weight: 600
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Test complete end-to-end flow:
1. Attendance: mark players present, click Next
2. P/C Assignment: select pitcher, click Next
3. Generate: click Generate, click Next
4. Review: select lineup, generate batting order, finalize, click Next
5. Print: see DugoutCard, click Print
6. After completing all steps, click on any step in stepper header to navigate freely
7. Go back to Attendance, change something -- stale warning appears
8. Print button still works (data-dugout-card attribute preserved)
  </verify>
  <done>PrintStep renders DugoutCard with print functionality. All 5 stepper steps wired and functional. Back button works. Stale warning appears when going back to change earlier inputs. Free navigation unlocked after completing all steps once.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Complete end-to-end stepper: Attendance -> P/C -> Generate -> Review -> Print
3. Linear navigation enforced on first pass (must complete each step)
4. Free navigation after completing all steps once
5. Back button works on all steps except first
6. Stale warning when changing attendance after generating
7. Previous batting order comparison visible in Review step (FLOW-05)
8. Finalize Game saves to history
9. Print dugout card works (data-dugout-card attribute preserved)
10. No orphaned imports or unused code
</verification>

<success_criteria>
- All 5 stepper steps functional end-to-end
- FLOW-05: previous batting order shown alongside current in Review step
- Finalize saves lineup + batting order to history
- Print works with existing dugout card
- Stepper navigation rules enforced (linear first pass, free after completion)
- Stale warning on backward navigation past generate
</success_criteria>

<output>
After completion, create `.planning/phases/10-app-restructuring-and-game-day-flow/10-03-SUMMARY.md`
</output>
