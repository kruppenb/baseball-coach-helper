---
phase: 19.1-staging-environment-and-deployment-slot-swap
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/azure-static-web-apps-lemon-hill-0d4d7521e.yml
  - deployment.md
autonomous: true
requirements: []

must_haves:
  truths:
    - "PR builds deploy frontend to SWA preview environment but do NOT deploy the API to production"
    - "Push-to-main builds deploy both frontend (SWA production) and API (Functions app) as before"
    - "PR close/merge triggers SWA preview environment cleanup"
    - "deployment.md accurately documents preview environment behavior and URL format"
  artifacts:
    - path: ".github/workflows/azure-static-web-apps-lemon-hill-0d4d7521e.yml"
      provides: "CI/CD workflow with conditional API deployment (main-only) and PR preview support"
      contains: "if.*github.event_name == 'push'"
    - path: "deployment.md"
      provides: "Updated deployment documentation covering preview environments"
      contains: "preview environment"
  key_links:
    - from: ".github/workflows/azure-static-web-apps-lemon-hill-0d4d7521e.yml"
      to: "Azure Static Web Apps preview environment"
      via: "Azure/static-web-apps-deploy@v1 action with pull_request trigger"
      pattern: "static-web-apps-deploy@v1"
---

<objective>
Fix the GitHub Actions workflow so that PR builds create SWA frontend preview environments WITHOUT deploying the API to the production Functions app, and update deployment documentation to describe the preview environment workflow.

Purpose: Currently the workflow deploys the API to the production Functions app on every build, including PR builds. This means untested API changes go live before the PR is reviewed and merged. By gating API deployment to push-to-main only, PRs get safe frontend-only preview environments while production API remains stable.

Output: Updated workflow file with conditional API deployment; updated deployment.md documenting preview environments.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@deployment.md
@.github/workflows/azure-static-web-apps-lemon-hill-0d4d7521e.yml
@staticwebapp.config.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gate API deployment to main-only and ensure PR preview environments work</name>
  <files>.github/workflows/azure-static-web-apps-lemon-hill-0d4d7521e.yml</files>
  <action>
Modify the `build_and_deploy` job in the workflow to conditionally deploy the API only on push-to-main (not on PR builds). The SWA frontend deploy already works for both push and PR via the `Azure/static-web-apps-deploy@v1` action, which automatically creates preview environments for PRs.

Specific changes:

1. **Add an `if` condition to the "Deploy API to Functions app" step** so it only runs on push events (not pull_request):
   ```yaml
   - name: Deploy API to Functions app
     if: github.event_name == 'push'
     uses: Azure/functions-action@v1
     with:
       app-name: ${{ env.FUNC_APP_NAME }}
       package: api
   ```

2. **Also gate the "Install and build API" step** behind the same condition to save CI time on PRs:
   ```yaml
   - name: Install and build API
     if: github.event_name == 'push'
     run: npm ci && npm run build
     working-directory: api
   ```

3. **Verify the `close_pull_request` job** already correctly handles cleanup. It uses `action: "close"` which tells SWA to delete the preview environment. This is already correct -- no changes needed there.

4. **Verify the SWA deploy step** in `build_and_deploy` does NOT set `skip_app_build: true` or `production_branch` restrictions that would prevent preview deployments. The current config with `action: "upload"`, `app_location: "/"`, `output_location: "dist"` is correct for both production and preview deployments.

The result is:
- **PR builds**: Checkout, Azure login, get SWA token, setup Node, build frontend, deploy SWA (creates preview env). API is NOT built or deployed.
- **Push to main**: Checkout, Azure login, get SWA token, setup Node, build+deploy API, build+deploy SWA (production).
- **PR close**: Azure login, get SWA token, close SWA preview env. API not touched.
  </action>
  <verify>
Read the modified workflow file and confirm:
1. The "Install and build API" step has `if: github.event_name == 'push'`
2. The "Deploy API to Functions app" step has `if: github.event_name == 'push'`
3. The SWA deploy step has NO such condition (runs for both push and PR)
4. The close_pull_request job is unchanged
5. Run `npx yaml-lint .github/workflows/azure-static-web-apps-lemon-hill-0d4d7521e.yml` or similar to validate YAML syntax (if available), or at minimum visually confirm indentation is correct
  </verify>
  <done>
The workflow file gates API build+deploy to push events only. PR builds skip API entirely and only deploy the frontend to a SWA preview environment. Push-to-main deploys both API and frontend to production as before.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update deployment.md to document preview environment workflow</name>
  <files>deployment.md</files>
  <action>
Update `deployment.md` to accurately document the preview environment behavior. Make these changes:

1. **Update the "How it deploys" section** to clarify the PR vs push behavior. Replace the current paragraph about PR branches:

   Current text: "PR branches get a SWA preview environment for the frontend. The API always deploys to the single Functions app (no staging slots on consumption plan)."

   New text: "PR branches get a SWA preview environment for the frontend. The API is NOT deployed on PR builds -- it only deploys on push to main. This keeps the production API stable during code review."

2. **Add a new "## Preview environments" section** after the "How it deploys" section with the following content:

   ```markdown
   ## Preview environments

   When a pull request is opened against `main`, the GitHub Actions workflow:

   1. Builds the frontend (Vite)
   2. Deploys it to an Azure SWA preview environment (skips API build and deploy)
   3. The SWA GitHub bot posts a comment on the PR with the preview URL

   Preview URL format: `https://<subdomain>-<pr-number>.<region>.azurestaticapps.net`

   The preview environment uses the **production API** (same linked Functions app). This means:
   - Frontend changes are isolated per PR
   - API changes are NOT reflected until merged to main
   - Auth and data work normally against production Cosmos DB

   When the PR is closed or merged, the preview environment is automatically deleted by the `close_pull_request` workflow job.

   **Limits:** The SWA Free tier supports up to 3 concurrent preview environments.
   ```

3. **Keep all other sections unchanged.**
  </action>
  <verify>
Read `deployment.md` and confirm:
1. The old "API always deploys" sentence is replaced with the new "API is NOT deployed on PR builds" text
2. The "Preview environments" section exists with the URL format, behavior description, and limits note
3. All other sections (CI authentication, Why a linked backend, Azure resources, etc.) are unchanged
  </verify>
  <done>
deployment.md accurately documents that PR builds create frontend-only preview environments without deploying the API, includes the preview URL format, explains that preview environments use the production API backend, and notes the cleanup behavior and Free tier limits.
  </done>
</task>

</tasks>

<verification>
1. Read the workflow file and confirm API steps have `if: github.event_name == 'push'` conditions
2. Read deployment.md and confirm preview environment documentation is present and accurate
3. Verify no other files were unintentionally modified
</verification>

<success_criteria>
- The workflow file gates API deployment to push-to-main only
- PR builds create SWA preview environments for frontend without touching the production API
- deployment.md documents preview environment behavior, URL format, and limitations
- The close_pull_request job continues to clean up preview environments on PR close
</success_criteria>

<output>
After completion, create `.planning/phases/19.1-staging-environment-and-deployment-slot-swap/19.1-01-SUMMARY.md`
</output>
