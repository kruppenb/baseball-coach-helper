---
phase: 06-api-database
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/package.json
  - api/tsconfig.json
  - api/host.json
  - api/local.settings.json
  - api/.funcignore
  - api/src/lib/auth.ts
  - api/src/lib/cosmos.ts
  - api/src/lib/types.ts
  - .gitignore
autonomous: true
user_setup:
  - service: cosmos-db
    why: "Cosmos DB stores all coach data"
    env_vars:
      - name: COSMOSDB_CONNECTION_STRING
        source: "Azure Portal -> Cosmos DB account -> Settings -> Keys -> Primary Connection String (or use local emulator: AccountEndpoint=https://localhost:8081/;AccountKey=><cosmos-emulator-default-key>==)"

must_haves:
  truths:
    - "api/ folder has its own Node.js project with Azure Functions v4 and Cosmos SDK"
    - "Shared auth helper parses x-ms-client-principal header and returns userId or null"
    - "Shared Cosmos client is a module-level singleton reused across invocations"
    - "Cosmos DB connection string is only in local.settings.json (gitignored), never in client code"
  artifacts:
    - path: "api/package.json"
      provides: "API project with @azure/functions and @azure/cosmos dependencies"
      contains: "@azure/functions"
    - path: "api/tsconfig.json"
      provides: "TypeScript config targeting ES2022 with Node16 module resolution"
      contains: "Node16"
    - path: "api/host.json"
      provides: "Azure Functions host config with extension bundle"
      contains: "extensionBundle"
    - path: "api/src/lib/auth.ts"
      provides: "parseClientPrincipal function extracting userId from SWA header"
      exports: ["parseClientPrincipal", "ClientPrincipal"]
    - path: "api/src/lib/cosmos.ts"
      provides: "Singleton CosmosClient and container export"
      exports: ["container"]
    - path: "api/src/lib/types.ts"
      provides: "CosmosDocument interface and DocType union"
      exports: ["CosmosDocument", "DocType"]
  key_links:
    - from: "api/src/lib/cosmos.ts"
      to: "process.env.COSMOSDB_CONNECTION_STRING"
      via: "environment variable read at module scope"
      pattern: "process\\.env\\.COSMOSDB_CONNECTION_STRING"
    - from: "api/package.json"
      to: "api/dist/functions/*.js"
      via: "main field glob for function discovery"
      pattern: "dist/functions/\\*\\.js"
---

<objective>
Create the Azure Functions API project scaffold with shared auth and Cosmos DB infrastructure libraries.

Purpose: Establishes the api/ folder as a standalone Node.js/TypeScript project with Azure Functions v4 programming model. Provides the shared parseClientPrincipal auth helper and singleton CosmosClient that all endpoint functions will import. This is the foundation that Plan 02's endpoints build on.

Output: A buildable api/ project with package.json, tsconfig.json, host.json, shared auth/cosmos/types libraries, and .gitignore updates for local.settings.json.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-api-database/06-RESEARCH.md
@src/auth/types.ts
@src/types/index.ts
@staticwebapp.config.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API project scaffold</name>
  <files>
    api/package.json
    api/tsconfig.json
    api/host.json
    api/local.settings.json
    api/.funcignore
    .gitignore
  </files>
  <action>
Create the api/ folder at the project root with a complete Azure Functions v4 TypeScript project.

**api/package.json:**
- name: "api"
- main: "dist/functions/*.js" (critical for SWA function discovery)
- scripts: build ("tsc"), prestart ("npm run build"), start ("func start")
- dependencies: @azure/functions ^4.11.0, @azure/cosmos ^4.9.0
- devDependencies: typescript ~5.9.3, @types/node ^22.0.0

**api/tsconfig.json:**
- target: ES2022, module: Node16, moduleResolution: Node16
- outDir: "dist", rootDir: "src"
- strict: true, esModuleInterop: true, skipLibCheck: true, declaration: false
- include: ["src"]

**api/host.json:**
- version: "2.0"
- extensionBundle: { id: "Microsoft.Azure.Functions.ExtensionBundle", version: "[4.*, 5.0.0)" }

**api/local.settings.json:**
- IsEncrypted: false
- Values: AzureWebJobsStorage: "", FUNCTIONS_WORKER_RUNTIME: "node", COSMOSDB_CONNECTION_STRING: "AccountEndpoint=https://localhost:8081/;AccountKey=><cosmos-emulator-default-key>==" (Cosmos emulator default)

**api/.funcignore:**
- *.ts (source files), .funcignore, tsconfig.json, local.settings.json, node_modules, src

**.gitignore** (append to existing):
- Add "local.settings.json" line (Cosmos connection string must never be committed)
- Add "api/dist/" line (compiled API output)

After creating all files, run `cd api && npm install` to install dependencies and generate package-lock.json.
  </action>
  <verify>
Run: `cd C:/repos/baseball-coach-helper/api && npm run build` (should succeed with no TypeScript errors, even though no functions exist yet -- tsc finds no source files to compile but exits 0). Verify api/node_modules/@azure/functions and api/node_modules/@azure/cosmos exist. Verify local.settings.json appears in .gitignore.
  </verify>
  <done>
api/ folder exists with package.json (main: "dist/functions/*.js"), tsconfig.json (outDir: "dist"), host.json (extension bundle), local.settings.json (gitignored with Cosmos emulator default), .funcignore, and all npm dependencies installed. .gitignore updated with local.settings.json and api/dist/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared auth, Cosmos, and types libraries</name>
  <files>
    api/src/lib/auth.ts
    api/src/lib/cosmos.ts
    api/src/lib/types.ts
  </files>
  <action>
Create three shared library files that all endpoint functions will import.

**api/src/lib/auth.ts:**
- Define ClientPrincipal interface: { identityProvider: string, userId: string, userDetails: string, userRoles: string[] } (simplified from frontend -- API only needs these fields)
- Export parseClientPrincipal(request: HttpRequest): ClientPrincipal | null
  - Read x-ms-client-principal header from request.headers.get()
  - If missing, return null
  - Base64-decode with Buffer.from(header, 'base64').toString('utf-8')
  - JSON.parse and return as ClientPrincipal
  - Wrap in try/catch: return null on any parse error (defensive)
- Import HttpRequest from @azure/functions

**api/src/lib/cosmos.ts:**
- Import CosmosClient and Container from @azure/cosmos
- Read connection string from process.env.COSMOSDB_CONNECTION_STRING
- If missing, throw a clear error at module load: "COSMOSDB_CONNECTION_STRING environment variable is required"
- Create singleton CosmosClient at module scope
- Export database reference: client.database('baseball-coach')
- Export container reference: database.container('coach-data')
- Export only `container` (that is all endpoints need)

**api/src/lib/types.ts:**
- Define DocType union: 'roster' | 'gameConfig' | 'lineupState' | 'battingOrderState' | 'gameHistory' | 'battingHistory'
- Define CosmosDocument interface: { id: string, userId: string, docType: DocType, data: unknown, updatedAt: string, _etag?: string }
- These are the shapes stored in Cosmos -- the `data` field holds the actual frontend payload (Player[], GameConfig, etc.)
  </action>
  <verify>
Run: `cd C:/repos/baseball-coach-helper/api && npx tsc --noEmit` -- should compile with zero errors. Verify all three files exist and export the expected symbols.
  </verify>
  <done>
auth.ts exports parseClientPrincipal that decodes x-ms-client-principal header. cosmos.ts exports a singleton container bound to baseball-coach/coach-data. types.ts exports CosmosDocument and DocType. All compile cleanly.
  </done>
</task>

</tasks>

<verification>
1. `cd api && npm run build` succeeds (tsc compiles to dist/)
2. api/dist/lib/auth.js, api/dist/lib/cosmos.js, api/dist/lib/types.js exist after build
3. `grep "local.settings.json" .gitignore` returns a match
4. api/local.settings.json contains COSMOSDB_CONNECTION_STRING (not committed to git)
5. No Cosmos DB credentials appear anywhere outside api/local.settings.json
</verification>

<success_criteria>
- api/ project builds with zero TypeScript errors
- Shared libraries (auth, cosmos, types) compile and are importable
- Cosmos connection string is only in gitignored local.settings.json
- Package.json main field points to dist/functions/*.js for SWA function discovery
</success_criteria>

<output>
After completion, create `.planning/phases/06-api-database/06-01-SUMMARY.md`
</output>
