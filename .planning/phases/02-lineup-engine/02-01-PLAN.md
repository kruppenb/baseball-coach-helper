---
phase: 02-lineup-engine
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/types/index.ts
  - src/logic/lineup-types.ts
  - src/logic/lineup-validator.ts
  - src/logic/lineup-validator.test.ts
autonomous: true

must_haves:
  truths:
    - "Validation catches consecutive bench violations and names the player and innings"
    - "Validation catches infield minimum violations and reports count vs required"
    - "Validation catches consecutive same-position violations (except P/C)"
    - "Validation catches position block violations"
    - "Validation catches grid completeness issues (missing assignments)"
    - "Validation catches duplicate player-in-same-inning issues"
    - "All error messages use player names, not IDs"
  artifacts:
    - path: "src/types/index.ts"
      provides: "Position, Lineup, InningAssignment, BatteryAssignments, PositionBlocks, LineupState types"
      contains: "Position"
    - path: "src/logic/lineup-types.ts"
      provides: "GenerateLineupInput, GenerateLineupResult, ValidationError, ValidationRule types"
      exports: ["GenerateLineupInput", "GenerateLineupResult", "ValidationError", "ValidationRule"]
    - path: "src/logic/lineup-validator.ts"
      provides: "validateLineup function with 8 validation rules"
      exports: ["validateLineup"]
    - path: "src/logic/lineup-validator.test.ts"
      provides: "Test coverage for all 8 validation rules"
      min_lines: 100
  key_links:
    - from: "src/logic/lineup-validator.ts"
      to: "src/logic/lineup-types.ts"
      via: "imports ValidationError, ValidationRule, GenerateLineupInput"
      pattern: "import.*from.*lineup-types"
    - from: "src/logic/lineup-validator.ts"
      to: "src/types/index.ts"
      via: "imports Position, Lineup, Player, POSITIONS, INFIELD_POSITIONS"
      pattern: "import.*from.*types"
---

<objective>
Define all lineup-related TypeScript types and build the complete validation system using TDD.

Purpose: Types are the shared foundation for all Phase 2 plans. The validator is a pure function with clear I/O -- perfect TDD candidate. Getting types and validation right first ensures the generator and UI have a solid contract to build against.

Output: Extended type definitions in src/types/index.ts, dedicated lineup types in src/logic/lineup-types.ts, fully tested validator in src/logic/lineup-validator.ts with coach-friendly error messages.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-lineup-engine/02-RESEARCH.md

# Phase 1 built these -- needed for type extensions
@src/types/index.ts
@src/hooks/useLocalStorage.ts
</context>

<feature>
  <name>Lineup Types and Validation System</name>
  <files>src/types/index.ts, src/logic/lineup-types.ts, src/logic/lineup-validator.ts, src/logic/lineup-validator.test.ts</files>
  <behavior>
    The validation system takes a Lineup object and GenerateLineupInput and returns an array of ValidationError objects. Each error has a rule ID, a coach-friendly message using player names, and optional inning/playerId/position references.

    **Type definitions to add to src/types/index.ts:**
    - Position type: 'P' | 'C' | '1B' | '2B' | '3B' | 'SS' | 'LF' | 'CF' | 'RF'
    - POSITIONS constant array (all 9)
    - INFIELD_POSITIONS constant array: ['P', 'C', '1B', '2B', '3B', 'SS']
    - OUTFIELD_POSITIONS constant array: ['LF', 'CF', 'RF']
    - InningAssignment type: Record&lt;Position, string&gt; (position -> playerId)
    - Lineup type: Record&lt;number, InningAssignment&gt; (inning -> assignments)
    - BatteryAssignments type: Record&lt;number, string&gt; (inning -> playerId)
    - PositionBlocks type: Record&lt;string, Position[]&gt; (playerId -> blocked positions)
    - LineupState interface: { pitcherAssignments, catcherAssignments, positionBlocks, generatedLineups, selectedLineupIndex }

    **Types in src/logic/lineup-types.ts:**
    - ValidationRule union type: 'GRID_COMPLETE' | 'NO_DUPLICATES' | 'PITCHER_MATCH' | 'CATCHER_MATCH' | 'NO_CONSECUTIVE_BENCH' | 'INFIELD_MINIMUM' | 'NO_CONSECUTIVE_POSITION' | 'POSITION_BLOCK'
    - ValidationError interface: { rule, message, inning?, playerId?, position? }
    - GenerateLineupInput interface: { presentPlayers: Player[], innings: number, pitcherAssignments: BatteryAssignments, catcherAssignments: BatteryAssignments, positionBlocks: PositionBlocks }
    - GenerateLineupResult interface: { lineup: Lineup, valid: boolean, errors: ValidationError[], attemptCount: number }

    **Validation rules (8 total):**
    1. GRID_COMPLETE: Every position filled every inning -> "Inning {N} is missing a {position}."
    2. NO_DUPLICATES: No player in two positions same inning -> "{name} is assigned to both {pos1} and {pos2} in inning {N}."
    3. PITCHER_MATCH: Pitcher matches pre-assignment -> "Inning {N} pitcher should be {name} but {other} is assigned."
    4. CATCHER_MATCH: Catcher matches pre-assignment -> same pattern
    5. NO_CONSECUTIVE_BENCH: No player sits 2+ innings in a row -> "{name} sits out innings {N} and {N+1} in a row. Every player should get to play each inning."
    6. INFIELD_MINIMUM: Every player gets 2+ infield positions by inning 4 -> "{name} only has {count} infield position(s) in the first 4 innings. Every player needs at least 2."
    7. NO_CONSECUTIVE_POSITION: No same position consecutive innings (except P/C) -> "{name} plays {position} in both innings {N} and {N+1}."
    8. POSITION_BLOCK: No player in a blocked position -> "{name} is blocked from playing {position} but is assigned there in inning {N}."

    **Test cases (input -> expected output):**
    - Valid 11-player 6-inning lineup -> [] (no errors)
    - Player sitting innings 2 and 3 -> [NO_CONSECUTIVE_BENCH error with player name]
    - Player with only 1 infield position in innings 1-4 -> [INFIELD_MINIMUM error]
    - Player at SS in innings 3 and 4 -> [NO_CONSECUTIVE_POSITION error]
    - Player at P in innings 3 and 4 -> [] (P/C exempt from consecutive position rule)
    - Player at C in innings 1 and 2 -> [] (P/C exempt)
    - Player assigned to blocked position -> [POSITION_BLOCK error]
    - Missing position in an inning -> [GRID_COMPLETE error]
    - Player in two positions same inning -> [NO_DUPLICATES error]
    - Pitcher doesn't match pre-assignment -> [PITCHER_MATCH error]
    - Multiple violations -> returns all errors (not just first)
  </behavior>
  <implementation>
    1. Install vitest as dev dependency (check if already present; if not, add it -- needed for TDD across all Phase 2 plans).
    2. Create src/logic/lineup-types.ts with ValidationRule, ValidationError, GenerateLineupInput, GenerateLineupResult.
    3. Extend src/types/index.ts with Position, POSITIONS, INFIELD_POSITIONS, OUTFIELD_POSITIONS, InningAssignment, Lineup, BatteryAssignments, PositionBlocks, LineupState.
    4. Create src/logic/lineup-validator.ts with validateLineup() that runs all 8 sub-validators and returns combined errors.
    5. Each sub-validator is a pure function taking (lineup, input) and returning ValidationError[].
    6. Error messages must resolve player IDs to player names from input.presentPlayers.
    7. The INFIELD_MINIMUM check always looks at innings 1 through min(4, input.innings) -- hardcoded to 4, not total innings.
    8. NO_CONSECUTIVE_POSITION explicitly skips P and C positions (they are exempt per LINE-06).
  </implementation>
</feature>

<verification>
- `npx vitest run src/logic/lineup-validator.test.ts` passes with all tests green
- All 8 validation rules have at least one test case
- Coach-friendly messages verified (contain player names, not UUIDs)
- `npm run build` passes with zero TypeScript errors
- No React imports in any src/logic/ file
</verification>

<success_criteria>
- All lineup types exported from src/types/index.ts and src/logic/lineup-types.ts
- validateLineup() returns correct errors for all 8 rule violations
- validateLineup() returns empty array for valid lineups
- P/C are exempt from NO_CONSECUTIVE_POSITION rule
- INFIELD_MINIMUM checks innings 1-4 regardless of total innings
- All error messages use player names, not IDs
- Zero React dependencies in logic files
</success_criteria>

<output>
After completion, create `.planning/phases/02-lineup-engine/02-01-SUMMARY.md`
</output>
