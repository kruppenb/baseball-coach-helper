---
phase: 02-lineup-engine
plan: 02
type: tdd
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/logic/lineup-generator.ts
  - src/logic/lineup-generator.test.ts
autonomous: true

must_haves:
  truths:
    - "generateLineup() produces a valid lineup for 11 present players over 6 innings"
    - "generateLineup() produces a valid lineup for 10 present players (tight bench rotation)"
    - "generateLineup() respects pitcher and catcher pre-assignments"
    - "generateLineup() respects position blocks"
    - "generateMultipleLineups() returns 3 distinct valid lineups"
    - "preValidate() catches impossible inputs before generation runs"
    - "Generation fails gracefully with a coach-friendly error when constraints are unsatisfiable"
  artifacts:
    - path: "src/logic/lineup-generator.ts"
      provides: "generateLineup, generateMultipleLineups, preValidate functions"
      exports: ["generateLineup", "generateMultipleLineups", "preValidate"]
      min_lines: 150
    - path: "src/logic/lineup-generator.test.ts"
      provides: "Tests for generation, pre-validation, edge cases"
      min_lines: 100
  key_links:
    - from: "src/logic/lineup-generator.ts"
      to: "src/logic/lineup-validator.ts"
      via: "calls validateLineup to verify generated result"
      pattern: "import.*validateLineup.*from.*lineup-validator"
    - from: "src/logic/lineup-generator.ts"
      to: "src/logic/lineup-types.ts"
      via: "uses GenerateLineupInput, GenerateLineupResult"
      pattern: "import.*from.*lineup-types"
    - from: "src/logic/lineup-generator.ts"
      to: "src/types/index.ts"
      via: "uses Position, Lineup, POSITIONS, INFIELD_POSITIONS"
      pattern: "import.*from.*types"
---

<objective>
Build the core lineup generation algorithm as pure functions using TDD, adapted from the reference implementation at C:\repos\baseball-coach\src\App.tsx (lines 219-483).

Purpose: This is the heart of the application -- the constraint solver that produces fair lineups. TDD ensures every constraint is verified before implementation, and the retry-based approach is validated against edge cases (10-player rosters, 5 vs 6 innings).

Output: Fully tested lineup generator in src/logic/lineup-generator.ts with preValidate(), generateLineup(), and generateMultipleLineups() functions.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-lineup-engine/02-RESEARCH.md

# Must read -- the reference algorithm to adapt
@C:\repos\baseball-coach\src\App.tsx

# From Plan 01 -- types and validator this plan depends on
@src/types/index.ts
@src/logic/lineup-types.ts
@src/logic/lineup-validator.ts
</context>

<feature>
  <name>Lineup Generation Algorithm</name>
  <files>src/logic/lineup-generator.ts, src/logic/lineup-generator.test.ts</files>
  <behavior>
    Three exported functions, all pure (no React, no DOM, no side effects):

    **preValidate(input: GenerateLineupInput): string[]**
    Returns coach-friendly error strings for impossible inputs. Checks:
    - presentPlayers.length >= 9 (need 9 to fill positions)
    - All assigned pitchers/catchers are in presentPlayers
    - No player assigned as both pitcher AND catcher for same inning
    - No absent player assigned to pitch/catch
    - Position blocks don't make any position unfillable (every position must have enough eligible players across all innings)
    Cases:
    - 8 present players -> ["Need at least 9 present players to fill all positions. Currently 8 present."]
    - Pitcher for inning 2 is not present -> ["Pitcher for inning 2 is not in the active roster."]
    - Same player as P and C inning 3 -> ["Same player assigned as both pitcher and catcher in inning 3."]
    - All players blocked from 3B -> ["Not enough players eligible for 3B. Consider removing some 3B blocks."]
    - Valid input -> [] (empty array)

    **generateLineup(input: GenerateLineupInput): GenerateLineupResult**
    Retry-based constraint solver adapted from the reference algorithm. Strategy:
    1. Shuffle present players randomly
    2. Pre-assign P/C per inning from input.pitcherAssignments/catcherAssignments
    3. Calculate infield needs per player (2 minimum by inning 4, subtract P/C innings)
    4. Pre-assign infield slots for innings 1-4 with priority to P/C players
    5. Fill remaining positions inning-by-inning:
       a. Set P/C from pre-assignments (or random if unassigned)
       b. Fill pre-assigned infield slots
       c. Fill remaining infield (respecting blocks + no consecutive same position)
       d. Fill outfield (prioritizing players who sat last inning)
       e. Remaining players go to bench
    6. Validate result with validateLineup()
    7. If invalid, retry (max 200 attempts)
    Returns: { lineup, valid, errors, attemptCount }

    Key differences from reference:
    - Parameterized innings (5 or 6, not hardcoded 5)
    - P/C per-inning (not slot-range mapping)
    - Position blocks checked during assignment
    - Returns structured result instead of setting React state
    - No console.log -- clean pure function
    - Uses player IDs (UUIDs) not names

    **generateMultipleLineups(input: GenerateLineupInput, count?: number): GenerateLineupResult[]**
    Runs generateLineup() multiple times with different random shuffles. Deduplicates (lineups must differ meaningfully -- different bench patterns or different infield assignments, not just LF/RF swaps). Caps total attempts at count * 300. Default count = 3.
    Cases:
    - 11 players, 6 innings, valid P/C -> returns 3 distinct valid lineups
    - 10 players, tight constraints -> returns 1-3 lineups (whatever is achievable)
    - Impossible constraints -> returns [] (empty array)

    **Test cases:**
    - preValidate: 8 players returns error, valid 11-player input returns []
    - preValidate: absent pitcher returns error
    - preValidate: same player P+C same inning returns error
    - generateLineup: 11 players / 6 innings -> valid=true, no errors
    - generateLineup: 11 players / 5 innings -> valid=true, no errors
    - generateLineup: 10 players / 6 innings -> valid=true (tight but solvable)
    - generateLineup: respects pitcher pre-assignments (check lineup[inn].P === assignedId)
    - generateLineup: respects catcher pre-assignments
    - generateLineup: respects position blocks (blocked player never appears at blocked position)
    - generateLineup: no consecutive bench in result
    - generateLineup: 2+ infield positions by inning 4 for every player
    - generateLineup: no same position consecutive innings (except P/C)
    - generateMultipleLineups: returns 3 distinct lineups for standard 11-player input
    - generateMultipleLineups: lineups are meaningfully different (not just outfield swaps)

    **IMPORTANT implementation notes:**
    - Use Fisher-Yates shuffle (not Math.random sort which has bias)
    - The infield minimum check counts P and C as infield positions (per INFIELD_POSITIONS definition)
    - When P/C are not pre-assigned for an inning, the generator picks from available players
    - All loops use input.innings (not hardcoded 5)
    - Position blocks: if positionBlocks[playerId] includes a position, that player must never be assigned there
  </behavior>
  <implementation>
    Adapt the reference algorithm (C:\repos\baseball-coach\src\App.tsx lines 219-483) following the strategy documented in 02-RESEARCH.md. Rewrite as clean pure functions with:
    - No console.log
    - No React state
    - No eslint-disable comments
    - Fisher-Yates shuffle instead of Math.random sort
    - Player IDs instead of names
    - Parameterized innings count
    - Position block checking at every assignment step
    - Structured return types
  </implementation>
</feature>

<verification>
- `npx vitest run src/logic/lineup-generator.test.ts` passes all tests
- Generation succeeds for 10, 11, and 12 player rosters
- Generation succeeds for both 5 and 6 innings
- Pre-validation catches all documented impossible inputs
- No React imports in src/logic/lineup-generator.ts
- `npm run build` passes with zero TypeScript errors
</verification>

<success_criteria>
- preValidate() catches: too few players, absent P/C, same-player P+C, unfillable positions from blocks
- generateLineup() produces valid lineup for 10-12 player rosters with 5 and 6 innings
- Generated lineups pass all 8 validation rules from 02-01
- generateMultipleLineups() returns 3 distinct valid lineups for standard inputs
- Position blocks are respected in all generated lineups
- P/C pre-assignments are honored exactly
- Zero React dependencies in the file
</success_criteria>

<output>
After completion, create `.planning/phases/02-lineup-engine/02-02-SUMMARY.md`
</output>
