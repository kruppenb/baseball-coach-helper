---
phase: 02-lineup-engine
plan: 05
type: execute
wave: 4
depends_on: ["02-03", "02-04"]
files_modified:
  - src/components/lineup/LineupOptions.tsx
  - src/components/lineup/LineupOptions.module.css
  - src/components/lineup/LineupPage.tsx
  - src/components/lineup/LineupPage.module.css
  - src/components/app-shell/AppShell.tsx
autonomous: false

must_haves:
  truths:
    - "Lineup tab is enabled in the tab bar when 9+ players are marked present"
    - "Lineup tab is disabled when fewer than 9 players are present"
    - "Coach can see pre-assignment section, position blocks, and generate button on Lineup page"
    - "Coach clicks Generate and sees 1-3 lineup option cards"
    - "Coach can select a lineup option and see it expanded in the full grid"
    - "Validation errors appear below the selected lineup grid"
    - "Full flow works: assign P/C -> set blocks -> generate -> pick option -> see grid"
  artifacts:
    - path: "src/components/lineup/LineupOptions.tsx"
      provides: "Selectable lineup option cards for choosing among generated lineups"
      exports: ["LineupOptions"]
      min_lines: 30
    - path: "src/components/lineup/LineupPage.tsx"
      provides: "Container page composing all lineup sub-components with useLineup hook"
      exports: ["LineupPage"]
      min_lines: 60
    - path: "src/components/app-shell/AppShell.tsx"
      provides: "Updated shell with enabled Lineup tab and conditional LineupPage rendering"
      contains: "LineupPage"
  key_links:
    - from: "src/components/lineup/LineupPage.tsx"
      to: "src/hooks/useLineup.ts"
      via: "consumes useLineup hook for all state and actions"
      pattern: "import.*useLineup.*from.*hooks/useLineup"
    - from: "src/components/lineup/LineupPage.tsx"
      to: "src/components/lineup/PreAssignments.tsx"
      via: "renders PreAssignments with hook data"
      pattern: "PreAssignments"
    - from: "src/components/lineup/LineupPage.tsx"
      to: "src/components/lineup/PositionBlocks.tsx"
      via: "renders PositionBlocks with hook data"
      pattern: "PositionBlocks"
    - from: "src/components/lineup/LineupPage.tsx"
      to: "src/components/lineup/LineupGrid.tsx"
      via: "renders LineupGrid for selected lineup"
      pattern: "LineupGrid"
    - from: "src/components/lineup/LineupPage.tsx"
      to: "src/components/lineup/LineupOptions.tsx"
      via: "renders LineupOptions for selection"
      pattern: "LineupOptions"
    - from: "src/components/lineup/LineupPage.tsx"
      to: "src/components/lineup/ValidationPanel.tsx"
      via: "renders ValidationPanel with errors"
      pattern: "ValidationPanel"
    - from: "src/components/app-shell/AppShell.tsx"
      to: "src/components/lineup/LineupPage.tsx"
      via: "renders LineupPage in lineup tab panel"
      pattern: "LineupPage"
    - from: "src/components/app-shell/AppShell.tsx"
      to: "src/hooks/useRoster.ts"
      via: "checks presentCount >= 9 to enable lineup tab"
      pattern: "useRoster|presentCount"
---

<objective>
Wire all lineup components into a complete LineupPage container, add lineup option selection cards, and enable the Lineup tab in the app shell. This is the integration plan that brings Phase 2 together.

Purpose: Everything built in Plans 02-01 through 02-04 must be composed into a working page the coach can use end-to-end. The LineupPage is the container that wires the useLineup hook to all presentational components. The AppShell update enables the tab dynamically based on roster state.

Output: LineupOptions.tsx (option cards for choosing lineups), LineupPage.tsx (page container), updated AppShell.tsx with enabled Lineup tab.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-lineup-engine/02-RESEARCH.md

# All components and hooks from earlier plans
@src/hooks/useLineup.ts
@src/hooks/useRoster.ts
@src/components/lineup/PreAssignments.tsx
@src/components/lineup/PositionBlocks.tsx
@src/components/lineup/LineupGrid.tsx
@src/components/lineup/ValidationPanel.tsx
@src/components/app-shell/AppShell.tsx
@src/types/index.ts
@src/styles/tokens.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build LineupOptions cards and LineupPage container</name>
  <files>src/components/lineup/LineupOptions.tsx, src/components/lineup/LineupOptions.module.css, src/components/lineup/LineupPage.tsx, src/components/lineup/LineupPage.module.css</files>
  <action>
    **LineupOptions.tsx -- Selectable lineup option cards:**

    Props interface:
    ```typescript
    interface LineupOptionsProps {
      lineups: Lineup[];
      selectedIndex: number | null;
      innings: number;
      players: Player[];
      onSelect: (index: number) => void;
    }
    ```

    Component structure:
    - If lineups is empty, render nothing (return null)
    - Heading: "Generated Lineups" (h3)
    - Subtitle: "{lineups.length} option(s) found. Tap to select."
    - Horizontal scrollable container with lineup cards:
      - Each card is a `<button>` with:
        - "Option {index + 1}" heading
        - Compact summary: who sits in each inning (e.g., "Bench: Inn 1: Jake R, Inn 2: Alex M, ...")
        - Selected state: .card + .cardSelected class
        - aria-pressed={selectedIndex === index}
        - onClick -> onSelect(index)
    - Helper function to generate bench summary per lineup for the compact card view:
      - For each inning, find players not assigned to any position
      - Display as: "Inn {N}: {name}" per line (truncated if needed)
    - Keep cards compact -- the full grid is shown separately for the selected lineup

    **LineupOptions.module.css:**
    - .options: padding --space-md 0
    - .heading: font-size --font-size-lg, font-weight 600, margin-bottom --space-xs
    - .subtitle: font-size --font-size-sm, color --color-text-muted, margin-bottom --space-md
    - .cardContainer: display flex, gap --space-md, overflow-x auto, padding-bottom --space-sm. Scroll snap: scroll-snap-type x mandatory.
    - .card: flex 0 0 auto, width 200px, padding --space-md, border 2px solid --color-border, border-radius --radius-md, background white, cursor pointer, text-align left, scroll-snap-align start. On hover: border-color --color-primary.
    - .cardSelected: border-color --color-primary, background-color rgba(13, 110, 253, 0.05), box-shadow 0 0 0 1px --color-primary.
    - .cardTitle: font-weight 600, font-size --font-size-base, margin-bottom --space-sm
    - .benchSummary: font-size --font-size-sm, color --color-text-muted, line-height 1.4

    **LineupPage.tsx -- Container page wiring everything together:**

    This is the main page component that:
    1. Calls useLineup() hook to get all state and actions
    2. Uses useRoster() to get the player list (for name resolution in grid display)
    3. Composes all sub-components with proper props

    Page layout (top to bottom):
    1. Page title: "Lineup" (h2)
    2. If presentPlayers.length < 9:
       - Show message: "Need at least 9 present players to generate a lineup. Currently {presentPlayers.length} present. Mark players as present on the Game Setup tab."
       - Stop here (don't render the rest)
    3. PreAssignments component:
       - innings={innings}
       - presentPlayers={presentPlayers}
       - pitcherAssignments={state.pitcherAssignments}
       - catcherAssignments={state.catcherAssignments}
       - onPitcherChange={setPitcher}
       - onCatcherChange={setCatcher}
    4. PositionBlocks component:
       - presentPlayers={presentPlayers}
       - positionBlocks={state.positionBlocks}
       - onToggleBlock={togglePositionBlock}
    5. ValidationPanel for pre-assignment errors (real-time):
       - errors={[]}
       - preErrors={preAssignmentErrors}
    6. Generate button section:
       - Primary styled button: "Generate Lineups"
       - On click: call generate(). If unsuccessful, errors are shown via ValidationPanel (the generate function updates state, and preErrors from the hook will reflect them).
       - Button disabled when presentPlayers.length < 9 (redundant safety since we show the message above, but good practice)
       - If generatedLineups exist, show a secondary "Regenerate" label instead, and add a "Clear" text button next to it
    7. LineupOptions component (if generatedLineups.length > 0):
       - lineups={state.generatedLineups}
       - selectedIndex={state.selectedLineupIndex}
       - innings={innings}
       - players={presentPlayers}
       - onSelect={selectLineup}
    8. LineupGrid component (if selectedLineup exists):
       - lineup={selectedLineup}
       - innings={innings}
       - players={presentPlayers} (using all players from useRoster for name resolution)
       - errors={validationErrors}
    9. ValidationPanel for post-generation validation errors (if selectedLineup exists):
       - errors={validationErrors}
       - preErrors={[]}

    **State for generation feedback:**
    - Add local useState for generation status message (e.g., "Generated 3 options!" or "Could not generate any valid lineups."). Clear on next generate.
    - Show this message between the Generate button and LineupOptions.

    **LineupPage.module.css:**
    - .page: padding --space-lg, display flex, flex-direction column, gap --space-lg
    - .pageTitle: font-size --font-size-2xl, font-weight 700
    - .minPlayersMessage: background --color-surface, padding --space-lg, border-radius --radius-md, text-align center, color --color-text-muted, font-size --font-size-base
    - .generateSection: display flex, align-items center, gap --space-md, flex-wrap wrap
    - .generateButton: background --color-primary, color white, border none, padding --space-md --space-xl, border-radius --radius-md, font-size --font-size-lg, font-weight 600, cursor pointer, min-height --min-tap-size. On hover: filter brightness(0.9). Disabled: opacity 0.5 cursor not-allowed.
    - .clearButton: background transparent, border none, color --color-text-muted, cursor pointer, font-size --font-size-sm, text-decoration underline. On hover: color --color-text.
    - .statusMessage: font-size --font-size-sm, color --color-text-muted
    - .section: border-top 1px solid --color-border, padding-top --space-lg (used to visually separate pre-assignments, blocks, and generated results)
  </action>
  <verify>
    - `npm run build` passes with zero TypeScript errors
    - LineupPage imports and renders all 5 sub-components (PreAssignments, PositionBlocks, LineupGrid, LineupOptions, ValidationPanel)
    - LineupPage uses useLineup hook (not re-implementing logic)
    - LineupPage shows minimum player message when < 9 present
    - Generate button calls useLineup().generate()
    - LineupOptions renders selectable cards
    - File structure follows Phase 1 conventions
  </verify>
  <done>LineupPage container composes all lineup components with proper data flow from useLineup hook. Generate button triggers lineup generation with feedback. Option cards allow selection. Full grid displays selected lineup with validation errors.</done>
</task>

<task type="auto">
  <name>Task 2: Enable Lineup tab in AppShell with dynamic enable/disable</name>
  <files>src/components/app-shell/AppShell.tsx</files>
  <action>
    Update AppShell.tsx to:

    1. Import LineupPage from '../lineup/LineupPage'
    2. Import useRoster hook to access presentCount for tab enable/disable logic
    3. Change the lineup tab from `disabled: true` to dynamically computed:
       - Call useRoster() in AppShell (it's already imported indirectly via other pages, but now AppShell needs direct access for the tab disabled state)
       - Set lineup tab disabled: `presentCount < 9`
       - The tabs array should be computed (not static const) since disabled is now dynamic:
         ```typescript
         const { presentCount } = useRoster();
         const tabs = [
           { id: 'roster', label: 'Roster' },
           { id: 'game-setup', label: 'Game Setup' },
           { id: 'lineup', label: 'Lineup', disabled: presentCount < 9 },
           { id: 'history', label: 'History', disabled: true },
         ];
         ```
    4. Add the lineup tab panel rendering (following the existing pattern for roster and game-setup):
       ```tsx
       {activeTab === 'lineup' && (
         <div role="tabpanel" id="panel-lineup" aria-labelledby="tab-lineup">
           <LineupPage />
         </div>
       )}
       ```
    5. If the active tab is 'lineup' and the tab becomes disabled (user switches back to Game Setup and marks players absent), automatically switch activeTab back to 'game-setup'. Use useEffect:
       ```typescript
       useEffect(() => {
         if (activeTab === 'lineup' && presentCount < 9) {
           setActiveTab('game-setup');
         }
       }, [activeTab, presentCount]);
       ```

    **Do NOT:**
    - Remove the history tab disabled state -- that stays disabled until Phase 4
    - Change any other tab behavior
    - Move any existing tab panel rendering code
  </action>
  <verify>
    - `npm run build` passes with zero TypeScript errors
    - Lineup tab enabled when presentCount >= 9
    - Lineup tab disabled when presentCount < 9
    - Clicking Lineup tab renders LineupPage
    - Reducing present players below 9 while on Lineup tab redirects to Game Setup
    - History tab remains disabled
    - Roster and Game Setup tabs still work correctly
  </verify>
  <done>Lineup tab dynamically enables when 9+ players are present. Tab renders LineupPage with full lineup generation flow. Tab auto-disables and redirects if player count drops below 9.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete lineup generation flow</name>
  <files>src/components/app-shell/AppShell.tsx</files>
  <action>
    Human verification checkpoint. No code changes -- verify the complete Phase 2 lineup engine works end-to-end.

    Full Phase 2 lineup engine: pre-assignment UI, position blocking, constraint-based generation algorithm, multiple lineup options, lineup grid display, and validation error panel. All wired into a new Lineup tab.

    Verification steps:
    1. Start dev server: `npm run dev` (port 5180)
    2. Visit http://localhost:5180
    3. Go to Roster tab -- add 11 players (e.g., "Jake R", "Alex M", "Sam T", "Ben K", "Chris L", "David P", "Ethan W", "Frank G", "Grace H", "Henry J", "Ian B")
    4. Go to Game Setup tab -- verify all 11 are present. Confirm innings is set to 6.
    5. Note: The Lineup tab should now be enabled (no longer grayed out).
    6. Click Lineup tab.
    7. Pre-assignment test: Assign a pitcher for innings 1-2 (e.g., Jake R) and a different pitcher for innings 3-6. Assign catchers similarly. Leave some innings unassigned to test optional behavior.
    8. Position blocks test: Expand "Position Blocks" section. Block one player from 3B (tap the 3B chip -- it should turn red with line-through). Verify the block count updates in the summary.
    9. Generation test: Click "Generate Lineups". Should see 1-3 option cards appear.
    10. Option selection: Tap different option cards. The full lineup grid below should change to show the selected option.
    11. Grid verification: Check that the grid shows 9 positions as rows, innings as columns, and player names in cells. Verify a "Bench" row at the bottom showing who sits each inning.
    12. Constraint spot-check: Look at the generated lineup -- no consecutive bench, no consecutive same position (except P/C), pre-assigned P/C in correct innings, blocked positions respected.
    13. Tab switch test: Switch to Roster tab, then back to Lineup tab. All pre-assignments, blocks, and generated lineups should still be there (localStorage persistence).
    14. Edge case: Go to Game Setup, mark players absent until only 8 are present. The Lineup tab should become disabled and you should be redirected to Game Setup.
  </action>
  <verify>User confirms the complete flow works or reports issues.</verify>
  <done>User types "approved" confirming Phase 2 works end-to-end, or describes issues for fix.</done>
</task>

</tasks>

<verification>
- `npm run build` passes with zero TypeScript errors
- Full end-to-end flow: Roster -> Game Setup -> Lineup -> Generate -> Select -> View
- Pre-assignments persist across tab switches
- Position blocks persist across tab switches
- Generated lineups display correctly in grid
- Validation errors show in plain English with player names
- Tab enables/disables dynamically based on present player count
- All Phase 2 requirements covered: LINE-01 through LINE-08, VALD-01, VALD-02
</verification>

<success_criteria>
- Coach can pre-assign P/C, block positions, generate lineups, and select from options
- Generated lineups respect all 6 fairness constraints
- Validation errors are coach-friendly with player names
- Full lineup state persists in localStorage
- Lineup tab enables at 9+ present players
- UI follows Phase 1 visual conventions (CSS Modules, design tokens)
</success_criteria>

<output>
After completion, create `.planning/phases/02-lineup-engine/02-05-SUMMARY.md`
</output>
