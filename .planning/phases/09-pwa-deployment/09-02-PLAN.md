---
phase: 09-pwa-deployment
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - .github/workflows/azure-static-web-apps.yml
autonomous: false
user_setup:
  - service: azure-static-web-apps
    why: "SWA resource must exist for deployment; deployment token needed as GitHub secret"
    env_vars:
      - name: AZURE_STATIC_WEB_APPS_API_TOKEN
        source: "Azure Portal -> Static Web Apps -> [your app] -> Manage deployment token -> Copy"
    dashboard_config:
      - task: "Create Azure Static Web Apps resource (Standard plan)"
        location: "Azure Portal -> Create a resource -> Static Web App -> Standard plan"
      - task: "Add deployment token to GitHub repository secrets"
        location: "GitHub -> Settings -> Secrets and variables -> Actions -> New repository secret -> Name: AZURE_STATIC_WEB_APPS_API_TOKEN"

must_haves:
  truths:
    - "Pushing to main triggers a GitHub Actions workflow that builds and deploys to Azure SWA"
    - "PRs against main get preview builds deployed automatically"
    - "Closing a PR cleans up the preview environment"
    - "The workflow builds both the frontend (Vite) and API (Azure Functions in api/)"
  artifacts:
    - path: ".github/workflows/azure-static-web-apps.yml"
      provides: "CI/CD pipeline for Azure Static Web Apps"
      contains: "Azure/static-web-apps-deploy@v1"
  key_links:
    - from: ".github/workflows/azure-static-web-apps.yml"
      to: "Azure Static Web Apps"
      via: "AZURE_STATIC_WEB_APPS_API_TOKEN secret authenticates deployment"
      pattern: "azure_static_web_apps_api_token.*AZURE_STATIC_WEB_APPS_API_TOKEN"
    - from: ".github/workflows/azure-static-web-apps.yml"
      to: "dist/ and api/"
      via: "app_location, api_location, output_location configure what gets deployed"
      pattern: "output_location.*dist"
---

<objective>
Create the GitHub Actions CI/CD workflow for Azure Static Web Apps deployment, so pushing to main automatically builds and deploys the app.

Purpose: Satisfies DEPL-01 -- app is served from Azure Static Web Apps Standard plan with CI/CD deploying from GitHub on push. The workflow handles both the Vite frontend build and the Azure Functions API build.

Output: GitHub Actions workflow file at `.github/workflows/azure-static-web-apps.yml`, verified build in CI format.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-pwa-deployment/09-RESEARCH.md
@.planning/phases/09-pwa-deployment/09-01-SUMMARY.md

@package.json
@api/package.json
@staticwebapp.config.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions workflow for Azure Static Web Apps CI/CD</name>
  <files>.github/workflows/azure-static-web-apps.yml</files>
  <action>
    Create the directory `.github/workflows/` and add the workflow file `azure-static-web-apps.yml`.

    The workflow has two jobs:

    **Job 1: build_and_deploy**
    - Triggers on: push to `main`, PR opened/synchronize/reopened against `main`
    - Condition: runs on push OR on PR events that are NOT "closed"
    - Runs on: `ubuntu-latest`
    - Steps:
      1. `actions/checkout@v4` with `submodules: true`
      2. `Azure/static-web-apps-deploy@v1` with:
         - `azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}`
         - `repo_token: ${{ secrets.GITHUB_TOKEN }}`
         - `action: "upload"`
         - `app_location: "/"` -- repo root contains package.json and vite.config.ts
         - `api_location: "api"` -- Azure Functions project
         - `output_location: "dist"` -- Vite build output (relative to app_location, NO leading slash)

    **Job 2: close_pull_request**
    - Triggers only on PR close events against `main`
    - Condition: `github.event_name == 'pull_request' && github.event.action == 'closed'`
    - Steps:
      1. `Azure/static-web-apps-deploy@v1` with `action: "close"` and the API token

    **Permissions block** at workflow level:
    ```yaml
    permissions:
      issues: write
      contents: read
      pull-requests: write
    ```

    IMPORTANT: `output_location` must be `"dist"` (no leading slash). This is relative to `app_location`. Using `"/dist"` would look for `//dist` and deploy an empty site.
  </action>
  <verify>
    1. File exists: `ls .github/workflows/azure-static-web-apps.yml`
    2. Validate YAML syntax (no parse errors): `node -e "const yaml = require('yaml'); const fs = require('fs'); yaml.parse(fs.readFileSync('.github/workflows/azure-static-web-apps.yml', 'utf8')); console.log('YAML valid')"` -- if yaml package not available, use: `npx yaml-cli@1 validate .github/workflows/azure-static-web-apps.yml` or just visually confirm structure
    3. Verify key values: grep for `output_location: "dist"`, `api_location: "api"`, `app_location: "/"`
    4. Run the full build locally one more time to confirm everything from Plan 01 + this plan works together: `npm run build && npm test`
  </verify>
  <done>GitHub Actions workflow file exists at .github/workflows/azure-static-web-apps.yml with correct SWA deployment configuration, build and test pass</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify PWA + deployment readiness</name>
  <what-built>
    Complete PWA + CI/CD setup across both plans:
    - vite-plugin-pwa configured with offline caching, auto-update, auth/API route exclusion
    - PWA icons created (192x192, 512x512, 180x180 apple-touch-icon)
    - index.html updated with PWA meta tags (theme-color, description, apple-touch-icon)
    - staticwebapp.config.json updated with SW file excludes
    - GitHub Actions workflow for Azure SWA CI/CD deployment
  </what-built>
  <how-to-verify>
    1. Run `npm run build` and verify it completes without errors
    2. Run `npx serve dist` (or `npm run preview`) to serve the production build locally
    3. Open Chrome DevTools -> Application tab:
       - Check "Manifest" section: should show app name "Lineup Builder", icons, theme color
       - Check "Service Workers" section: should show a registered service worker
    4. In Chrome address bar, look for the install icon (+ in a box) or check DevTools -> Application -> Manifest for installability status
    5. Review `.github/workflows/azure-static-web-apps.yml` -- confirm it looks correct for your repo

    **To complete deployment (manual steps -- not automated):**
    - Create Azure SWA resource (Standard plan) in Azure Portal if not already done
    - Copy the deployment token from Azure Portal -> Static Web Apps -> [app] -> Manage deployment token
    - Add it as `AZURE_STATIC_WEB_APPS_API_TOKEN` in GitHub -> Settings -> Secrets -> Actions
    - Push to main to trigger first deployment
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 9, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After both tasks complete:
1. `.github/workflows/azure-static-web-apps.yml` exists with correct SWA deploy configuration
2. Workflow triggers on push to main and PRs against main
3. `output_location` is `"dist"` (no leading slash)
4. `api_location` is `"api"` (matches existing Azure Functions project)
5. Full `npm run build && npm test` passes
6. User has verified PWA manifest and service worker registration in browser DevTools
</verification>

<success_criteria>
- GitHub Actions workflow file correctly configured for Azure SWA CI/CD
- Pushing to main will trigger build + deploy (once AZURE_STATIC_WEB_APPS_API_TOKEN secret is set)
- PRs get preview deployments; closing PR cleans up preview
- Full build succeeds locally with PWA assets generated
- User has visually verified PWA installability in browser
</success_criteria>

<output>
After completion, create `.planning/phases/09-pwa-deployment/09-02-SUMMARY.md`
</output>
