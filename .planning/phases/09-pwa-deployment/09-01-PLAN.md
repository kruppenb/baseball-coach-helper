---
phase: 09-pwa-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vite.config.ts
  - index.html
  - staticwebapp.config.json
  - public/pwa-192x192.png
  - public/pwa-512x512.png
  - public/apple-touch-icon.png
  - public/favicon.ico
autonomous: true

must_haves:
  truths:
    - "App build produces a service worker (sw.js) and web manifest in dist/"
    - "Service worker precaches all static assets (JS, CSS, HTML, images)"
    - "Service worker does NOT intercept /.auth or /api routes"
    - "index.html has PWA meta tags (theme-color, description, apple-touch-icon)"
    - "PWA icons exist at all required sizes (192, 512, 180)"
  artifacts:
    - path: "vite.config.ts"
      provides: "VitePWA plugin configuration with generateSW strategy"
      contains: "VitePWA"
    - path: "index.html"
      provides: "PWA meta tags and apple-touch-icon link"
      contains: "theme-color"
    - path: "staticwebapp.config.json"
      provides: "Navigation fallback excludes for SW files"
      contains: "sw.js"
    - path: "public/pwa-192x192.png"
      provides: "192x192 app icon"
    - path: "public/pwa-512x512.png"
      provides: "512x512 app icon"
    - path: "public/apple-touch-icon.png"
      provides: "180x180 iOS home screen icon"
    - path: "public/favicon.ico"
      provides: "Browser tab favicon"
  key_links:
    - from: "vite.config.ts"
      to: "dist/sw.js"
      via: "VitePWA generateSW builds service worker at build time"
      pattern: "VitePWA.*registerType.*autoUpdate"
    - from: "vite.config.ts"
      to: "dist/manifest.webmanifest"
      via: "VitePWA manifest option generates webmanifest"
      pattern: "manifest.*name.*Lineup Builder"
    - from: "vite.config.ts workbox.navigateFallbackDenylist"
      to: "/.auth and /api routes"
      via: "Regex denylist prevents SW from intercepting auth/API"
      pattern: "navigateFallbackDenylist.*\\.auth.*api"
---

<objective>
Configure the app as a Progressive Web App using vite-plugin-pwa so it is installable on mobile devices and works offline at the baseball field.

Purpose: Satisfies DEPL-02 -- coach can tap "Add to Home Screen" and the app works without network after initial load. The service worker precaches the entire app shell so all lineup generation works offline (API sync already handled by the localStorage-first sync engine from Phase 7).

Output: Updated vite.config.ts with VitePWA plugin, PWA icons in public/, updated index.html with meta tags, updated staticwebapp.config.json with SW file excludes.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-pwa-deployment/09-RESEARCH.md

@vite.config.ts
@index.html
@staticwebapp.config.json
@package.json
@src/styles/tokens.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install vite-plugin-pwa and configure VitePWA in vite.config.ts</name>
  <files>vite.config.ts, package.json</files>
  <action>
    Install vite-plugin-pwa as a dev dependency:
    ```
    npm install -D vite-plugin-pwa
    ```

    Update `vite.config.ts` to add the VitePWA plugin. Keep the existing `react()` plugin and `server` config intact. Add VitePWA after react():

    ```typescript
    import { VitePWA } from 'vite-plugin-pwa'
    ```

    VitePWA configuration:
    - `registerType: 'autoUpdate'` -- auto-activate new service worker on deploy
    - `workbox.globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}']` -- precache all static assets
    - `workbox.navigateFallbackDenylist: [/^\/\.auth/, /^\/api/]` -- CRITICAL: exclude auth and API routes from SW interception (auth flows break otherwise, API requests are user-specific and auth-gated)
    - `workbox.cleanupOutdatedCaches: true` -- remove stale precache entries after updates
    - `workbox.clientsClaim: true` -- new SW takes control of existing tabs immediately
    - `workbox.skipWaiting: true` -- new SW activates immediately without waiting for old tabs to close
    - `manifest.name: 'Lineup Builder'`
    - `manifest.short_name: 'Lineup'`
    - `manifest.description: 'Baseball lineup builder for youth coaches'`
    - `manifest.theme_color: '#0d6efd'` -- matches app's --color-primary from tokens.css (NOT the green #1a5d1a suggested in research)
    - `manifest.background_color: '#ffffff'` -- matches app's --color-bg
    - `manifest.display: 'standalone'`
    - `manifest.scope: '/'`
    - `manifest.start_url: '/'`
    - `manifest.icons`: array with three entries:
      - `{ src: 'pwa-192x192.png', sizes: '192x192', type: 'image/png' }`
      - `{ src: 'pwa-512x512.png', sizes: '512x512', type: 'image/png' }`
      - `{ src: 'pwa-512x512.png', sizes: '512x512', type: 'image/png', purpose: 'maskable' }`

    Do NOT change the existing server.port or proxy configuration.
  </action>
  <verify>
    Run `npm run build` -- should complete without errors. Check that `dist/sw.js` and `dist/manifest.webmanifest` exist after build:
    ```
    ls dist/sw.js dist/manifest.webmanifest
    ```
  </verify>
  <done>vite-plugin-pwa installed, vite.config.ts has VitePWA plugin, `npm run build` produces sw.js and manifest.webmanifest in dist/</done>
</task>

<task type="auto">
  <name>Task 2: Create PWA icons, update index.html meta tags, update SWA config</name>
  <files>public/pwa-192x192.png, public/pwa-512x512.png, public/apple-touch-icon.png, public/favicon.ico, index.html, staticwebapp.config.json</files>
  <action>
    **Create placeholder PWA icons:**
    Generate simple placeholder PNG icons programmatically using a Node.js script. The icons should be a solid blue (#0d6efd) background with white "LB" text centered. Create a temporary script (delete after use) that generates the PNGs.

    Approach: Use an inline Node script with the `canvas` package if available, OR create minimal valid PNG files. The simplest reliable approach is to create SVGs and convert them, but since we need actual PNGs for PWA compliance, use this approach:

    Create a small Node script that writes valid PNG buffers using raw PNG encoding (no external deps). The icons are simple solid-color squares:
    - `public/pwa-192x192.png` -- 192x192 blue square
    - `public/pwa-512x512.png` -- 512x512 blue square
    - `public/apple-touch-icon.png` -- 180x180 blue square
    - `public/favicon.ico` -- keep simple, can be a small 32x32 PNG renamed to .ico or generate from the SVG

    If raw PNG generation is too complex without dependencies, use this alternative: create SVG files in public/ and reference those in the manifest instead of PNGs. Change the manifest icons to use `.svg` type and `type: 'image/svg+xml'`. SVGs are valid PWA icons in modern browsers.

    PREFERRED approach (simplest, no deps): Create a single `public/pwa-icon.svg` file with the baseball-themed placeholder (blue circle with "LB" in white), then reference it in the manifest as a single SVG icon. Also keep the SVG as `public/favicon.svg` and update index.html to use it.

    Actually, the most reliable approach: install the `sharp` package temporarily to generate PNGs from an SVG, then uninstall. OR just create SVG icons and use both SVG (for manifest) and reference them appropriately.

    FINAL DECISION -- use SVG icons with PNG fallbacks generated via a temp script:
    1. Create `public/pwa-icon.svg` -- a simple baseball-themed SVG (blue rounded square with white "LB" text)
    2. Use a temp Node.js script with `sharp` to convert SVG to required PNG sizes, then uninstall sharp
    3. If sharp install fails or is impractical, use the SVG directly in manifest (works in Chrome 107+, Firefox 120+, Safari 17.4+) AND create a minimal 1-color PNG for maximum compatibility

    The executor should try the sharp approach first. If it fails, fall back to SVG-only manifest icons.

    **Update index.html:**
    Replace the current `<head>` content with:
    - Keep `<meta charset="UTF-8" />`
    - Keep `<meta name="viewport" content="width=device-width, initial-scale=1.0" />`
    - ADD `<meta name="description" content="Baseball lineup builder for youth coaches" />`
    - ADD `<meta name="theme-color" content="#0d6efd" />`
    - CHANGE favicon link from `<link rel="icon" type="image/svg+xml" href="/vite.svg" />` to `<link rel="icon" href="/favicon.ico" />` (or `/favicon.svg` if using SVG approach)
    - ADD `<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />`
    - Keep `<title>Lineup Builder</title>`
    - Keep the `<body>` unchanged

    **Update staticwebapp.config.json:**
    In the `navigationFallback.exclude` array, add entries for the service worker files that should NOT be rewritten to index.html:
    - Change from: `["/assets/*"]`
    - Change to: `["/assets/*", "/sw.js", "/workbox-*.js"]`

    Do NOT change any other part of staticwebapp.config.json (routes, responseOverrides, platform).

    **Cleanup:**
    Delete the old `public/vite.svg` file if it exists (no longer referenced).
    Delete any temporary icon generation scripts.
  </action>
  <verify>
    1. Verify icon files exist: `ls public/pwa-192x192.png public/pwa-512x512.png public/apple-touch-icon.png`
    2. Verify index.html has meta tags: `grep "theme-color" index.html && grep "apple-touch-icon" index.html && grep "description" index.html`
    3. Verify staticwebapp.config.json has SW excludes: `grep "sw.js" staticwebapp.config.json`
    4. Run full build: `npm run build` succeeds
    5. Run tests: `npm test` passes (no regressions)
  </verify>
  <done>PWA icons created in public/, index.html has all required PWA meta tags, staticwebapp.config.json excludes service worker files from navigation fallback, build passes, tests pass</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` produces clean output with no errors
2. `dist/sw.js` exists (service worker generated)
3. `dist/manifest.webmanifest` exists and contains correct app name, icons, theme_color
4. `dist/index.html` contains theme-color meta tag and apple-touch-icon link
5. `npm test` passes (no regressions from config changes)
6. `staticwebapp.config.json` excludes sw.js and workbox files from fallback
</verification>

<success_criteria>
- vite-plugin-pwa installed and configured with generateSW + autoUpdate
- Service worker excludes /.auth and /api via navigateFallbackDenylist
- PWA icons exist at 192x192, 512x512, and 180x180 sizes
- index.html has description, theme-color, and apple-touch-icon meta tags
- staticwebapp.config.json excludes SW files from navigation fallback
- Build produces sw.js and manifest.webmanifest
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-pwa-deployment/09-01-SUMMARY.md`
</output>
