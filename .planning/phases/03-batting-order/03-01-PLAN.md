---
phase: 03-batting-order
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/types/index.ts
  - src/logic/batting-order.ts
  - src/logic/batting-order.test.ts
autonomous: true

must_haves:
  truths:
    - "getBand correctly categorizes batting positions into top/middle/bottom bands"
    - "calculateBandCounts tallies historical band appearances for present players only"
    - "generateBattingOrder produces a shuffled order when no history exists"
    - "generateBattingOrder rotates players through bands based on history (top-heavy players move down)"
    - "Deleted players in history are silently ignored during band calculation"
    - "All present players appear exactly once in the generated order"
  artifacts:
    - path: "src/types/index.ts"
      provides: "BattingBand, BattingHistoryEntry, BattingOrderState types"
      contains: "BattingBand"
    - path: "src/logic/batting-order.ts"
      provides: "Pure batting order generation algorithm"
      exports: ["getBand", "calculateBandCounts", "generateBattingOrder"]
    - path: "src/logic/batting-order.test.ts"
      provides: "Unit tests for batting order logic"
      min_lines: 80
  key_links:
    - from: "src/logic/batting-order.ts"
      to: "src/types/index.ts"
      via: "imports BattingBand, BattingHistoryEntry, Player types"
      pattern: "import.*from.*types"
---

<objective>
Build the batting order generation algorithm with TDD: types, pure functions (getBand, calculateBandCounts, generateBattingOrder), and comprehensive tests.

Purpose: Establish the core batting order logic that generates fair, history-aware batting orders independent of the fielding lineup. This is the foundation for BATT-01 (all present players bat), BATT-02 (independent of fielding), and BATT-03 (cross-game fairness via three-band rotation).

Output: Typed batting order data structures, tested pure generation function, and test suite.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-batting-order/03-RESEARCH.md
@src/types/index.ts
@src/logic/lineup-generator.ts
@src/logic/lineup-generator.test.ts
</context>

<feature>
  <name>Batting Order Generation Algorithm</name>
  <files>src/types/index.ts, src/logic/batting-order.ts, src/logic/batting-order.test.ts</files>
  <behavior>
    Three-band fairness rotation for continuous batting order.

    getBand(position, totalPlayers) -> BattingBand:
      - For N players, Top = positions 0 to floor(N/3)-1, Middle = floor(N/3) to floor(2*N/3)-1, Bottom = floor(2*N/3) to N-1
      - getBand(0, 9) -> 'top'
      - getBand(3, 9) -> 'middle'
      - getBand(6, 9) -> 'bottom'
      - getBand(0, 10) -> 'top' (bands: 3/3/4)
      - getBand(9, 10) -> 'bottom'

    calculateBandCounts(presentPlayerIds, history) -> PlayerBandCounts[]:
      - Empty history -> all counts zero
      - Single game history -> counts reflect positions from that game
      - Player not in presentPlayerIds but in history -> silently skipped
      - Player in presentPlayerIds but not in history -> zero counts

    generateBattingOrder(presentPlayers, history) -> string[]:
      - Empty history -> returns shuffled array of all present player IDs (length = presentPlayers.length)
      - With history -> players with most top-band starts are pushed toward bottom (fairness rotation)
      - Every present player appears exactly once
      - No absent players appear
      - Result length equals presentPlayers.length
  </behavior>
  <implementation>
    RED-GREEN-REFACTOR cycle:

    RED phase:
    1. Add types to src/types/index.ts: BattingBand ('top'|'middle'|'bottom'), BattingHistoryEntry ({id, gameDate, order[]}), BattingOrderState ({currentOrder, isConfirmed}), PlayerBandCounts interface (in batting-order.ts, not exported from types).
    2. Create src/logic/batting-order.test.ts with tests:
       - getBand: band boundary calculations for 9, 10, 11, 12 players
       - calculateBandCounts: empty history, single game, multi-game, deleted player resilience, absent player exclusion
       - generateBattingOrder: no-history shuffle (all players present, correct length), history-based rotation (player with 3 top starts should NOT be in top band), every player appears exactly once
    3. Create src/logic/batting-order.ts with stub exports that throw "Not implemented" -- tests must FAIL.
    4. Run `npx vitest run src/logic/batting-order.test.ts` -- confirm all tests fail.

    GREEN phase:
    5. Implement getBand: floor(N/3) and floor(2*N/3) boundaries.
    6. Implement calculateBandCounts: initialize zero counts for present players, tally from history entries, skip unknown player IDs.
    7. Implement generateBattingOrder:
       - If history empty: Fisher-Yates shuffle of presentPlayers IDs (copy the shuffle function from lineup-generator.ts -- do NOT import from it to avoid coupling).
       - If history exists: calculate band counts, sort by fairness score (top - bottom, ascending -- players with fewer top starts get top positions), shuffle within each band for variety.
    8. Run tests -- all must pass.

    REFACTOR phase (if needed):
    9. Clean up any duplication, ensure types are tight, add JSDoc comments to exported functions.
    10. Run tests -- must still pass.

    IMPORTANT: The shuffle function must be duplicated in batting-order.ts (same Fisher-Yates as lineup-generator.ts). Do NOT extract to a shared utility -- keep modules independent per established pattern.
  </implementation>
</feature>

<verification>
- `npx vitest run src/logic/batting-order.test.ts` -- all tests pass
- `npx tsc --noEmit` -- no type errors
- Test coverage: getBand boundary cases, calculateBandCounts with 0/1/N history entries, generateBattingOrder with/without history, deleted player resilience
</verification>

<success_criteria>
- BattingBand, BattingHistoryEntry, BattingOrderState types exist in src/types/index.ts
- getBand, calculateBandCounts, generateBattingOrder exported from src/logic/batting-order.ts
- All tests pass with vitest
- No-history path returns shuffled order of correct length
- History path produces fairness-rotated order (top-heavy players move down)
- Deleted/absent players in history are silently ignored
</success_criteria>

<output>
After completion, create `.planning/phases/03-batting-order/03-01-SUMMARY.md`
</output>
