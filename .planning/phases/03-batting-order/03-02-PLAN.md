---
phase: 03-batting-order
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/hooks/useBattingOrder.ts
  - src/components/batting-order/BattingOrderList.tsx
  - src/components/batting-order/BattingOrderList.module.css
  - src/components/batting-order/BattingOrderSection.tsx
  - src/components/batting-order/BattingOrderSection.module.css
  - src/components/lineup/LineupPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can generate a batting order showing all present players in numbered list"
    - "User can confirm the batting order, saving it to history for future fairness rotation"
    - "Batting order section is visually separate from fielding lineup on the Lineup page"
    - "Batting order is independent of fielding assignments (BATT-02)"
    - "Re-generating after confirmation replaces the last history entry (no duplicate game entries)"
    - "Band labels (top/middle/bottom) are visible for each player in the batting order"
  artifacts:
    - path: "src/hooks/useBattingOrder.ts"
      provides: "Batting order state management hook with generate/confirm/clear"
      exports: ["useBattingOrder"]
    - path: "src/components/batting-order/BattingOrderList.tsx"
      provides: "Numbered list of players with band indicators"
      exports: ["BattingOrderList"]
    - path: "src/components/batting-order/BattingOrderSection.tsx"
      provides: "Container with generate/confirm buttons and status"
      exports: ["BattingOrderSection"]
    - path: "src/components/lineup/LineupPage.tsx"
      provides: "LineupPage with integrated BattingOrderSection below fielding grid"
      exports: ["LineupPage"]
  key_links:
    - from: "src/hooks/useBattingOrder.ts"
      to: "src/logic/batting-order.ts"
      via: "imports generateBattingOrder and calculateBandCounts"
      pattern: "import.*from.*logic/batting-order"
    - from: "src/hooks/useBattingOrder.ts"
      to: "localStorage"
      via: "useLocalStorage for battingOrderState and battingHistory keys"
      pattern: "useLocalStorage.*batting"
    - from: "src/components/batting-order/BattingOrderSection.tsx"
      to: "src/hooks/useBattingOrder.ts"
      via: "consumes useBattingOrder hook"
      pattern: "useBattingOrder"
    - from: "src/components/lineup/LineupPage.tsx"
      to: "src/components/batting-order/BattingOrderSection.tsx"
      via: "renders BattingOrderSection below fielding lineup"
      pattern: "BattingOrderSection"
---

<objective>
Build the useBattingOrder hook, presentational batting order UI components, and integrate the batting order section into LineupPage below the fielding grid.

Purpose: Deliver the complete batting order feature: generation, confirmation (saving to history for cross-game fairness), and display. The coach can generate a fair batting order, see it as a numbered list with band indicators, confirm it for history tracking, and see it alongside the fielding lineup.

Output: Working batting order hook, two presentational components, and updated LineupPage with batting order section.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-batting-order/03-RESEARCH.md
@.planning/phases/03-batting-order/03-01-SUMMARY.md
@src/types/index.ts
@src/hooks/useLocalStorage.ts
@src/hooks/useLineup.ts
@src/hooks/useRoster.ts
@src/components/lineup/LineupPage.tsx
@src/components/lineup/LineupPage.module.css
@src/styles/tokens.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: useBattingOrder hook and BattingOrderList component</name>
  <files>
    src/hooks/useBattingOrder.ts
    src/components/batting-order/BattingOrderList.tsx
    src/components/batting-order/BattingOrderList.module.css
  </files>
  <action>
    Create src/hooks/useBattingOrder.ts following the established hook-bridges-logic-to-UI pattern (same as useLineup.ts):
    - Uses useLocalStorage for two keys: 'battingOrderState' (BattingOrderState) and 'battingHistory' (BattingHistoryEntry[])
    - Uses useRoster() to get players, derives presentPlayers via useMemo (filter isPresent)
    - Exports: currentOrder (string[]|null), isConfirmed (boolean), history (BattingHistoryEntry[]), bandCounts (PlayerBandCounts[]), presentPlayers (Player[]), generate(), confirm(), clear()
    - generate(): calls generateBattingOrder(presentPlayers, history), sets currentOrder, sets isConfirmed to false
    - confirm(): if currentOrder exists and not already confirmed, creates BattingHistoryEntry with crypto.randomUUID() id, ISO date string gameDate, and currentOrder. Appends to history. Sets isConfirmed to true. If re-generating after confirmation (same session), the confirm should append a NEW entry (the coach explicitly chose to regenerate and re-confirm, which is valid for a different game).
    - clear(): resets battingOrderState to default (currentOrder: null, isConfirmed: false). Does NOT clear history.
    - bandCounts: useMemo calling calculateBandCounts with present player IDs and history

    Create src/components/batting-order/BattingOrderList.tsx as a pure presentational component (no hooks):
    - Props: order (string[]), players (Player[])
    - Renders an ordered list (ol) with numbered items
    - Each item shows: position number (1-based), player name (resolved from players array by ID), band label (top/middle/bottom via getBand)
    - Band label is displayed as a small colored badge: top = green-ish, middle = neutral, bottom = orange-ish. Use CSS custom properties defined in the module CSS.
    - If a player ID is not found in players array, show "Unknown" (defensive, should not happen)

    Create src/components/batting-order/BattingOrderList.module.css:
    - Follows established patterns: CSS Modules, CSS custom properties from tokens.css
    - .list: no default list padding, counter-reset not needed (using ol)
    - .item: flex row with gap, align-items center, min-height var(--min-tap-size) for readability, border-bottom 1px solid var(--color-border)
    - .position: fixed width (2ch), font-weight 600, color var(--color-text-muted), text-align right
    - .name: flex 1, font-size var(--font-size-base)
    - .bandLabel: font-size var(--font-size-sm), padding 2px 8px, border-radius var(--radius-sm)
    - .top: background #d1e7dd (success-bg), color #198754 (success)
    - .middle: background var(--color-surface), color var(--color-text-muted)
    - .bottom: background #fff3cd, color #856404
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - `npx vitest run` -- existing tests still pass (no regressions)
    - Manual check: useBattingOrder.ts imports from logic/batting-order and hooks/useLocalStorage correctly
  </verify>
  <done>
    useBattingOrder hook exposes generate/confirm/clear actions with localStorage persistence. BattingOrderList renders a numbered player list with band indicators. No regressions in existing tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: BattingOrderSection container and LineupPage integration</name>
  <files>
    src/components/batting-order/BattingOrderSection.tsx
    src/components/batting-order/BattingOrderSection.module.css
    src/components/lineup/LineupPage.tsx
  </files>
  <action>
    Create src/components/batting-order/BattingOrderSection.tsx:
    - This is the container component that consumes useBattingOrder() hook (same pattern as LineupPage consuming useLineup)
    - Renders a section with heading "Batting Order"
    - Shows a brief helper text: "All present players bat in continuous rotation, independent of fielding."
    - Generate button: labeled "Generate Batting Order" initially, changes to "Regenerate" after first generation
    - When currentOrder exists and is NOT confirmed: show BattingOrderList + "Confirm Order" button + "Clear" link
    - When currentOrder exists and IS confirmed: show BattingOrderList + "Batting order confirmed for this game" message + "Clear" link (to allow starting fresh for a new game)
    - When no currentOrder: show only Generate button
    - Status message state (useState) for generation feedback (same pattern as LineupPage's handleGenerate)
    - "Confirm Order" button has a distinct style: --color-success background, white text (use inline or module CSS)
    - "Clear" is a text link/button (same pattern as clearButton in LineupPage.module.css)

    Create src/components/batting-order/BattingOrderSection.module.css:
    - .section: padding var(--space-lg), follows page flow
    - .sectionTitle: font-size var(--font-size-xl), font-weight 700, margin-bottom var(--space-sm)
    - .helperText: font-size var(--font-size-sm), color var(--color-text-muted), margin-bottom var(--space-lg)
    - .actions: display flex, align-items center, gap var(--space-md), flex-wrap wrap, margin-bottom var(--space-md)
    - .generateButton: same style pattern as LineupPage .generateButton (--color-primary bg, white text, min-height --min-tap-size)
    - .confirmButton: background var(--color-success), color white, same sizing as generateButton
    - .confirmButton:hover: filter brightness(0.9)
    - .clearButton: same pattern as LineupPage .clearButton (transparent bg, underline, muted text)
    - .confirmedMessage: font-size var(--font-size-sm), color var(--color-success), font-weight 600

    Modify src/components/lineup/LineupPage.tsx:
    - Import BattingOrderSection from '../batting-order/BattingOrderSection'
    - Add BattingOrderSection BELOW the existing fielding lineup content, separated by a .section divider (same border-top pattern already used)
    - The BattingOrderSection should appear AFTER the validation panel at the bottom, inside the main content area (within the presentPlayers.length >= 9 branch)
    - It should render regardless of whether a fielding lineup has been generated (batting is independent per BATT-02)
    - Add the BattingOrderSection inside a div with className={styles.section} for consistent border-top separation
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx vitest run` -- all tests pass
    - Start dev server (`npx vite --port 5180`) and verify:
      1. Navigate to Lineup tab (need 9+ present players)
      2. "Batting Order" section visible below fielding content
      3. Click "Generate Batting Order" -- numbered list appears with band labels
      4. Click "Confirm Order" -- confirmed message appears
      5. Click "Clear" -- resets to generate state
      6. Batting order section works independently of fielding lineup generation
  </verify>
  <done>
    BattingOrderSection renders on LineupPage below the fielding grid. Coach can generate batting order, see numbered list with band indicators, confirm to save to history, and clear. Confirmed orders persist in localStorage for cross-game fairness. Batting order is fully independent of fielding lineup (BATT-02). All three BATT requirements satisfied.
  </done>
</task>

</tasks>

<verification>
Phase 3 success criteria (from ROADMAP.md):
1. User can generate a continuous batting order including all rostered players -- Generate button produces numbered list of all present players
2. Batting order is independent of fielding assignments -- BattingOrderSection has no dependency on useLineup or fielding state
3. Batting order generation considers history so kids rotate through lineup positions -- generateBattingOrder uses three-band rotation with calculateBandCounts from battingHistory localStorage

Additional checks:
- `npx vitest run` -- all tests pass (batting-order + existing)
- `npx tsc --noEmit` -- no type errors
- Dev server renders batting order section on Lineup page
- Confirm saves to battingHistory in localStorage
- Second game generation uses history for fairness rotation
</verification>

<success_criteria>
- Batting order types (BattingBand, BattingHistoryEntry, BattingOrderState) defined in types/index.ts
- generateBattingOrder pure function tested and working with three-band fairness
- useBattingOrder hook persists state via useLocalStorage
- BattingOrderList shows numbered players with band badges
- BattingOrderSection provides generate/confirm/clear workflow
- LineupPage includes BattingOrderSection below fielding content
- All vitest tests pass, TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-batting-order/03-02-SUMMARY.md`
</output>
