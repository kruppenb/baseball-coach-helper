---
phase: 07-sync-engine
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/hooks/useRoster.ts
  - src/hooks/useGameConfig.ts
  - src/hooks/useLineup.ts
  - src/hooks/useGameHistory.ts
  - src/hooks/useBattingOrder.ts
  - src/App.tsx
  - src/components/app-shell/AppHeader.tsx
  - src/components/app-shell/AppHeader.module.css
  - src/components/app-shell/SyncStatusIndicator.tsx
  - src/components/app-shell/SyncStatusIndicator.module.css
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Coach sees a sync status indicator in the header when signed in (synced/syncing/offline/error)"
    - "Sync status indicator is hidden for unauthenticated users"
    - "All 5 domain hooks use useCloudStorage instead of useLocalStorage for cloud-synced keys"
    - "SyncProvider wraps the app inside AuthProvider"
    - "App remains fully functional without signing in (all v1.0 functionality intact)"
    - "Existing tests continue to pass after hook migration"
  artifacts:
    - path: "src/components/app-shell/SyncStatusIndicator.tsx"
      provides: "Visual sync status badge component"
      exports: ["SyncStatusIndicator"]
    - path: "src/components/app-shell/SyncStatusIndicator.module.css"
      provides: "Styles for sync status states"
      contains: "synced"
    - path: "src/App.tsx"
      provides: "SyncProvider wrapping the app"
      contains: "SyncProvider"
    - path: "src/hooks/useRoster.ts"
      provides: "Cloud-synced roster hook"
      contains: "useCloudStorage"
    - path: "src/hooks/useGameConfig.ts"
      provides: "Cloud-synced game config hook"
      contains: "useCloudStorage"
    - path: "src/hooks/useLineup.ts"
      provides: "Cloud-synced lineup state hook"
      contains: "useCloudStorage"
    - path: "src/hooks/useGameHistory.ts"
      provides: "Cloud-synced game history hook"
      contains: "useCloudStorage"
    - path: "src/hooks/useBattingOrder.ts"
      provides: "Cloud-synced batting order hook"
      contains: "useCloudStorage"
  key_links:
    - from: "src/hooks/useRoster.ts"
      to: "src/sync/useCloudStorage.ts"
      via: "import replacement"
      pattern: "useCloudStorage.*roster.*singleton"
    - from: "src/hooks/useBattingOrder.ts"
      to: "src/sync/useCloudStorage.ts"
      via: "import replacement with batting-specific config"
      pattern: "useCloudStorage.*batting"
    - from: "src/components/app-shell/AppHeader.tsx"
      to: "src/sync/SyncContext.tsx"
      via: "useSyncContext for status display"
      pattern: "useSyncContext"
    - from: "src/App.tsx"
      to: "src/sync/SyncContext.tsx"
      via: "SyncProvider wrapping children"
      pattern: "SyncProvider"
---

<objective>
Integrate the sync engine into the app: migrate all 5 domain hooks from useLocalStorage to useCloudStorage, add the SyncProvider to the component tree, and build the sync status indicator in the header.

Purpose: This plan connects the sync infrastructure from Plan 01 to the actual app, completing the offline-first cloud sync feature that coaches will see and use.
Output: All domain hooks cloud-enabled, sync status visible in header, SyncProvider wired into App.tsx.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-sync-engine/07-RESEARCH.md
@.planning/phases/07-sync-engine/07-01-SUMMARY.md

@src/hooks/useRoster.ts
@src/hooks/useGameConfig.ts
@src/hooks/useLineup.ts
@src/hooks/useGameHistory.ts
@src/hooks/useBattingOrder.ts
@src/App.tsx
@src/components/app-shell/AppHeader.tsx
@src/components/app-shell/AppHeader.module.css
@src/sync/useCloudStorage.ts
@src/sync/SyncContext.tsx
@src/sync/sync-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate domain hooks to useCloudStorage and wire SyncProvider</name>
  <files>
    src/hooks/useRoster.ts
    src/hooks/useGameConfig.ts
    src/hooks/useLineup.ts
    src/hooks/useGameHistory.ts
    src/hooks/useBattingOrder.ts
    src/App.tsx
  </files>
  <action>
**App.tsx -- Add SyncProvider:**
- Import `SyncProvider` from `./sync/SyncContext`
- Wrap contents inside AuthProvider with SyncProvider: `<AuthProvider><SyncProvider><AppShell /></SyncProvider></AuthProvider>`
- SyncProvider must be INSIDE AuthProvider because useCloudStorage calls useAuth which requires AuthContext

**useRoster.ts:**
- Change import from `useLocalStorage` to `useCloudStorage` from `'../sync/useCloudStorage'`
- Change the call from `useLocalStorage<Player[]>('roster', [])` to `useCloudStorage<Player[]>('roster', [], { endpoint: '/api/roster', mode: 'singleton' })`
- Everything else in the hook stays exactly the same

**useGameConfig.ts:**
- Change import to useCloudStorage
- Change call to `useCloudStorage<GameConfig>('gameConfig', { innings: 6 }, { endpoint: '/api/game-config', mode: 'singleton' })`

**useLineup.ts:**
- Change import to useCloudStorage
- Change call to `useCloudStorage<LineupState>('lineupState', defaultState, { endpoint: '/api/lineup-state', mode: 'singleton' })`

**useGameHistory.ts:**
- Change import to useCloudStorage
- Change call to `useCloudStorage<GameHistoryEntry[]>('gameHistory', [], { endpoint: '/api/game-history', mode: 'collection' })`

**useBattingOrder.ts -- TWO useCloudStorage calls with batting-specific config:**
- Change import to useCloudStorage
- First call (state): `useCloudStorage<BattingOrderState>('battingOrderState', defaultState, { endpoint: '/api/batting', mode: 'singleton', responseKey: 'battingOrderState', pushDocType: 'battingOrderState' })`
- Second call (history): `useCloudStorage<BattingHistoryEntry[]>('battingHistory', [], { endpoint: '/api/batting', mode: 'collection', responseKey: 'battingHistory', pushDocType: 'battingHistory' })`
- The `responseKey` tells pullFromCloud to extract `response.battingOrderState` or `response.battingHistory` from the batting endpoint's non-standard GET response shape (instead of the usual `response.data`)
- The `pushDocType` tells pushToCloud to include `{ docType: 'battingOrderState' }` or `{ docType: 'battingHistory' }` in the PUT body

IMPORTANT: Only change the import and the useLocalStorage call to useCloudStorage. Do NOT modify any other logic in any hook. The point is a drop-in replacement.
  </action>
  <verify>
Run `npx tsc --noEmit` -- project compiles. Run `npm test` -- all existing tests pass (tests use the hooks which now go through useCloudStorage, but since tests don't have AuthProvider/SyncProvider, verify tests still work -- if they break because of missing context, the test setup may need a minimal mock or the tests may need to be wrapped. If tests fail, check if they need SyncProvider wrapping or if useCloudStorage correctly falls back without context).

NOTE on test compatibility: useCloudStorage calls useSyncContext() which uses useContext. Outside a SyncProvider, useContext returns the default value `{ reportStatus: () => {}, registerConfig: () => {} }` which are no-ops. useAuth outside AuthProvider returns `{ user: null, isLoading: true }`. With user=null, useCloudStorage returns the pure localStorage passthrough. So existing tests that don't wrap in providers should still work -- the hooks degrade to pure localStorage behavior. Verify this.
  </verify>
  <done>
All 5 domain hooks import useCloudStorage instead of useLocalStorage. SyncProvider wraps AppShell inside AuthProvider in App.tsx. `npm test` passes. `npx tsc --noEmit` passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build SyncStatusIndicator and integrate into AppHeader</name>
  <files>
    src/components/app-shell/SyncStatusIndicator.tsx
    src/components/app-shell/SyncStatusIndicator.module.css
    src/components/app-shell/AppHeader.tsx
    src/components/app-shell/AppHeader.module.css
  </files>
  <action>
**SyncStatusIndicator.tsx:**
- Import useSyncContext from '../../sync/SyncContext'
- Import useAuth from '../../auth/useAuth'
- Import styles from './SyncStatusIndicator.module.css'

- Export `function SyncStatusIndicator()`:
  - Call `useSyncContext()` to get `status`
  - Call `useAuth()` to get `{ user }`
  - If `!user`, return `null` (no indicator for unauthenticated users)
  - Render a small inline element showing status:
    - `synced`: A green dot (CSS circle via `::before` pseudo-element) + text "Synced"
    - `syncing`: A dot with CSS animation (pulse/spin) + text "Syncing..."
    - `offline`: A gray dot + text "Offline"
    - `error`: A red dot + text "Sync error"
  - Structure: `<span className={styles.indicator} data-status={status}><span className={styles.dot} /><span className={styles.label}>{labelText}</span></span>`
  - Use `data-status` attribute for CSS styling (cleaner than conditional className merging)

**SyncStatusIndicator.module.css:**
```css
.indicator {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: var(--font-size-xs, 0.75rem);
  color: var(--color-text-muted);
}

.dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.indicator[data-status="synced"] .dot {
  background-color: #22c55e;
}

.indicator[data-status="syncing"] .dot {
  background-color: #3b82f6;
  animation: pulse 1.5s ease-in-out infinite;
}

.indicator[data-status="offline"] .dot {
  background-color: #9ca3af;
}

.indicator[data-status="error"] .dot {
  background-color: #ef4444;
}

.label {
  white-space: nowrap;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

@media print {
  .indicator {
    display: none;
  }
}
```

**AppHeader.tsx:**
- Import SyncStatusIndicator from './SyncStatusIndicator'
- Add `<SyncStatusIndicator />` inside the authSection div, BEFORE the user name/auth links. Position it as the first child of authSection so it appears to the left of auth controls.
- The component self-hides when user is null, so no conditional rendering needed in AppHeader.

**AppHeader.module.css:**
- No changes needed -- the existing `.authSection` flex layout with gap already handles the new child element naturally.
  </action>
  <verify>
Run `npx tsc --noEmit` -- project compiles. Run `npm test` -- all tests pass. Visually inspect by running `npm run dev` and checking:
1. Without signing in: no sync indicator visible
2. The header layout is not broken by the new element
  </verify>
  <done>
SyncStatusIndicator renders a colored dot + label showing synced/syncing/offline/error state. It appears in the AppHeader for signed-in users only. Hidden during print. All tests pass and project compiles.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with all modified and new files
- `npm test` passes -- all existing tests work (hooks fall back to localStorage-only behavior in test environment)
- All 5 domain hooks use useCloudStorage
- SyncProvider wraps the app inside AuthProvider
- SyncStatusIndicator visible in header (authenticated state only)
- No new npm dependencies added
</verification>

<success_criteria>
Domain hooks are cloud-enabled. Signed-in coaches see a sync status indicator. Unsigned-in coaches see no change from v1.0 behavior. All existing tests pass without modification.
</success_criteria>

<output>
After completion, create `.planning/phases/07-sync-engine/07-02-SUMMARY.md`
</output>
