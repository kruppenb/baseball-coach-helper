---
phase: 13.1-offline-to-online-data-preservation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/sync/sync-engine.ts
  - src/sync/useCloudStorage.ts
autonomous: true

must_haves:
  truths:
    - "Local changes made while logged out are NOT silently overwritten when logging back in"
    - "ConflictDialog appears when local offline edits differ from cloud data on first pull after login"
    - "If local data matches cloud data (no offline edits), pull proceeds normally with no dialog"
    - "Collection-mode keys (gameHistory, battingHistory) are unaffected -- no spurious conflict dialogs"
    - "Coach can choose 'Keep This Device' or 'Keep Cloud' to resolve the pull-time conflict"
  artifacts:
    - path: "src/sync/sync-engine.ts"
      provides: "pullFromCloud with onConflict param and local-vs-cloud comparison"
      contains: "onConflict.*ConflictInfo"
    - path: "src/sync/useCloudStorage.ts"
      provides: "Pull effect passes onConflict callback to pullFromCloud"
      contains: "pullFromCloud.*onConflict"
  key_links:
    - from: "src/sync/useCloudStorage.ts"
      to: "src/sync/sync-engine.ts"
      via: "onConflict callback passed from SyncContext through useCloudStorage to pullFromCloud"
      pattern: "pullFromCloud.*onConflict"
    - from: "src/sync/sync-engine.ts"
      to: "src/sync/SyncContext.tsx"
      via: "onConflict callback triggers setActiveConflict which shows ConflictDialog"
      pattern: "onConflict\\("
---

<objective>
Add pull-time conflict detection to `pullFromCloud` so that local changes made while logged out are preserved via the existing ConflictDialog instead of being silently overwritten on login.

Purpose: Fixes a data loss bug discovered during Phase 13 UAT where the coach's offline roster/lineup edits are destroyed by the first cloud pull after SWA auth redirect (full page reload wipes in-memory dirty flags).

Output: Modified `sync-engine.ts` with conflict-aware `pullFromCloud`, modified `useCloudStorage.ts` passing `onConflict` to pull effect.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13.1-offline-to-online-data-preservation/13.1-RESEARCH.md
@src/sync/sync-engine.ts
@src/sync/useCloudStorage.ts
@src/sync/SyncContext.tsx
@src/sync/sync-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add onConflict parameter and local-vs-cloud comparison to pullFromCloud</name>
  <files>src/sync/sync-engine.ts</files>
  <action>
Modify the `pullFromCloud` function signature to accept an optional fourth parameter:

```typescript
export async function pullFromCloud(
  key: string,
  config: SyncKeyConfig,
  onStatus: (status: SyncStatus) => void,
  onConflict?: (info: ConflictInfo) => void,
): Promise<void> {
```

Inside the `config.mode === 'singleton'` branch, AFTER the existing empty-object check but BEFORE writing to localStorage, add the pull-time conflict detection block:

```typescript
// Pull-time conflict check: detect local offline edits vs. cloud data
if (onConflict && hasNonDefaultData(key)) {
  const localRaw = localStorage.getItem(key);
  if (localRaw !== null) {
    try {
      const localData = JSON.parse(localRaw);
      if (JSON.stringify(localData) !== JSON.stringify(data)) {
        onConflict({
          key,
          localData,
          cloudData: data,
          cloudEtag: typeof json._etag === 'string' ? json._etag : null,
          cloudUpdatedAt: typeof json.updatedAt === 'string' ? json.updatedAt : null,
        });
        pulledKeys.add(key);
        onStatus('error');
        return;
      }
    } catch {
      // JSON parse failure on local data -- safe to overwrite
    }
  }
}
```

Key implementation details:
- Only applies to `singleton` mode (roster, gameConfig, lineupState, battingOrderState). Collection mode is untouched.
- Uses existing `hasNonDefaultData(key)` to skip conflict check when local data is just defaults.
- Uses `JSON.stringify` comparison (already established pattern in codebase, see `useLineupEditor`).
- Adds key to `pulledKeys` after triggering conflict to prevent duplicate conflict dialogs on re-render.
- Sets status to `'error'` so the sync badge shows the issue.
- The `cloudEtag` reference should use the already-extracted variable if available. Note: the current code extracts `json._etag` on line 231. The conflict block should use that same extraction. Read the existing code structure carefully -- if there's already a `const cloudEtag = ...` variable in scope before the conflict check insertion point, use it. Otherwise extract it as shown above.
- `cloudUpdatedAt` may not be in the GET response. Use optional chaining and fall back to `null`.
- Do NOT move the existing ETag extraction (`etagStore.set`) -- only add the conflict check block between the empty-object guard and the localStorage write.
  </action>
  <verify>
Run `npx tsc --noEmit` from the repo root -- no type errors. Confirm the `pullFromCloud` function signature includes the optional `onConflict` parameter. Confirm the conflict check block exists inside the singleton branch between the empty-object guard and the `localStorage.setItem` call.
  </verify>
  <done>
`pullFromCloud` accepts an optional `onConflict` callback. When cloud data differs from non-default local data in singleton mode, it invokes `onConflict` with a `ConflictInfo` object and returns early without overwriting localStorage. When data matches or local data is default, pull proceeds normally.
  </done>
</task>

<task type="auto">
  <name>Task 2: Pass onConflict callback to pullFromCloud in useCloudStorage pull effect</name>
  <files>src/sync/useCloudStorage.ts</files>
  <action>
Modify the pull-on-mount `useEffect` in `useCloudStorage` to pass `onConflict` (already destructured from `useSyncContext()` on line 25) as the fourth argument to `pullFromCloud`:

Change from:
```typescript
useEffect(() => {
  if (!user) return;
  pullFromCloud(key, apiConfigRef.current, (status) =>
    reportStatus(key, status)
  );
}, [key, user, reportStatus]);
```

To:
```typescript
useEffect(() => {
  if (!user) return;
  pullFromCloud(
    key,
    apiConfigRef.current,
    (status) => reportStatus(key, status),
    onConflict,
  );
}, [key, user, reportStatus, onConflict]);
```

Key implementation details:
- `onConflict` is already destructured from `useSyncContext()` on line 25. No new imports needed.
- Add `onConflict` to the dependency array since it's now used inside the effect.
- `onConflict` is the `handleConflict` callback from `SyncContext` which calls `setActiveConflict`, which shows the `ConflictDialog`. This is the exact same callback used by `debouncedPush` for 412 conflicts.
- The resolution path is identical to push-time conflicts: SyncContext's `resolveConflict` handles both "Keep Cloud" (writes cloud data to localStorage + updates ETag) and "Keep This Device" (updates ETag to cloud's current value then re-pushes local data).
  </action>
  <verify>
Run `npx tsc --noEmit` from the repo root -- no type errors. Verify the pull effect calls `pullFromCloud` with 4 arguments and `onConflict` is in the dependency array. Run `npm run build` to confirm the production build succeeds.
  </verify>
  <done>
`useCloudStorage` passes `onConflict` from SyncContext to `pullFromCloud`, enabling pull-time conflict detection. The existing ConflictDialog and resolution logic handle both push-time (412) and pull-time (data mismatch) conflicts through the same code path.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` produces a successful production build
3. Manual scenario verification (for UAT):
   a. Log out of the app
   b. Edit the roster (add/remove a player) while logged out
   c. Log back in via Entra ID
   d. ConflictDialog should appear showing "This Device" vs "Cloud" options
   e. Choosing "Keep This Device" should preserve the offline edits and push them to cloud
   f. Choosing "Keep Cloud" should overwrite local data with cloud version
   g. If no changes were made while logged out, login should proceed normally with no dialog
</verification>

<success_criteria>
- pullFromCloud detects when local singleton data differs from cloud data and triggers ConflictDialog
- No conflict dialog appears when local data matches cloud data or is default
- Collection-mode keys are completely unaffected
- TypeScript compiles cleanly
- Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/13.1-offline-to-online-data-preservation/13.1-01-SUMMARY.md`
</output>
