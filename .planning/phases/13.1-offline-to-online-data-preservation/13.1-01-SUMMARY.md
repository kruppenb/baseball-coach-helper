---
phase: 13.1-offline-to-online-data-preservation
plan: 01
subsystem: sync
tags: [conflict-detection, localStorage, cloud-sync, offline-edits]

# Dependency graph
requires:
  - phase: 13-sync-hardening
    provides: "ETag-based push-time conflict detection and ConflictDialog UI"
provides:
  - "Pull-time conflict detection in pullFromCloud for singleton keys"
  - "ConflictDialog shown when local offline edits differ from cloud data on login"
affects: []

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Pull-time conflict detection via JSON.stringify comparison of local vs cloud data"
    - "onConflict callback threaded from SyncContext through useCloudStorage to pullFromCloud"

key-files:
  created: []
  modified:
    - src/sync/sync-engine.ts
    - src/sync/useCloudStorage.ts

key-decisions:
  - "JSON.stringify comparison for pull-time conflict detection (matches existing codebase pattern in useLineupEditor)"
  - "Conflict check only for singleton mode -- collection-mode keys (gameHistory, battingHistory) unaffected"
  - "pulledKeys.add on conflict to prevent duplicate conflict dialogs on re-render"

patterns-established:
  - "Pull-time conflicts use same ConflictDialog and resolution path as push-time 412 conflicts"

# Metrics
duration: 1min
completed: 2026-02-15
---

# Phase 13.1 Plan 01: Offline-to-Online Data Preservation Summary

**Pull-time conflict detection in pullFromCloud using JSON comparison with ConflictDialog callback for offline-edited singleton keys**

## Performance

- **Duration:** 1 min
- **Started:** 2026-02-16T06:37:45Z
- **Completed:** 2026-02-16T06:39:20Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- pullFromCloud now detects when local singleton data differs from cloud data after login
- ConflictDialog appears for offline edits, giving coach "Keep This Device" or "Keep Cloud" choice
- Collection-mode keys (gameHistory, battingHistory) are completely unaffected -- no spurious dialogs
- Resolution uses existing ConflictDialog and SyncContext.resolveConflict -- zero new UI code

## Task Commits

Each task was committed atomically:

1. **Task 1: Add onConflict parameter and local-vs-cloud comparison to pullFromCloud** - `725b906` (feat)
2. **Task 2: Pass onConflict callback to pullFromCloud in useCloudStorage pull effect** - `7b526f2` (feat)

## Files Created/Modified
- `src/sync/sync-engine.ts` - Added optional onConflict param to pullFromCloud; conflict detection block in singleton branch between empty-object guard and localStorage write
- `src/sync/useCloudStorage.ts` - Passes onConflict from SyncContext as 4th arg to pullFromCloud in pull-on-mount effect

## Decisions Made
- Used JSON.stringify comparison for local-vs-cloud diff (consistent with existing hasEdits pattern in useLineupEditor)
- Conflict check gated behind hasNonDefaultData(key) to avoid false positives on default/empty localStorage
- Added key to pulledKeys on conflict to prevent duplicate dialogs on React re-render cycles
- Set status to 'error' on conflict so SyncBadge reflects the unresolved state

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Pull-time conflict detection complete and production-build verified
- Ready for UAT: log out, edit roster offline, log back in, verify ConflictDialog appears
- No further phases planned after 13.1

## Self-Check: PASSED

All files verified present. All commit hashes confirmed in git log.

---
*Phase: 13.1-offline-to-online-data-preservation*
*Completed: 2026-02-15*
