---
phase: 05-auth-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - staticwebapp.config.json
  - src/auth/types.ts
  - src/auth/AuthContext.tsx
  - src/auth/useAuth.ts
  - vite.config.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "AuthContext fetches /.auth/me on mount and provides user state (null when not signed in, ClientPrincipal when signed in)"
    - "SWA config declares custom Entra ID provider with tenant-specific openIdIssuer"
    - "SWA config blocks GitHub provider and protects only /api/* routes (NOT all routes)"
    - "Vite dev server proxies /.auth and /api requests to SWA CLI ports"
  artifacts:
    - path: "staticwebapp.config.json"
      provides: "SWA route config, custom Entra ID auth provider, navigation fallback, response overrides"
      contains: "azureActiveDirectory"
    - path: "src/auth/types.ts"
      provides: "ClientPrincipal interface and AuthState type"
      exports: ["ClientPrincipal", "AuthState"]
    - path: "src/auth/AuthContext.tsx"
      provides: "AuthProvider component and AuthContext"
      exports: ["AuthProvider", "AuthContext"]
    - path: "src/auth/useAuth.ts"
      provides: "useAuth convenience hook"
      exports: ["useAuth"]
    - path: "vite.config.ts"
      provides: "Proxy config for /.auth and /api to SWA CLI"
      contains: "proxy"
  key_links:
    - from: "src/auth/AuthContext.tsx"
      to: "/.auth/me"
      via: "fetch in useEffect on mount"
      pattern: "fetch.*\\.auth/me"
    - from: "src/auth/AuthContext.tsx"
      to: "src/auth/types.ts"
      via: "imports ClientPrincipal type"
      pattern: "import.*ClientPrincipal.*types"
    - from: "src/auth/useAuth.ts"
      to: "src/auth/AuthContext.tsx"
      via: "useContext(AuthContext)"
      pattern: "useContext.*AuthContext"
---

<objective>
Create the auth infrastructure for SWA EasyAuth: platform config, React auth context, and dev tooling.

Purpose: Establish all auth plumbing so Plan 02 can wire it into the UI. After this plan, the app has an AuthProvider that knows if a user is signed in, SWA config that defines the Entra ID auth flow, and Vite proxies auth requests to SWA CLI during development.

Output: staticwebapp.config.json, src/auth/ module (types, context, hook), updated vite.config.ts and package.json.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-auth-layer/05-RESEARCH.md
@src/components/app-shell/AppShell.tsx
@vite.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SWA config and auth types</name>
  <files>staticwebapp.config.json, src/auth/types.ts</files>
  <action>
Create `staticwebapp.config.json` in the project root with:
- Custom Entra ID provider registration under `auth.identityProviders.azureActiveDirectory` with `openIdIssuer` pointing to `https://login.microsoftonline.com/<TENANT_ID>/v2.0`, `clientIdSettingName: "AZURE_CLIENT_ID"`, `clientSecretSettingName: "AZURE_CLIENT_SECRET"`. Leave `<TENANT_ID>` as a placeholder -- the user will replace it at deployment time.
- Routes: block GitHub provider with `{ "route": "/.auth/login/github", "statusCode": 404 }`. Protect API routes with `{ "route": "/api/*", "allowedRoles": ["authenticated"] }`. Do NOT protect any other routes (AUTH-04: app must work without signing in).
- Navigation fallback: `{ "rewrite": "/index.html", "exclude": ["/assets/*"] }` for SPA client-side routing.
- Response overrides: 401 redirects to `/.auth/login/aad?post_login_redirect_uri=.referrer` (302). 403 rewrites to `/index.html` so the React app can handle access-denied display.
- Platform: `{ "apiRuntime": "node:20" }`.

Create `src/auth/types.ts` with:
- `ClientPrincipal` interface matching SWA's `/.auth/me` response shape: `identityProvider: string`, `userId: string`, `userDetails: string`, `userRoles: string[]`, `claims: Array<{ typ: string; val: string }>`.
- `AuthState` interface: `user: ClientPrincipal | null`, `isLoading: boolean`.
- Export a `getDisplayName(user: ClientPrincipal): string` function that extracts display name from `claims.find(c => c.typ === 'name')?.val` with fallback to `userDetails`, then fallback to `'Coach'`. This avoids the pitfall of showing email instead of name (Entra ID v2.0 puts email in userDetails, not the name).
  </action>
  <verify>
- `staticwebapp.config.json` is valid JSON: `npx json5 staticwebapp.config.json` or manually check
- TypeScript compiles: `npx tsc --noEmit src/auth/types.ts`
- No route rule forces auth on all pages (grep for `"route": "/*"` should return nothing)
  </verify>
  <done>
- staticwebapp.config.json exists at project root with custom Entra ID provider, GitHub blocked, /api/* protected, navigation fallback, response overrides
- src/auth/types.ts exports ClientPrincipal, AuthState, getDisplayName
- getDisplayName extracts name from claims array, falls back to userDetails, then 'Coach'
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AuthContext and useAuth hook</name>
  <files>src/auth/AuthContext.tsx, src/auth/useAuth.ts</files>
  <action>
Create `src/auth/AuthContext.tsx`:
- Import `ClientPrincipal` and `AuthState` from `./types`.
- Create `AuthContext` using `createContext<AuthState>({ user: null, isLoading: true })`.
- Create `AuthProvider` component that:
  - Initializes state as `{ user: null, isLoading: true }`.
  - In a `useEffect` (empty deps), fetches `/.auth/me`, parses JSON, extracts `data.clientPrincipal` (which is `null` when not signed in). Sets state to `{ user: clientPrincipal, isLoading: false }`.
  - On fetch error (network failure, 404 during local dev without SWA CLI), catches and sets `{ user: null, isLoading: false }`. This is critical for AUTH-04: the app must not break when auth endpoints are unavailable.
  - Renders `<AuthContext.Provider value={state}>{children}</AuthContext.Provider>`.
- Export both `AuthContext` and `AuthProvider`.

Create `src/auth/useAuth.ts`:
- Import `useContext` from React and `AuthContext` from `./AuthContext`.
- Export `useAuth()` function that returns `useContext(AuthContext)`.
- This is a convenience wrapper so consumers import `useAuth` instead of the raw context.
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit src/auth/AuthContext.tsx src/auth/useAuth.ts`
- AuthProvider is a valid React component (exports function that returns JSX)
- useAuth returns AuthState type (user + isLoading)
  </verify>
  <done>
- AuthContext.tsx exports AuthProvider that fetches /.auth/me on mount
- AuthProvider gracefully handles fetch errors (sets user: null, isLoading: false)
- useAuth.ts exports useAuth hook returning { user, isLoading }
  </done>
</task>

<task type="auto">
  <name>Task 3: Configure Vite proxy and SWA CLI dev script</name>
  <files>vite.config.ts, package.json</files>
  <action>
Update `vite.config.ts` to add proxy configuration under `server`:
- Proxy `/.auth` to `http://127.0.0.1:4280` with `changeOrigin: true`. This routes auth requests to SWA CLI during local development.
- Proxy `/api` to `http://127.0.0.1:7071` with `changeOrigin: true`. This routes API requests to Azure Functions emulator (needed in Phase 6, but set up now to avoid revisiting vite config).
- Keep existing `port: 5180` setting.

Update `package.json`:
- Add `"dev:swa": "swa start http://localhost:5180 --run \"npm run dev\""` to scripts. This starts SWA CLI wrapping Vite for auth-aware local development.
- Install SWA CLI as dev dependency: run `npm install -D @azure/static-web-apps-cli`.

Note: Regular `npm run dev` (Vite only) still works for non-auth development. The AuthProvider handles the 404 from /.auth/me gracefully by setting user to null.
  </action>
  <verify>
- `npm run build` succeeds (vite config is valid)
- `npm run dev` starts without errors (Vite accepts the proxy config even if SWA CLI isn't running)
- `@azure/static-web-apps-cli` appears in devDependencies in package.json
- `dev:swa` script exists in package.json
  </verify>
  <done>
- vite.config.ts has proxy entries for /.auth (port 4280) and /api (port 7071)
- package.json has dev:swa script for SWA CLI + Vite combo
- @azure/static-web-apps-cli installed as devDependency
- Existing npm run dev still works for non-auth development
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes -- no TypeScript errors in new auth module
2. `staticwebapp.config.json` is valid JSON with all required sections
3. No route rule forces authentication on all pages (AUTH-04 preserved)
4. All new files exist: staticwebapp.config.json, src/auth/types.ts, src/auth/AuthContext.tsx, src/auth/useAuth.ts
5. vite.config.ts has /.auth and /api proxy entries
</verification>

<success_criteria>
- Auth infrastructure is complete and compiles without errors
- SWA config correctly configures custom Entra ID, blocks GitHub, protects only /api/*
- AuthProvider fetches /.auth/me and gracefully handles both success and failure
- Dev tooling (Vite proxy + SWA CLI script) is ready for auth-aware local development
- Existing app functionality is unaffected (no imports changed in existing files)
</success_criteria>

<output>
After completion, create `.planning/phases/05-auth-layer/05-01-SUMMARY.md`
</output>
