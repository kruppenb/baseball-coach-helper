---
phase: 05-auth-layer
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/App.tsx
  - src/components/app-shell/AppShell.tsx
  - src/components/app-shell/AppShell.module.css
  - src/components/app-shell/AppHeader.tsx
  - src/components/app-shell/AppHeader.module.css
autonomous: false

must_haves:
  truths:
    - "Coach can click 'Sign in with Microsoft' link in the app header and it navigates to /.auth/login/aad (AUTH-01)"
    - "After sign-in, coach sees their display name and a 'Sign out' link in the header (AUTH-03)"
    - "Coach can use the entire app without signing in -- all tabs and features work identically to v1.0 (AUTH-04)"
    - "While auth state is loading, no sign-in button flashes or layout shifts in the header"
  artifacts:
    - path: "src/components/app-shell/AppHeader.tsx"
      provides: "Header component with title, optional sign-in/sign-out, display name"
      exports: ["AppHeader"]
      min_lines: 20
    - path: "src/components/app-shell/AppHeader.module.css"
      provides: "Header styles including auth button area"
    - path: "src/App.tsx"
      provides: "Root component wrapped in AuthProvider"
      contains: "AuthProvider"
    - path: "src/components/app-shell/AppShell.tsx"
      provides: "Shell using AppHeader instead of inline header"
      contains: "AppHeader"
  key_links:
    - from: "src/App.tsx"
      to: "src/auth/AuthContext.tsx"
      via: "wraps AppShell in AuthProvider"
      pattern: "AuthProvider.*AppShell|AppShell.*AuthProvider"
    - from: "src/components/app-shell/AppHeader.tsx"
      to: "src/auth/useAuth.ts"
      via: "calls useAuth() for user state"
      pattern: "useAuth"
    - from: "src/components/app-shell/AppHeader.tsx"
      to: "src/auth/types.ts"
      via: "calls getDisplayName(user)"
      pattern: "getDisplayName"
    - from: "src/components/app-shell/AppHeader.tsx"
      to: "/.auth/login/aad"
      via: "anchor href for sign-in"
      pattern: "\\.auth/login/aad"
    - from: "src/components/app-shell/AppHeader.tsx"
      to: "/.auth/logout"
      via: "anchor href for sign-out"
      pattern: "\\.auth/logout"
---

<objective>
Wire auth state into the app UI: wrap the app in AuthProvider, extract the header into its own component with sign-in/sign-out controls, and verify the complete auth layer works.

Purpose: This completes all four AUTH requirements. The coach sees a "Sign in with Microsoft" link when not authenticated and their name + "Sign out" when authenticated. The app remains fully functional without signing in.

Output: Updated App.tsx with AuthProvider, new AppHeader.tsx with auth UI, updated AppShell.tsx using AppHeader.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-auth-layer/05-RESEARCH.md
@.planning/phases/05-auth-layer/05-01-SUMMARY.md
@src/App.tsx
@src/components/app-shell/AppShell.tsx
@src/components/app-shell/AppShell.module.css
@src/auth/types.ts
@src/auth/AuthContext.tsx
@src/auth/useAuth.ts
@src/styles/tokens.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AppHeader component with auth controls</name>
  <files>src/components/app-shell/AppHeader.tsx, src/components/app-shell/AppHeader.module.css</files>
  <action>
Create `src/components/app-shell/AppHeader.tsx`:
- Import `useAuth` from `../../auth/useAuth` and `getDisplayName` from `../../auth/types`.
- Render a `<header>` containing the app title "Lineup Builder" (h1) and an auth section.
- Auth section behavior:
  - While `isLoading` is true: render nothing in the auth area (no flash of sign-in button).
  - When `user` is null (not signed in): render `<a href="/.auth/login/aad">Sign in with Microsoft</a>`.
  - When `user` exists (signed in): render the display name (from `getDisplayName(user)`) and `<a href="/.auth/logout?post_logout_redirect_uri=/">Sign out</a>`.
- Layout: use flexbox with `justify-content: space-between` so the title is left-aligned and auth controls are right-aligned.
- The sign-in/sign-out are plain `<a>` tags (not buttons), because they navigate to SWA platform endpoints. EasyAuth handles the redirect flow.

Create `src/components/app-shell/AppHeader.module.css`:
- Use the project's existing CSS custom properties from tokens.css (--space-*, --font-size-*, --color-*).
- `.header`: flex row, space-between, align-items center, padding matching existing header (--space-md vertical, --space-lg horizontal).
- `.title`: same styles as existing `.title` in AppShell.module.css (font-size-xl, font-weight 700, margin 0, color-text).
- `.authSection`: flex row, align-items center, gap --space-sm.
- `.userName`: font-size --font-size-sm, color --color-text-muted.
- `.authLink`: font-size --font-size-sm, color --color-primary, text-decoration none, min-height --min-tap-size, display flex, align-items center (touch-friendly tap target).
- `.authLink:hover`: text-decoration underline.
- Hide auth section in print: `@media print { .authSection { display: none; } }`.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- AppHeader renders the title "Lineup Builder"
- Auth link points to /.auth/login/aad (not a custom route)
- Sign out link includes post_logout_redirect_uri=/
  </verify>
  <done>
- AppHeader.tsx renders title + conditional auth section (sign-in link when anonymous, name + sign-out when authenticated)
- Auth section hidden during isLoading (no layout flash)
- Auth section hidden in print (dugout card unaffected)
- Uses project CSS custom properties, touch-friendly tap targets
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate AuthProvider and AppHeader into app</name>
  <files>src/App.tsx, src/components/app-shell/AppShell.tsx, src/components/app-shell/AppShell.module.css</files>
  <action>
Update `src/App.tsx`:
- Import `AuthProvider` from `./auth/AuthContext`.
- Wrap `<AppShell />` in `<AuthProvider>` so all components in the tree can access auth state via useAuth.
- Keep the existing structure simple: `AuthProvider > AppShell`.

Update `src/components/app-shell/AppShell.tsx`:
- Import `AppHeader` from `./AppHeader`.
- Replace the inline `<header>` block (lines 29-31 with the h1) with `<AppHeader />`.
- Remove the now-unused `.header` and `.title` CSS class references.
- Everything else stays the same: TabBar, main content, tab panels. No other changes.

Update `src/components/app-shell/AppShell.module.css`:
- Remove the `.header` and `.title` CSS rules (they move to AppHeader.module.css).
- Keep `.shell` and `.content` rules unchanged.
  </action>
  <verify>
- `npm run build` succeeds with zero errors
- `npm test` passes (all 77 existing tests still pass -- AUTH-04 requires no v1.0 regressions)
- `npm run dev` starts and the app loads at http://localhost:5180 with "Lineup Builder" title visible
- Auth section shows "Sign in with Microsoft" (since /.auth/me returns error/404 without SWA CLI)
  </verify>
  <done>
- App.tsx wraps AppShell in AuthProvider
- AppShell.tsx uses AppHeader component instead of inline header
- AppShell.module.css cleaned up (header/title rules removed)
- All 77 existing tests pass (no v1.0 regression)
- App loads and displays correctly with Vite dev server (without SWA CLI)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify auth UI in browser</name>
  <files>none (visual verification only)</files>
  <action>
Human verifies the complete auth layer works visually in the browser. Claude has already automated all code changes in Tasks 1-2. This checkpoint confirms the UI looks correct and all v1.0 functionality is preserved.
  </action>
  <verify>
1. Run `npm run dev` and open http://localhost:5180
2. Verify the header shows "Lineup Builder" on the left and "Sign in with Microsoft" on the right
3. Verify all four tabs work: Roster, Game Setup, Lineup (with 9+ players), History
4. Click "Sign in with Microsoft" -- it should navigate to /.auth/login/aad (will 404 without SWA CLI, which is expected)
5. Check that the app header looks clean on mobile viewport (375px width) -- title and sign-in link should not overlap
6. Verify print still works: Ctrl+P on lineup page should show only the dugout card (no auth controls visible)

Note: Full sign-in testing requires SWA CLI (`npm run dev:swa`) and Azure Portal configuration. The SWA CLI emulator provides a mock login page for testing the auth flow locally. Real Entra ID integration testing happens after Phase 9 deployment.
  </verify>
  <done>
- Header visually confirms title left-aligned, auth controls right-aligned
- All tabs functional without signing in (AUTH-04)
- Print shows dugout card only, no auth controls
- Mobile viewport renders cleanly without overlap
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds -- no TypeScript errors
2. `npm test` passes -- all 77 existing tests pass (AUTH-04: no v1.0 regression)
3. Header displays "Lineup Builder" title and auth controls
4. Sign-in link navigates to /.auth/login/aad
5. Sign-out link navigates to /.auth/logout?post_logout_redirect_uri=/
6. Auth section is hidden during print (@media print)
7. App works fully without signing in (AUTH-04)
</verification>

<success_criteria>
- AuthProvider wraps the entire app at the root level
- AppHeader shows conditional sign-in/sign-out based on auth state
- All four AUTH requirements are addressed: AUTH-01 (sign-in link), AUTH-02 (SWA config + 403 override), AUTH-03 (display name + sign-out), AUTH-04 (works without signing in)
- All existing tests pass with no modifications
- Visual verification confirms clean header layout
</success_criteria>

<output>
After completion, create `.planning/phases/05-auth-layer/05-02-SUMMARY.md`
</output>
