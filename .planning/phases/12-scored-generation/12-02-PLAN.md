---
phase: 12-scored-generation
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/components/lineup/FairnessScoreCard.tsx
  - src/components/lineup/FairnessScoreCard.module.css
  - src/hooks/useLineup.ts
  - src/components/game-day/steps/ReviewStep.tsx
  - src/components/game-day/steps/ReviewStep.module.css
autonomous: true

must_haves:
  truths:
    - "Clicking generate produces a single recommended lineup (best of ~10) without the coach choosing from a list"
    - "Coach can regenerate to get a fresh best lineup and batting order together"
    - "Fairness score is visible showing lineup quality breakdown (bench equity, infield balance, position variety)"
    - "Batting order is auto-generated as part of the flow without a separate confirmation step"
    - "Score updates live as coach makes DnD edits to the lineup"
  artifacts:
    - path: "src/components/lineup/FairnessScoreCard.tsx"
      provides: "Visual fairness score breakdown with three sub-dimensions and total"
      exports: ["FairnessScoreCard"]
    - path: "src/components/lineup/FairnessScoreCard.module.css"
      provides: "Styles for score card component"
    - path: "src/hooks/useLineup.ts"
      provides: "Updated generate() using generateBestLineup + auto batting order coordination"
  key_links:
    - from: "src/hooks/useLineup.ts"
      to: "src/logic/lineup-generator.ts"
      via: "generate() calls generateBestLineup instead of generateMultipleLineups"
      pattern: "generateBestLineup"
    - from: "src/components/lineup/FairnessScoreCard.tsx"
      to: "src/logic/lineup-scorer.ts"
      via: "accepts LineupScore prop computed via scoreLineup"
      pattern: "LineupScore"
    - from: "src/components/game-day/steps/ReviewStep.tsx"
      to: "src/components/lineup/FairnessScoreCard.tsx"
      via: "renders FairnessScoreCard with live-computed score from useMemo"
      pattern: "FairnessScoreCard"
    - from: "src/components/game-day/steps/ReviewStep.tsx"
      to: "src/hooks/useBattingOrder.ts"
      via: "auto-generates batting order on mount alongside lineup, removes manual button"
      pattern: "generateBattingOrder\\(\\)|generate\\(\\)"
---

<objective>
Wire best-of-N generation into the UI with a FairnessScoreCard, auto batting order, and live score updates on DnD edits.

Purpose: This completes the Phase 12 user-facing experience -- the coach sees one best lineup with a fairness score breakdown, batting order is auto-generated, and the score updates live as they tweak the lineup via drag-and-drop.

Output: FairnessScoreCard component, updated useLineup hook, updated ReviewStep with all four GEN requirements met.
</objective>

<execution_context>
@C:/Users/nicho/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/nicho/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-scored-generation/12-RESEARCH.md
@.planning/phases/12-scored-generation/12-01-SUMMARY.md

@src/hooks/useLineup.ts
@src/hooks/useBattingOrder.ts
@src/hooks/useLineupEditor.ts
@src/components/game-day/steps/ReviewStep.tsx
@src/components/game-day/steps/ReviewStep.module.css
@src/components/lineup/FairnessSummary.tsx
@src/components/lineup/FairnessSummary.module.css
@src/logic/lineup-scorer.ts
@src/logic/lineup-generator.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build FairnessScoreCard component and update useLineup to use best-of-N generation</name>
  <files>
    src/components/lineup/FairnessScoreCard.tsx
    src/components/lineup/FairnessScoreCard.module.css
    src/hooks/useLineup.ts
  </files>
  <action>
**1. Create `src/components/lineup/FairnessScoreCard.tsx`:**

A presentational component displaying the lineup fairness score breakdown.

Props:
```typescript
import type { LineupScore } from '../../logic/lineup-scorer';

interface FairnessScoreCardProps {
  score: LineupScore;
}
```

Renders:
- A card/container with heading "Fairness Score"
- Total score displayed prominently (large number, e.g., "87/100")
- Three sub-dimension rows, each showing:
  - Label: "Bench Equity", "Infield Balance", "Position Variety"
  - Score value (e.g., "92")
  - A simple visual bar (CSS width proportional to score percentage) using a `<div>` with dynamic `style={{ width: \`${score}%\` }}`
- Color coding for total score: green (>= 80), orange/amber (60-79), red (< 60). Use CSS classes `.scoreGood`, `.scoreOk`, `.scoreLow` with `--color-success`, `--color-warning` (use `#d97706` for warning since tokens.css may not have it), `--color-error` design tokens.

Follow the project's CSS Module pattern: `FairnessScoreCard.module.css` with design tokens (`var(--space-*)`, `var(--font-size-*)`, `var(--color-*)`, `var(--radius-*)`).

**2. Create `src/components/lineup/FairnessScoreCard.module.css`:**

Style the card with:
- `.card` — border, border-radius, padding, background
- `.heading` — section title
- `.totalScore` — large font for the total number
- `.dimensions` — container for the three sub-rows
- `.dimension` — flex row: label + score value + bar
- `.dimensionLabel` — text label
- `.dimensionValue` — numeric value
- `.bar` — background container for the visual bar
- `.barFill` — colored fill with dynamic width via inline style
- `.scoreGood`, `.scoreOk`, `.scoreLow` — color variants for total and bars

Use the same design token patterns as FairnessSummary.module.css (var(--space-*), var(--font-size-*), etc.).

**3. Update `src/hooks/useLineup.ts`:**

Change the `generate()` function to use `generateBestLineup()` instead of `generateMultipleLineups()`:

- Replace import: `import { generateBestLineup, preValidate } from '../logic/lineup-generator';` (remove `generateMultipleLineups` import).
- In `generate()`:
  - Call `generateBestLineup(input, 10)` instead of `generateMultipleLineups(input, 1)`.
  - Store result: if `result.valid`, set `generatedLineups: [result.lineup]` and `selectedLineupIndex: 0` (same state shape -- no cloud sync migration needed).
  - Return `{ success: true, count: 1, errors: [] }` on success (same return shape).
  - On failure, return the same error shape as before.

**IMPORTANT:** Do NOT change the `LineupState` type in `types/index.ts`. The `generatedLineups` array still holds `[bestLineup]`, keeping cloud sync stable. The score is computed ephemerally via `useMemo` in the UI (see Task 2), never persisted.

Do NOT remove `selectLineup`, `clearLineups`, or the `selectedLineup` computed value -- they still work and are used by the stepper flow.
  </action>
  <verify>
`npx tsc --noEmit` — no TypeScript errors.
`npx vitest run` — all existing tests still pass (useLineup's generate() is not unit-tested directly, but lineup-generator tests cover generateBestLineup).
  </verify>
  <done>
FairnessScoreCard component renders a score breakdown with total and three sub-dimensions using color-coded bars. useLineup.generate() calls generateBestLineup(input, 10) and stores the best lineup. No LineupState type changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ReviewStep for auto batting order, FairnessScoreCard, and live scoring</name>
  <files>
    src/components/game-day/steps/ReviewStep.tsx
    src/components/game-day/steps/ReviewStep.module.css
  </files>
  <action>
**1. Update `src/components/game-day/steps/ReviewStep.tsx`:**

**Add imports:**
```typescript
import { scoreLineup } from '../../../logic/lineup-scorer';
import { FairnessScoreCard } from '../../lineup/FairnessScoreCard';
```

**Add live score computation via useMemo:**
After the `editor` hook setup, add:
```typescript
const lineupScore = useMemo(() => {
  if (!editor.lineup) return null;
  return scoreLineup(editor.lineup, validationInput);
}, [editor.lineup, validationInput]);
```
This ensures the score updates live when the coach makes DnD edits.

**Change auto-generation on mount to also generate batting order:**
Update the `useEffect` that auto-generates on mount (currently lines 113-122):
```typescript
useEffect(() => {
  if (hasAutoGenerated.current) return;
  if (generatedLineups.length === 0) {
    hasAutoGenerated.current = true;
    const result = generate();
    if (!result.success && result.errors.length > 0) {
      setGenerateError(result.errors[0]);
    } else if (result.success) {
      // Auto-generate batting order alongside lineup (GEN-04)
      generateBattingOrder();
      setHasGeneratedBatting(true);
    }
  }
}, [generatedLineups.length, generate, generateBattingOrder]);
```

NOTE: `generateBattingOrder` is the `generate` from `useBattingOrder()` — it's aliased as `generateBattingOrder` in the destructuring on line 85. This is correct.

**Change handleRegenerate to also regenerate batting order:**
```typescript
const handleRegenerate = () => {
  setGenerateError('');
  const result = generate();
  if (!result.success && result.errors.length > 0) {
    setGenerateError(result.errors[0]);
  } else if (result.success) {
    // Regenerate batting order with new lineup (GEN-04)
    generateBattingOrder();
    setHasGeneratedBatting(true);
  }
};
```

**Remove the manual "Generate Batting Order" button section:**
Remove `handleGenerateBattingOrder` function entirely.
Replace the batting order section's button area:
- Remove the `<div className={styles.actions}>` block that contains the "Generate Batting Order" and "Clear" buttons.
- Keep the `<h3>` heading and the `SortableBattingOrder` component.
- Keep the "Clear" button but move it inline next to the heading or as a small secondary action.

The updated batting order section should look like:
```tsx
<div className={styles.section}>
  <h3 className={styles.sectionTitle}>Batting Order</h3>
  {editor.battingOrder && (
    <SortableBattingOrder
      order={editor.battingOrder}
      players={battingPresentPlayers}
      onReorder={editor.reorderBattingOrder}
    />
  )}
  {!editor.battingOrder && (
    <p className={styles.emptyMessage}>
      Batting order will be generated with the lineup.
    </p>
  )}
</div>
```

**Add FairnessScoreCard to the lineup display section:**
After the `DraggableLineupGrid` and before the `FairnessSummary`, add:
```tsx
{lineupScore && <FairnessScoreCard score={lineupScore} />}
```

Keep the existing `FairnessSummary` below the score card (research recommends keeping both: score card is the headline, per-player table is the detail).

**2. Update `src/components/game-day/steps/ReviewStep.module.css`:**

No major new styles needed beyond what FairnessScoreCard.module.css provides. But clean up:
- Remove `.generateBattingButton` styles (button is removed).
- Remove `.clearBattingButton` styles (button is removed).
- Remove `.actions` styles if no longer used.
- The `.emptyMessage` class already exists in the CSS file.
  </action>
  <verify>
`npx tsc --noEmit` — no TypeScript errors.
`npx vitest run` — all tests pass.
Dev server check: `npm run dev` — app loads, navigate to Game Day, go through attendance + P/C assignment, advance to Review:
  - Lineup auto-generates on mount (best-of-10)
  - Batting order auto-generates on mount (no manual button)
  - FairnessScoreCard visible with total + 3 sub-dimension bars
  - Clicking "Regenerate Lineup" regenerates both lineup and batting order
  - DnD editing the lineup causes score to update live
  - Finalize Game still works, Next advances to Print
  </verify>
  <done>
ReviewStep auto-generates lineup (best-of-10) and batting order on mount. FairnessScoreCard displays total score with three sub-dimension breakdowns. Score updates live on DnD edits. Manual "Generate Batting Order" button removed. Regenerate button regenerates both lineup and batting order together. Finalize flow unchanged.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no TypeScript errors across entire project
2. `npx vitest run` — all tests pass (logic + any component tests)
3. Manual verification of all four GEN requirements:
   - GEN-01: Generate produces best-of-~10 lineup (check that `generateBestLineup` is called with count=10 in useLineup)
   - GEN-02: Regenerate button works and produces a fresh lineup + batting order
   - GEN-03: FairnessScoreCard shows total score + bench equity + infield balance + position variety
   - GEN-04: No manual "Generate Batting Order" button — batting order appears automatically
4. Score updates when dragging players in the lineup grid (useMemo recalculates)
5. FairnessSummary per-player table still visible below the score card
6. Finalize Game saves edited lineup + batting order to history (unchanged flow)
</verification>

<success_criteria>
- Coach sees one auto-generated best lineup with no list to choose from
- FairnessScoreCard shows total score and three sub-dimension breakdowns with visual bars
- Batting order auto-generated without coach clicking a separate button
- Regenerate produces new lineup + new batting order together
- Score updates live as coach makes DnD edits
- No LineupState type changes (cloud sync stable)
- All existing tests pass, no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-scored-generation/12-02-SUMMARY.md`
</output>
